// ğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µ
// ğŸ”µÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ ĞĞĞ¯ ĞšĞĞ Ğ¢Ğ ĞŸĞ ĞĞ•ĞšĞ¢ĞÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ğŸ”µ
// ğŸ”µ------------------------------------------------------------------------ğŸ”µ
// ğŸ”µ ğŸ“¦ ĞœĞĞ”Ğ£Ğ›Ğ˜:Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ğŸ”µ
// ğŸ”µÂ  â”œâ”€â”€ ğŸ¤– bot.js (ĞĞ ĞšĞ•Ğ¡Ğ¢Ğ ĞĞ¢ĞĞ  - Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Telegram Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ğŸ”µ
// ğŸ”µÂ  â”œâ”€â”€ âš™ï¸ config/constants.js (Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ğŸ”µ
// ğŸ”µÂ  â”œâ”€â”€ ğŸ§© modules/handlers/ (Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ğŸ”µ
// ğŸ”µÂ  â”œâ”€â”€ ğŸ”ï¸ modules/core/ (Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ğŸ”µ
// ğŸ”µÂ  â”œâ”€â”€ ğŸ¨ modules/utils/ (Ğ²ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ğŸ”µ
// ğŸ”µÂ  â”œâ”€â”€ ğŸ’¾ modules/storage/ (Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ğŸ”µ
// ğŸ”µÂ  â””â”€â”€ ğŸš€ modules/services/ (Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹)Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ğŸ”µ
// ğŸ”µÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ğŸ”µ
// ğŸ”µ ğŸ¯ Ğ¢Ğ•ĞšĞ£Ğ©Ğ˜Ğ™ Ğ­Ğ¢ĞĞŸ: Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ« â†’ Ğ’Ğ˜Ğ—Ğ£ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ĞœĞĞ”Ğ•Ğ›Ğ•Ğ™ (Ğ­Ğ¢ĞĞŸ 4)Â Â Â Â Â Â  ğŸ”µ
// ğŸ”µ ğŸ”„ ĞŸĞĞ¡Ğ›Ğ•Ğ”ĞĞ•Ğ• ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: 06.11.2025Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ğŸ”µ
// ğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µ

const TelegramBot = require('node-telegram-bot-api');
const axios = require('axios');
const express = require('express');
const { createCanvas, loadImage } = require('canvas');
const fs = require('fs');
const path = require('path');

// =============================================================================
// âš™ï¸ ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯ Ğ˜ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯
// =============================================================================

const app = express();
app.use(express.json());

const TELEGRAM_TOKEN = process.env.TELEGRAM_TOKEN || '8474413305:AAGUROU5GSKKTso_YtlwsguHzibBcpojLVI';
const PORT = process.env.PORT || 10000;
const WEBHOOK_URL = process.env.WEBHOOK_URL || "https://shoe-print-bot.onrender.com/";

console.log('ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ° Ñ Webhook...');
console.log("Webhook URL: " + WEBHOOK_URL);

// =============================================================================
// ğŸš¨ Ğ”Ğ˜ĞĞ“ĞĞĞ¡Ğ¢Ğ˜ĞšĞ CIRCULAR DEPENDENCIES
// =============================================================================

// Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ñ‚Ñ€Ğ°ÑÑĞ¸Ñ€Ğ¾Ğ²ĞºÑƒ Ğ´Ğ»Ñ circular dependencies
process.on('warning', (warning) => {
Â Â Â  if (warning.name === 'Warning' && warning.message.includes('circular dependency')) {
Â Â Â Â Â Â Â  console.log('ğŸš¨ CIRCULAR DEPENDENCY DETECTED:');
Â Â Â Â Â Â Â  console.log('Â Â  Message:', warning.message);
Â Â Â Â Â Â Â  if (warning.stack) {
Â Â Â Â Â Â Â Â Â Â Â  const stackLines = warning.stack.split('\n');
Â Â Â Â Â Â Â Â Â Â Â  console.log('Â Â  Stack trace:');
Â Â Â Â Â Â Â Â Â Â Â  stackLines.slice(0, 5).forEach(line => console.log('Â Â  ', line));
Â Â Â Â Â Â Â  }
Â Â Â  }
});

// =============================================================================
// ğŸ“¦ ĞŸĞĞ”ĞšĞ›Ğ®Ğ§Ğ•ĞĞ˜Ğ• ĞœĞĞ”Ğ£Ğ›Ğ•Ğ™
// =============================================================================

// ğŸ”§ Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ« Ğ˜ ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯
const Helpers = require('./modules/utils/helpers');
const createProjectStructure = require('./utils/structureCreator');

// ğŸ§© ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ˜ ĞšĞĞœĞĞĞ”
const StartHandler = require('./modules/handlers/startHandler');
const StatisticsHandler = require('./modules/handlers/statisticsHandler');
const MenuHandler = require('./modules/handlers/menuHandler');
const PhotoHandler = require('./modules/handlers/photoHandler');
// ğŸ¨ Ğ’Ğ˜Ğ—Ğ£ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯
const VisualizationHandler = require('./modules/handlers/visualizationHandler');

// ğŸ”ï¸ Ğ¯Ğ”Ğ Ğ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ«
 const { SessionManager: NewSessionManager } = require('./modules/sessions/sessionManager');
 const { DataPersistence: NewDataPersistence } = require('./modules/storage/legacy');
//  const { ModelHierarchy } = require('./model_hierarchy');

const HelpHandler = require('./modules/handlers/helpHandler');

// =============================================================================
// ğŸ”„ Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ ĞŸĞĞ’Ğ¢ĞĞ ĞĞ«Ğ¥ ĞŸĞĞŸĞ«Ğ¢ĞĞš
// =============================================================================

const MAX_RETRIES = 3;
const RETRY_DELAY = 2000;

async function withRetry(operation, context = "") {
Â  for (let i = 0; i < MAX_RETRIES; i++) {
Â Â Â  try {
Â Â Â Â Â  return await operation();
Â Â Â  } catch (error) {
Â Â Â Â Â  console.log(`ğŸ”„ ${context} - Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ° ${i+1}/${MAX_RETRIES}: ${error.message}`);
Â Â Â Â Â  if (i === MAX_RETRIES - 1) {
Â Â Â Â Â Â Â  console.log(`âŒ ${context} - Ğ²ÑĞµ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸ Ğ¸ÑÑ‡ĞµÑ€Ğ¿Ğ°Ğ½Ñ‹`);
Â Â Â Â Â Â Â  throw error;
Â Â Â Â Â  }
Â Â Â Â Â  await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
Â Â Â  }
Â  }
}

// =============================================================================
// ğŸš¨ LAZY LOADING Ğ”Ğ›Ğ¯ Ğ˜Ğ—Ğ‘Ğ•Ğ–ĞĞĞ˜Ğ¯ CIRCULAR DEPENDENCIES
// =============================================================================

let _newSessionManager = null;
let _newDataPersistence = null;

function getSessionManager() {
Â Â Â  if (!_newSessionManager) {
Â Â Â Â Â Â Â  console.log('ğŸ”„ Ğ›ĞµĞ½Ğ¸Ğ²Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° SessionManager...');
Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â  const { SessionManager } = require('./modules/sessions/sessionManager');
Â Â Â Â Â Â Â Â Â Â Â  _newSessionManager = new SessionManager(getFootprintAssembler);
Â Â Â Â Â Â Â  } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â  console.log('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ SessionManager:', error.message);
Â Â Â Â Â Â Â Â Â Â Â  // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºÑƒ
Â Â Â Â Â Â Â Â Â Â Â  _newSessionManager = {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  updateUserStats: () => console.log('ğŸ›¡ï¸ (Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°) updateUserStats'),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  getStatistics: () => ({ totalUsers: 0, totalPhotos: 0, totalAnalyses: 0, comparisonsMade: 0, activeUsers: 0, activeSessions: 0, referencePrintsCount: 0 }),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  globalStats: { totalUsers: 0, totalPhotos: 0, totalAnalyses: 0, comparisonsMade: 0, lastAnalysis: null },
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  userStats: new Map(),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  referencePrints: new Map(),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  trailSessions: new Map(),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  getSession: (chatId) => ({ waitingForReference: null, waitingForComparison: null }),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  getTrailSession: (chatId, username) => ({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sessionId: 'stub', expert: username, footprints: [], comparisons: [], status: 'active'
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  })
Â Â Â Â Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â  }
Â Â Â  }
Â Â Â  return _newSessionManager;
}

function getDataPersistence() {
Â Â Â  if (!_newDataPersistence) {
Â Â Â Â Â Â Â  console.log('ğŸ”„ Ğ›ĞµĞ½Ğ¸Ğ²Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° DataPersistence...');
Â Â Â Â Â Â Â  const { DataPersistence } = require('./modules/storage/legacy');
Â Â Â Â Â Â Â  _newDataPersistence = new DataPersistence(getSessionManager(), yandexDisk);
Â Â Â  }
Â Â Â  return _newDataPersistence;
}

// =============================================================================
// ğŸš€ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ¡Ğ•Ğ Ğ’Ğ˜Ğ¡ĞĞ’
// =============================================================================

// Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
createProjectStructure();

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞºĞ°
let yandexDisk = null;
try {
Â Â Â  const YandexDiskService = require('./yandex-disk-service');
Â Â Â  yandexDisk = new YandexDiskService(process.env.YANDEX_DISK_TOKEN);
Â Â Â  console.log('âœ… Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞº service Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½');
} catch (error) {
Â Â Â  console.log('âŒ Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞº service Ğ½Ğµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½:', error.message);
}



// =============================================================================
// ğŸ”§ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ĞĞ¡Ğ¡Ğ•ĞœĞ‘Ğ›Ğ•Ğ Ğ Ğ¡Ğ›Ğ•Ğ”ĞĞ’
// =============================================================================

let footprintAssembler;
try {
Â Â Â  const { FootprintAssembler: FootprintAssemblerClass } = require('./footprint_assembler');
Â Â Â  footprintAssembler = new FootprintAssemblerClass();
Â Â Â  console.log('âœ… FootprintAssembler Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ğ¸Ğ· Ğ¼Ğ¾Ğ´ÑƒĞ»Ñ');
} catch (error) {
Â Â Â  console.log('âŒ FootprintAssembler Ğ½Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½, ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ½Ñ‹Ğ¹:', error.message);
Â Â Â 
Â Â Â  // Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ
Â Â Â  class FootprintAssembler {
Â Â Â Â Â Â Â  constructor() {
Â Â Â Â Â Â Â Â Â Â Â  this.partialPrints = new Map();
Â Â Â Â Â Â Â Â Â Â Â  this.assembledModels = new Map();
Â Â Â Â Â Â Â Â Â Â Â  console.log('âœ… Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ñ‹Ğ¹ FootprintAssembler ÑĞ¾Ğ·Ğ´Ğ°Ğ½');
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  classifyFootprintPattern(predictions, imageWidth, imageHeight) {
Â Â Â Â Â Â Â Â Â Â Â  console.log('ğŸ¯ ĞšĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ÑƒĞ·Ğ¾Ñ€Ğ° Ğ¿Ñ€Ğ¾Ñ‚ĞµĞºÑ‚Ğ¾Ñ€Ğ°...');
Â Â Â Â Â Â Â Â Â Â Â  return 'unknown_pattern';
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  advancedCompatibilityAnalysis(group, newPrint, imageWidth, imageHeight) {
Â Â Â Â Â Â Â Â Â Â Â  console.log('ğŸ¯ ĞĞ½Ğ°Ğ»Ğ¸Ğ· ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸...');
Â Â Â Â Â Â Â Â Â Â Â  return 0.5;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  calculateOverallBoundingBox(predictions) {
Â Â Â Â Â Â Â Â Â Â Â  if (!predictions || predictions.length === 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return { minX: 0, maxX: 0, minY: 0, maxY: 0, width: 0, height: 0 };
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  let minX = Infinity, minY = Infinity, maxX = 0, maxY = 0;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  predictions.forEach(pred => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (pred.points && pred.points.length > 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  pred.points.forEach(point => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  minX = Math.min(minX, point.x);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  minY = Math.min(minY, point.y);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  maxX = Math.max(maxX, point.x);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  maxY = Math.max(maxY, point.y);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  return { minX, minY, maxX, maxY, width: maxX - minX, height: maxY - minY };
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  normalizeFootprintGeometry(predictions, imageWidth, imageHeight) {
Â Â Â Â Â Â Â Â Â Â Â  return predictions;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  advancedPatternComparison(predictionsA, predictionsB) {
Â Â Â Â Â Â Â Â Â Â Â  return 0.5;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  calculateGeometricSimilarity(group, newPrint) {
Â Â Â Â Â Â Â Â Â Â Â  return 0.5;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  assembleFullModel(partialPrints, imageWidth, imageHeight) {
Â Â Â Â Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  success: false,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  error: 'FootprintAssembler Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸'
Â Â Â Â Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â  }
Â Â Â  }
Â Â Â 
Â Â Â  footprintAssembler = new FootprintAssembler();
}

// =============================================================================
// ğŸ›¡ï¸ Ğ—ĞĞ“Ğ›Ğ£Ğ¨ĞšĞ MODEL HIERARCHY
// =============================================================================

class SimpleModelHierarchy {
Â Â Â  constructor(session) {
Â Â Â Â Â Â Â  this.session = session;
Â Â Â Â Â Â Â  console.log('âœ… SimpleModelHierarchy ÑĞ¾Ğ·Ğ´Ğ°Ğ½ (Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°)');
Â Â Â  }
Â Â Â 
Â Â Â  async processHierarchy() {
Â Â Â Â Â Â Â  console.log('ğŸ”ï¸ SimpleModelHierarchy: Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿Ğ¸Ñ€Ğ°Ğ¼Ğ¸Ğ´Ñ‹...');
Â Â Â Â Â Â Â  return [];
Â Â Â  }
Â Â Â 
Â Â Â  getStats() {
Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â Â Â  levels: { raw: 0, final: 0, orphans: 0 },
Â Â Â Â Â Â Â Â Â Â Â  modelsMerged: 0,
Â Â Â Â Â Â Â Â Â Â Â  orphansAdopted: 0,
Â Â Â Â Â Â Â Â Â Â Â  conflictsResolved: 0
Â Â Â Â Â Â Â  };
Â Â Â  }
}

// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
const getModelHierarchy = (session) => {
Â Â Â  return new SimpleModelHierarchy(session);
};

// =============================================================================
// ğŸ”ï¸ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ĞœĞ•ĞĞ•Ğ”Ğ–Ğ•Ğ ĞĞ’
// =============================================================================

console.log('ğŸ›¡ï¸ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹...');

// ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñ‹
let newSessionManager;
let newDataPersistence;

try {
Â Â Â  _newSessionManager = new NewSessionManager(footprintAssembler);
_newDataPersistence = new NewDataPersistence(_newSessionManager, yandexDisk);
Â Â Â  console.log('âœ… ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñ‹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹');
} catch (error) {
Â Â Â  console.log('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ²:', error.message);
Â Â Â  // Ğ—Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ¸ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹
Â Â Â  _newSessionManager = {
Â Â Â  updateUserStats: () => console.log('ğŸ›¡ï¸ (Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°) _newSessionManager.updateUserStats'),
Â Â Â Â Â Â Â  getStatistics: () => ({ totalUsers: 0, totalPhotos: 0, totalAnalyses: 0, comparisonsMade: 0, activeUsers: 0, activeSessions: 0, referencePrintsCount: 0 }),
Â Â Â Â Â Â Â  globalStats: { totalUsers: 0, totalPhotos: 0, totalAnalyses: 0, comparisonsMade: 0, lastAnalysis: null },
Â Â Â Â Â Â Â  userStats: new Map(),
Â Â Â Â Â Â Â  referencePrints: new Map(),
Â Â Â Â Â Â Â  trailSessions: new Map(),
Â Â Â Â Â Â Â  getSession: (chatId) => ({ waitingForReference: null, waitingForComparison: null }),
Â Â Â Â Â Â Â  getTrailSession: (chatId, username) => ({
Â Â Â Â Â Â Â Â Â Â Â  sessionId: 'stub', expert: username, footprints: [], comparisons: [], status: 'active'
Â Â Â Â Â Â Â  })
Â Â Â  };
Â Â Â  newDataPersistence = {
Â Â Â Â Â Â Â  saveAllData: () => console.log('ğŸ›¡ï¸ (Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°) newDataPersistence.saveAllData')
Â Â Â  };
}

// ğŸ¤– Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ¢Ğ•Ğ›Ğ•Ğ“Ğ ĞĞœ Ğ‘ĞĞ¢Ğ (ĞŸĞ•Ğ Ğ•Ğ” photoHandler!)
const bot = new TelegramBot(TELEGRAM_TOKEN, { polling: false });
console.log('âœ… Telegram Bot Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½');

// ğŸ“¸ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ Ğ¤ĞĞ¢Ğ (ĞŸĞĞ¡Ğ›Ğ• bot!)
const photoHandler = new PhotoHandler(bot, getWorkingSessionManager(), getFootprintAssembler, yandexDisk);
bot.on('photo', (msg) => photoHandler.handlePhoto(msg));
const visualizationHandler = new VisualizationHandler(bot, getWorkingSessionManager()); // ğŸ¨ Ğ’Ğ˜Ğ—Ğ£ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯
console.log('âœ… ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ñ„Ğ¾Ñ‚Ğ¾ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½');
// Webhook Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸
app.post('/', (req, res) => {
Â Â Â  console.log("ğŸ“¥ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ webhook Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ");
Â Â Â  bot.processUpdate(req.body);
Â Â Â  res.sendStatus(200);
});

// Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°
app.get('/', (req, res) => {
Â Â Â  res.send(`
Â Â Â Â Â Â Â  <html>
Â Â Â Â Â Â Â Â Â Â Â  <head><title>ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ‚Ğ¾Ñ€ ÑĞ»ĞµĞ´Ğ¾Ğ² Ğ¾Ğ±ÑƒĞ²Ğ¸</title></head>
Â Â Â Â Â Â Â Â Â Â Â  <body style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div style="background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; backdrop-filter: blur(10px);">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <h1 style="text-align: center; margin-bottom: 30px;">ğŸ¤– ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ‚Ğ¾Ñ€ ÑĞ»ĞµĞ´Ğ¾Ğ² Ğ¾Ğ±ÑƒĞ²Ğ¸</h1>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div style="text-align: center; margin-bottom: 30px;">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <p style="font-size: 18px; margin-bottom: 20px;">Ğ‘Ğ¾Ñ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚! Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Telegram:</p>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <a href="https://t.me/Sled_la_bot" style="display: inline-block; background: #0088cc; color: white; padding: 12px 24px; border-radius: 25px; text-decoration: none; font-weight: bold; font-size: 16px;">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ğŸ“² @Sled_la_bot
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </a>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; margin-top: 20px;">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <h3 style="text-align: center; margin-bottom: 15px;">ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹</h3>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div style="font-size: 24px; font-weight: bold;">${getSessionManager().globalStats.totalUsers}</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div>ğŸ‘¥ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div style="font-size: 24px; font-weight: bold;">${getSessionManager().globalStats.totalPhotos}</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <div>ğŸ“¸ Ğ¤Ğ¾Ñ‚Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾</div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â Â Â Â Â  </body>
Â Â Â Â Â Â Â  </html>
Â Â Â  `);
});

// Health check endpoint
app.get('/health', (req, res) => {
Â Â Â  res.json({
Â Â Â Â Â Â Â  status: 'OK',
Â Â Â Â Â Â Â  timestamp: new Date().toISOString(),
Â Â Â Â Â Â Â  statistics: {
    users: getSessionManager().globalStats.totalUsers,
Â Â Â  photos: getSessionManager().globalStats.totalPhotos,
Â Â Â  analyses: getSessionManager().globalStats.totalAnalyses
}
Â Â Â  });
});

const helpHandler = new HelpHandler(bot, getWorkingSessionManager());

// =============================================================================
// ğŸ›¡ï¸ Ğ“ĞĞ ĞĞĞ¢Ğ˜Ğ ĞĞ’ĞĞĞĞ«Ğ™ Ğ”ĞĞ¡Ğ¢Ğ£ĞŸ Ğš SESSIONMANAGER
// =============================================================================

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‰Ğ¸Ğ¹ SessionManager
ffunction getWorkingSessionManager() {
Â Â Â  console.log('ğŸ›¡ï¸ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ SessionManager...');
Â Â Â  return {
Â Â Â Â Â Â Â  updateUserStats: (userId, field, value = 1) => {
Â Â Â Â Â Â Â Â Â Â Â  console.log(`ğŸ“Š updateUserStats: ${userId}, ${field}, ${value}`);
Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â  getStatistics: () => ({
Â Â Â Â Â Â Â Â Â Â Â  totalUsers: 1,
Â Â Â Â Â Â Â Â Â Â Â  totalPhotos: 0,
Â Â Â Â Â Â Â Â Â Â Â  totalAnalyses: 0,
Â Â Â Â Â Â Â Â Â Â Â  comparisonsMade: 0,
Â Â Â Â Â Â Â Â Â Â Â  activeUsers: 1,
Â Â Â Â Â Â Â Â Â Â Â  activeSessions: 0,
Â Â Â Â Â Â Â Â Â Â Â  referencePrintsCount: 0
Â Â Â Â Â Â Â  }),
Â Â Â Â Â Â Â  globalStats: { totalUsers: 1, totalPhotos: 0, totalAnalyses: 0, comparisonsMade: 0, lastAnalysis: null },
Â Â Â Â Â Â Â  userStats: new Map(),
Â Â Â Â Â Â Â  referencePrints: new Map(),
Â Â Â Â Â Â Â  trailSessions: new Map(), // â† Ğ’ĞĞ–ĞĞ: Ğ”ĞĞ‘ĞĞ’Ğ›Ğ¯Ğ•Ğœ trailSessions
Â Â Â Â Â Â Â  getSession: (chatId) => ({
Â Â Â Â Â Â Â Â Â Â Â  waitingForReference: null,
Â Â Â Â Â Â Â Â Â Â Â  waitingForComparison: null
Â Â Â Â Â Â Â  }),
Â Â Â Â Â Â Â  getTrailSession: (chatId, username) => {
Â Â Â Â Â Â Â Â Â Â Â  // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞµÑÑĞ¸Ñ ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
Â Â Â Â Â Â Â Â Â Â Â  const sessionId = `session_${chatId}_${Date.now()}`;
Â Â Â Â Â Â Â Â Â Â Â  const session = new TrailSession(chatId, username);
Â Â Â Â Â Â Â Â Â Â Â  this.trailSessions.set(chatId, session);
Â Â Â Â Â Â Â Â Â Â Â  return session;
Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â  // ğŸ”§ Ğ”ĞĞ‘ĞĞ’Ğ›Ğ¯Ğ•Ğœ ĞĞ¢Ğ¡Ğ£Ğ¢Ğ¡Ğ¢Ğ’Ğ£Ğ®Ğ©Ğ˜Ğ• ĞœĞ•Ğ¢ĞĞ”Ğ«
Â Â Â Â Â Â Â  serializeForSave: function() {
Â Â Â Â Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  trailSessions: Array.from(this.trailSessions.entries()),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  referencePrints: Array.from(this.referencePrints.entries()),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  userStats: Array.from(this.userStats.entries()),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  globalStats: this.globalStats,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  timestamp: new Date().toISOString()
Â Â Â Â Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â  restoreFromData: function(data) {
Â Â Â Â Â Â Â Â Â Â Â  if (data.trailSessions) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  this.trailSessions = new Map(data.trailSessions);
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  if (data.referencePrints) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  this.referencePrints = new Map(data.referencePrints);
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  if (data.userStats) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  this.userStats = new Map(data.userStats);
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  if (data.globalStats) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  this.globalStats = data.globalStats;
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }
Â Â Â  };
}

// =============================================================================
// ğŸ¦¶ Ğ“ĞĞ ĞĞĞ¢Ğ˜Ğ ĞĞ’ĞĞĞĞ«Ğ™ Ğ”ĞĞ¡Ğ¢Ğ£ĞŸ Ğš FOOTPRINT ASSEMBLER
// =============================================================================

function getFootprintAssembler() {
Â Â Â  // ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ° Ğ´Ğ»Ñ Ğ½ĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹
Â Â Â  console.log('ğŸ¦¶ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ FootprintAssembler');
Â Â Â  return {
Â Â Â Â Â Â Â  partialPrints: new Map(),
Â Â Â Â Â Â Â  assembledModels: new Map(),
Â Â Â Â Â Â Â  classifyFootprintPattern: () => 'right_medium_unknown',
Â Â Â Â Â Â Â  advancedCompatibilityAnalysis: () => 0.7,
Â Â Â Â Â Â Â  calculateOverallBoundingBox: (predictions) => {
Â Â Â Â Â Â Â Â Â Â Â  if (!predictions || predictions.length === 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return { minX: 0, maxX: 100, minY: 0, maxY: 100, width: 100, height: 100 };
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  return { minX: 0, maxX: 800, minY: 0, maxY: 600, width: 800, height: 600 };
Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â  normalizeFootprintGeometry: (predictions) => predictions,
Â Â Â Â Â Â Â  advancedPatternComparison: () => 0.6,
Â Â Â Â Â Â Â  calculateGeometricSimilarity: () => 0.5,
Â Â Â Â Â Â Â  assembleFullModel: () => ({
Â Â Â Â Â Â Â Â Â Â Â  success: true,
Â Â Â Â Â Â Â Â Â Â Â  model: { features: { detailCount: 15, hasOutline: true } },
Â Â Â Â Â Â Â Â Â Â Â  usedPrints: [],
Â Â Â Â Â Â Â Â Â Â Â  completeness: 75,
Â Â Â Â Â Â Â Â Â Â Â  confidence: 80
Â Â Â Â Â Â Â  })
Â Â Â  };
}

// =============================================================================
// ğŸ¯ Ğ Ğ•Ğ“Ğ˜Ğ¡Ğ¢Ğ ĞĞ¦Ğ˜Ğ¯ ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞĞ’ ĞšĞĞœĞĞĞ”
// =============================================================================

const startHandler = new StartHandler(bot, getWorkingSessionManager()); 
bot.onText(/\/start/, (msg) => startHandler.handleStart(msg));

const statisticsHandler = new StatisticsHandler(bot, getWorkingSessionManager());
bot.onText(/\/statistics/, (msg) => statisticsHandler.handleStatistics(msg));

const menuHandler = new MenuHandler(bot, getWorkingSessionManager());
bot.onText(/\/menu/, (msg) => menuHandler.handleMenu(msg));
// ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¿Ğ¾ĞºĞ°Ğ·Ğ° ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
bot.onText(/\/show_model(?:\s+(\d+))?/, (msg, match) => {
Â Â Â  visualizationHandler.handleShowModel(msg, match);
});

// ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
bot.onText(/\/model_details(?:\s+(\d+))?/, (msg, match) => {
Â Â Â  visualizationHandler.handleModelDetails(msg, match);
});

// ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ²ÑĞµÑ… Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²
bot.onText(/\/visualize_results/, (msg) => {
Â Â Â  visualizationHandler.handleVisualizeResults(msg);
});

bot.onText(/\/help(?:\s+(\w+))?/, async (msg, match) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const userId = msg.from.id;
Â Â Â  const helpType = match ? match[1] : null;

Â Â Â  switch (helpType) {
Â Â Â Â Â Â Â  case 'trail':
Â Â Â Â Â Â Â Â Â Â Â  await helpHandler.showTrailHelp(chatId);
Â Â Â Â Â Â Â Â Â Â Â  break;
Â Â Â Â Â Â Â  case 'visualization':
Â Â Â Â Â Â Â Â Â Â Â  await helpHandler.showVisualizationHelp(chatId);
Â Â Â Â Â Â Â Â Â Â Â  break;
Â Â Â Â Â Â Â  case 'assembly':
Â Â Â Â Â Â Â Â Â Â Â  await helpHandler.showAssemblyHelp(chatId);
Â Â Â Â Â Â Â Â Â Â Â  break;
Â Â Â Â Â Â Â  case 'admin':
Â Â Â Â Â Â Â Â Â Â Â  await helpHandler.showAdminHelp(chatId, userId);
Â Â Â Â Â Â Â Â Â Â Â  break;
Â Â Â Â Â Â Â  default:
Â Â Â Â Â Â Â Â Â Â Â  await helpHandler.showInteractiveHelp(chatId, userId);
Â Â Â  }
});

// ğŸ”§ Ğ”ĞĞ‘ĞĞ’Ğ˜Ğ¢Ğ¬ ĞĞ”ĞœĞ˜ĞĞ¡ĞšĞ˜Ğ• ĞšĞĞœĞĞĞ”Ğ«
bot.onText(/\/admin_(\w+)/, async (msg, match) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const userId = msg.from.id;
Â Â Â  const command = match[1];

Â Â Â  if (!await helpHandler.isAdmin(userId)) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰ĞµĞ½. Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°.');
Â Â Â Â Â Â Â  return;
Â Â Â  }

Â Â Â  switch (command) {
Â Â Â Â Â Â Â  case 'stats':
Â Â Â Â Â Â Â Â Â Â Â  await showAdminStats(chatId);
Â Â Â Â Â Â Â Â Â Â Â  break;
Â Â Â Â Â Â Â  case 'export':
Â Â Â Â Â Â Â Â Â Â Â  await adminExportData(chatId);
Â Â Â Â Â Â Â Â Â Â Â  break;
Â Â Â Â Â Â Â  // ... Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¸Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
Â Â Â  }
});

console.log('âœ… Ğ’ÑĞµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹');

// =============================================================================
// ğŸ’¾ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ¯ Ğ”ĞĞĞĞ«Ğ¥
// =============================================================================

class DataPersistence {
Â Â Â  constructor() {
Â Â Â Â Â Â Â  this.dataFile = 'trail_sessions.json';
Â Â Â Â Â Â Â  this.backupInterval = 5 * 60 * 1000; // 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
Â Â Â Â Â Â Â  this.setupAutoSave();
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ°Ğ²Ñ‚Ğ¾ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ
Â Â Â Â  */
Â Â Â  setupAutoSave() {
Â Â Â Â Â Â Â  setInterval(() => {
Â Â Â Â Â Â Â Â Â Â Â  this.saveAllData();
Â Â Â Â Â Â Â  }, this.backupInterval);
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
Â Â Â Â  */
async saveAllData() {
Â Â Â  try {
Â Â Â Â Â Â Â  console.log('ğŸ’¾ ĞĞ²Ñ‚Ğ¾ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...');
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const sessionManager = getWorkingSessionManager();
Â Â Â Â Â Â Â  const data = {
Â Â Â Â Â Â Â Â Â Â Â  trailSessions: Array.from(sessionManager.trailSessions.entries()),
Â Â Â Â Â Â Â Â Â Â Â  referencePrints: Array.from(sessionManager.referencePrints.entries()),
Â Â Â Â Â Â Â Â Â Â Â  userStats: Array.from(sessionManager.userStats.entries()),
Â Â Â Â Â Â Â Â Â Â Â  globalStats: sessionManager.globalStats,
Â Â Â Â Â Â Â Â Â Â Â  timestamp: new Date().toISOString()
Â Â Â Â Â Â Â  };

Â Â Â Â Â Â Â  // Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ
Â Â Â Â Â Â Â  fs.writeFileSync(this.dataFile, JSON.stringify(data, null, 2));
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞº
Â Â Â Â Â Â Â  if (yandexDisk) {
Â Â Â Â Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  await withRetry(async () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  await yandexDisk.uploadFile(this.dataFile, 'sessions_backup.json');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.log('âœ… Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹ Ğ² Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞº');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }, "Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞº Ğ°Ğ²Ñ‚Ğ¾ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ");
Â Â Â Â Â Â Â Â Â Â Â  } catch (driveError) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.log('âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ² Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞº:', driveError.message);
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  console.log('ğŸ’¾ Ğ’ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾');
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  console.log('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:', error.message);
Â Â Â  }
}

Â Â Â  /**
Â Â Â Â  * Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°
Â Â Â Â  */
Â Â Â  async loadAllData() {
Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â  console.log('ğŸ”„ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...');
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  let data = null;
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞºĞ°
Â Â Â Â Â Â Â Â Â Â Â  if (yandexDisk) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (await yandexDisk.fileExists('backup/sessions_backup.json')) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  await yandexDisk.downloadFile('backup/sessions_backup.json', this.dataFile);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.log('âœ… Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹ Ğ¸Ğ· Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞºĞ°');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  } catch (driveError) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.log('âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞºĞ°:', driveError.message);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¸Ğ· Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ°
Â Â Â Â Â Â Â Â Â Â Â  if (fs.existsSync(this.dataFile)) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const fileContent = fs.readFileSync(this.dataFile, 'utf8');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  data = JSON.parse(fileContent);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.log('âœ… Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹');
Â Â Â Â Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.log('ğŸ“ Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹, Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ñ Ñ‡Ğ¸ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ»Ğ¸ÑÑ‚Ğ°');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return;
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // Ğ’ĞĞ¡Ğ¡Ğ¢ĞĞĞĞ’Ğ›Ğ˜Ğ’ĞĞ•Ğœ Ğ’Ğ¡Ğ• Ğ”ĞĞĞĞ«Ğ• Ğ§Ğ•Ğ Ğ•Ğ— SESSIONMANAGER
Â Â Â Â Â Â Â Â Â Â Â  getSessionManager().restoreFromData(data);
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  console.log('ğŸ¯ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹');
Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â  console.log('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…:', error.message);
Â Â Â Â Â Â Â Â Â Â Â  console.log('ğŸ’« ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ ÑĞ¾ ÑĞ²ĞµĞ¶Ğ¸Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…');
Â Â Â Â Â Â Â  }
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ ÑĞµÑÑĞ¸Ğ¸ Ğ² Ñ„Ğ°Ğ¹Ğ»
Â Â Â Â  */
Â Â Â  async exportSession(chatId, format = 'json') {
Â Â Â Â Â Â Â  const session = getSessionManager().trailSessions.get(chatId);
Â Â Â Â Â Â Â  if (!session) {
Â Â Â Â Â Â Â Â Â Â Â  throw new Error('Ğ¡ĞµÑÑĞ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°');
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const exportData = {
Â Â Â Â Â Â Â Â Â Â Â  session: session.getSessionSummary(),
Â Â Â Â Â Â Â Â Â Â Â  footprints: session.footprints,
Â Â Â Â Â Â Â Â Â Â Â  comparisons: session.comparisons,
Â Â Â Â Â Â Â Â Â Â Â  exportTime: new Date().toISOString(),
Â Â Â Â Â Â Â Â Â Â Â  version: '1.0'
Â Â Â Â Â Â Â  };
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const filename = "session_export_" + session.sessionId + "_" + Date.now() + "." + format;
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (format === 'json') {
Â Â Â Â Â Â Â Â Â Â Â  fs.writeFileSync(filename, JSON.stringify(exportData, null, 2));
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return filename;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ¾Ğµ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
Â Â Â Â  */
Â Â Â  async backupConfiguration() {
Â Â Â Â Â Â Â  const config = {
Â Â Â Â Â Â Â Â Â Â Â  modelMetadata: MODEL_METADATA,
Â Â Â Â Â Â Â Â Â Â Â  backupTime: new Date().toISOString(),
Â Â Â Â Â Â Â Â Â Â Â  stats: {
    totalUsers: getSessionManager().globalStats.totalUsers,
Â Â Â  totalPhotos: getSessionManager().globalStats.totalPhotos,
Â Â Â  totalAnalyses: getSessionManager().globalStats.totalAnalyses
}
Â Â Â Â Â Â Â  };
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const configFile = "config_backup_Date.now()}.json";
Â Â Â Â Â Â Â  fs.writeFileSync(configFile, JSON.stringify(config, null, 2));
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (yandexDisk) {
Â Â Â Â Â Â Â Â Â Â Â  await yandexDisk.uploadFile(configFile, "backup/${configFile}");
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return configFile;
Â Â Â  }
}

// =============================================================================
// ğŸš€ Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ« Ğ¡Ğ‘ĞĞ ĞšĞ˜ Ğ˜ Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ¯
// =============================================================================

// ğŸ”§ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
const dataPersistence = new DataPersistence();

class ComparisonVisualizer {
Â Â Â  constructor() {
Â Â Â Â Â Â Â  this.colors = {
Â Â Â Â Â Â Â Â Â Â Â  match: 'rgba(0, 255, 0, 0.6)',Â Â Â Â Â  // Ğ—ĞµĞ»ĞµĞ½Ñ‹Ğ¹ - ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ
Â Â Â Â Â Â Â Â Â Â Â  difference: 'rgba(255, 0, 0, 0.6)', // ĞšÑ€Ğ°ÑĞ½Ñ‹Ğ¹ - Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ¸ÑÂ 
Â Â Â Â Â Â Â Â Â Â Â  missing: 'rgba(255, 255, 0, 0.6)',Â  // Ğ–ĞµĞ»Ñ‚Ñ‹Ğ¹ - Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ
Â Â Â Â Â Â Â Â Â Â Â  partial: 'rgba(255, 165, 0, 0.6)',Â  // ĞÑ€Ğ°Ğ½Ğ¶ĞµĞ²Ñ‹Ğ¹ - Ñ‡Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ğµ
Â Â Â Â Â Â Â Â Â Â Â  outline: 'rgba(0, 0, 255, 0.8)'Â Â Â Â  // Ğ¡Ğ¸Ğ½Ğ¸Ğ¹ - ĞºĞ¾Ğ½Ñ‚ÑƒÑ€
Â Â Â Â Â Â Â  };
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ Ğ´Ğ²ÑƒÑ… Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ²
Â Â Â Â  */
Â Â Â  async createComparisonVisualization(footprintA, footprintB, imageUrl) {
Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â  console.log('ğŸ¨ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ...');
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  const image = await loadImage(imageUrl);
Â Â Â Â Â Â Â Â Â Â Â  const canvas = createCanvas(image.width, image.height);
Â Â Â Â Â Â Â Â Â Â Â  const ctx = canvas.getContext('2d');
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // Ğ Ğ¸ÑÑƒĞµĞ¼ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ğ¾Ğµ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ñ Ğ¿Ğ¾Ğ»ÑƒĞ¿Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒÑ
Â Â Â Â Â Â Â Â Â Â Â  ctx.globalAlpha = 0.3;
Â Â Â Â Â Â Â Â Â Â Â  ctx.drawImage(image, 0, 0);
Â Â Â Â Â Â Â Â Â Â Â  ctx.globalAlpha = 1.0;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ¸Ñ
Â Â Â Â Â Â Â Â Â Â Â  const analysis = this.analyzeDifferences(footprintA, footprintB);
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // Ğ Ğ¸ÑÑƒĞµĞ¼ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ (Ğ·ĞµĞ»ĞµĞ½Ñ‹Ğ¹)
Â Â Â Â Â Â Â Â Â Â Â  this.drawPredictions(ctx, analysis.matches, this.colors.match, 'Ğ¡Ğ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ');
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // Ğ Ğ¸ÑÑƒĞµĞ¼ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ¸Ñ (ĞºÑ€Ğ°ÑĞ½Ñ‹Ğ¹)
Â Â Â Â Â Â Â Â Â Â Â  this.drawPredictions(ctx, analysis.differences, this.colors.difference, 'Ğ Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ¸Ñ');
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // Ğ Ğ¸ÑÑƒĞµĞ¼ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ (Ğ¶ĞµĞ»Ñ‚Ñ‹Ğ¹)
Â Â Â Â Â Â Â Â Â Â Â  this.drawPredictions(ctx, analysis.missingA, this.colors.missing, 'ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² A');
Â Â Â Â Â Â Â Â Â Â Â  this.drawPredictions(ctx, analysis.missingB, this.colors.missing, 'ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² B');
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ»ĞµĞ³ĞµĞ½Ğ´Ñƒ
Â Â Â Â Â Â Â Â Â Â Â  this.drawLegend(ctx, image.width, image.height);
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğ¸
Â Â Â Â Â Â Â Â Â Â Â  this.drawComparisonInfo(ctx, analysis, image.width, image.height);
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  const tempPath = "comparison_${Date.now()}.png";
Â Â Â Â Â Â Â Â Â Â Â  const buffer = canvas.toBuffer('image/png');
Â Â Â Â Â Â Â Â Â Â Â  fs.writeFileSync(tempPath, buffer);
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  console.log('âœ… Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°');
Â Â Â Â Â Â Â Â Â Â Â  return tempPath;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â  console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ:', error);
Â Â Â Â Â Â Â Â Â Â Â  return null;
Â Â Â Â Â Â Â  }
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ¸Ñ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ´Ğ²ÑƒĞ¼Ñ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ°Ğ¼Ğ¸
Â Â Â Â  */
Â Â Â  analyzeDifferences(footprintA, footprintB) {
Â Â Â Â Â Â Â  const predsA = footprintA.predictions || [];
Â Â Â Â Â Â Â  const predsB = footprintB.predictions || [];
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ (Ğ¿Ğ¾Ñ…Ğ¾Ğ¶Ğ¸Ğµ ĞºĞ»Ğ°ÑÑÑ‹ Ğ² Ğ±Ğ»Ğ¸Ğ·ĞºĞ¸Ñ… Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸ÑÑ…)
Â Â Â Â Â Â Â  const matches = [];
Â Â Â Â Â Â Â  const differences = [];
Â Â Â Â Â Â Â  const missingA = [];
Â Â Â Â Â Â Â  const missingB = [];
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ ĞºĞ»Ğ°ÑÑĞ°Ğ¼ Ğ¸ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸ÑĞ¼
Â Â Â Â Â Â Â  predsA.forEach(predA => {
Â Â Â Â Â Â Â Â Â Â Â  const similarInB = predsB.find(predB =>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  predB.class === predA.class &&
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  this.calculateIOU(predA, predB) > 0.3
Â Â Â Â Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  if (similarInB) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  matches.push(predA);
Â Â Â Â Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  differences.push(predA);
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹, Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ² A
Â Â Â Â Â Â Â  predsB.forEach(predB => {
Â Â Â Â Â Â Â Â Â Â Â  const similarInA = predsA.find(predA =>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  predA.class === predB.class &&
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  this.calculateIOU(predA, predB) > 0.3
Â Â Â Â Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  if (!similarInA) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  missingB.push(predB); // ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² A (Ğ½Ğ¾ ĞµÑÑ‚ÑŒ Ğ² B)
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â Â Â  matches,
Â Â Â Â Â Â Â Â Â Â Â  differences,
Â Â Â Â Â Â Â Â Â Â Â  missingA: [], // ĞœĞ¾Ğ¶Ğ½Ğ¾ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ğ»ĞµĞµ ÑĞ»Ğ¾Ğ¶Ğ½ÑƒÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ
Â Â Â Â Â Â Â Â Â Â Â  missingB,
Â Â Â Â Â Â Â Â Â Â Â  similarity: this.calculateOverallSimilarity(footprintA, footprintB)
Â Â Â Â Â Â Â  };
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ Intersection over Union Ğ´Ğ»Ñ Ğ´Ğ²ÑƒÑ… Ğ¿Ñ€ĞµĞ´ÑĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğ¹
Â Â Â Â  */
Â Â Â  calculateIOU(predA, predB) {
Â Â Â Â Â Â Â  if (!predA.points || !predB.points) return 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const bboxA = this.calculateBoundingBox(predA.points);
Â Â Â Â Â Â Â  const bboxB = this.calculateBoundingBox(predB.points);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const intersection = this.calculateIntersection(bboxA, bboxB);
Â Â Â Â Â Â Â  const union = (bboxA.width * bboxA.height) + (bboxB.width * bboxB.height) - intersection;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return union > 0 ? intersection / union : 0;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ Ğ¿Ğ»Ğ¾Ñ‰Ğ°Ğ´ÑŒ Ğ¿ĞµÑ€ĞµÑĞµÑ‡ĞµĞ½Ğ¸Ñ
Â Â Â Â  */
Â Â Â  calculateIntersection(bboxA, bboxB) {
Â Â Â Â Â Â Â  const xOverlap = Math.max(0, Math.min(bboxA.maxX, bboxB.maxX) - Math.max(bboxA.minX, bboxB.minX));
Â Â Â Â Â Â Â  const yOverlap = Math.max(0, Math.min(bboxA.maxY, bboxB.maxY) - Math.max(bboxA.minY, bboxB.minY));
Â Â Â Â Â Â Â  return xOverlap * yOverlap;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ Ğ¾Ğ±Ñ‰ÑƒÑ ÑÑ…Ğ¾Ğ¶ĞµÑÑ‚ÑŒ
Â Â Â Â  */
Â Â Â  calculateOverallSimilarity(footprintA, footprintB) {
Â Â Â Â Â Â Â  const assembler = footprintAssembler;
Â Â Â Â Â Â Â  return assembler.calculateSimilarity(footprintA.features, footprintB.features) * 100;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ Ğ¸ÑÑƒĞµÑ‚ Ğ¿Ñ€ĞµĞ´ÑĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° canvas
Â Â Â Â  */
Â Â Â  drawPredictions(ctx, predictions, color, label) {
Â Â Â Â Â Â Â  if (!predictions || predictions.length === 0) return;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  ctx.strokeStyle = color;
Â Â Â Â Â Â Â  ctx.lineWidth = 3;
Â Â Â Â Â Â Â  ctx.setLineDash([]);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  predictions.forEach(pred => {
Â Â Â Â Â Â Â Â Â Â Â  if (pred.points && pred.points.length > 2) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ctx.beginPath();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ctx.moveTo(pred.points[0].x, pred.points[0].y);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  for (let i = 1; i < pred.points.length; i++) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ctx.lineTo(pred.points[i].x, pred.points[i].y);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ctx.closePath();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ctx.stroke();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑŒ Ğ´Ğ»Ñ ĞºÑ€ÑƒĞ¿Ğ½Ñ‹Ñ… ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (pred.points.length > 4) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const bbox = this.calculateBoundingBox(pred.points);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (bbox.width > 50 && bbox.height > 50) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ctx.fillStyle = color;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ctx.font = '12px Arial';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ctx.fillText(pred.class || 'unknown', bbox.minX, bbox.minY - 5);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  });
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ Ğ¸ÑÑƒĞµÑ‚ Ğ»ĞµĞ³ĞµĞ½Ğ´Ñƒ
Â Â Â Â  */
Â Â Â  drawLegend(ctx, width, height) {
Â Â Â Â Â Â Â  const legendX = width - 200;
Â Â Â Â Â Â Â  const legendY = 20;
Â Â Â Â Â Â Â  const itemHeight = 25;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
Â Â Â Â Â Â Â  ctx.fillRect(legendX - 10, legendY - 10, 190, 130);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const items = [
Â Â Â Â Â Â Â Â Â Â Â  { color: this.colors.match, text: 'âœ… Ğ¡Ğ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ' },
Â Â Â Â Â Â Â Â Â Â Â  { color: this.colors.difference, text: 'âŒ Ğ Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ¸Ñ' },
Â Â Â Â Â Â Â Â Â Â Â  { color: this.colors.missing, text: 'âš ï¸ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ' },
Â Â Â Â Â Â Â Â Â Â Â  { color: this.colors.partial, text: 'ğŸ”„ Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ğµ' }
Â Â Â Â Â Â Â  ];
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  items.forEach((item, index) => {
Â Â Â Â Â Â Â Â Â Â Â  ctx.fillStyle = item.color;
Â Â Â Â Â Â Â Â Â Â Â  ctx.fillRect(legendX, legendY + index * itemHeight, 20, 15);
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  ctx.fillStyle = 'white';
Â Â Â Â Â Â Â Â Â Â Â  ctx.font = '14px Arial';
Â Â Â Â Â Â Â Â Â Â Â  ctx.fillText(item.text, legendX + 30, legendY + 12 + index * itemHeight);
Â Â Â Â Â Â Â  });
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ Ğ¸ÑÑƒĞµÑ‚ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğ¸
Â Â Â Â  */
Â Â Â  drawComparisonInfo(ctx, analysis, width, height) {
Â Â Â Â Â Â Â  ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
Â Â Â Â Â Â Â  ctx.fillRect(10, height - 120, 300, 110);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  ctx.fillStyle = 'white';
Â Â Â Â Â Â Â  ctx.font = 'bold 16px Arial';
Â Â Â Â Â Â Â  ctx.fillText('ğŸ“Š Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢Ğ« Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ¯', 20, height - 95);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  ctx.font = '14px Arial';
Â Â Â Â Â Â Â  ctx.fillText("ğŸ¯ ĞĞ±Ñ‰ĞµĞµ ÑÑ…Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾: ${analysis.similarity.toFixed(1)}%", 20, height - 70);
Â Â Â Â Â Â Â  ctx.fillText("âœ… Ğ¡Ğ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğ¹: ${analysis.matches.length}", 20, height - 50);
Â Â Â Â Â Â Â  ctx.fillText("âŒ Ğ Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ¸Ğ¹: ${analysis.differences.length}", 20, height - 30);
Â Â Â Â Â Â Â  ctx.fillText("âš ï¸ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ…: ${analysis.missingB.length}", 20, height - 10);
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ bounding box
Â Â Â Â  */
Â Â Â  calculateBoundingBox(points) {
Â Â Â Â Â Â Â  const xs = points.map(p => p.x);
Â Â Â Â Â Â Â  const ys = points.map(p => p.y);
Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â Â Â  minX: Math.min(...xs),
Â Â Â Â Â Â Â Â Â Â Â  maxX: Math.max(...xs),
Â Â Â Â Â Â Â Â Â Â Â  minY: Math.min(...ys),
Â Â Â Â Â Â Â Â Â Â Â  maxY: Math.max(...ys),
Â Â Â Â Â Â Â Â Â Â Â  width: Math.max(...xs) - Math.min(...xs),
Â Â Â Â Â Â Â Â Â Â Â  height: Math.max(...ys) - Math.min(...ys)
Â Â Â Â Â Â Â  };
Â Â Â  }
}

const comparisonVisualizer = new ComparisonVisualizer();

// ğŸ•µï¸â€â™‚ï¸ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ Ğ¡Ğ•Ğ¡Ğ¡Ğ˜Ğ™ Ğ¢Ğ ĞĞŸĞ« - ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞĞĞ¯ Ğ’Ğ•Ğ Ğ¡Ğ˜Ğ¯

class TrailSession {
Â Â Â  constructor(chatId, username) {
Â Â Â Â Â Â Â  this.chatId = chatId;
Â Â Â Â Â Â Â  this.expert = username;
Â Â Â Â Â Â Â  this.sessionId = "session_${chatId}_${Date.now()}";
Â Â Â Â Â Â Â  this.startTime = new Date();
Â Â Â Â Â Â Â  this.footprints = [];
Â Â Â Â Â Â Â  this.comparisons = [];
Â Â Â Â Â Â Â  this.status = 'active';
Â Â Â Â Â Â Â  this.notes = '';
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  this.assembledModels = [];
Â Â Â Â Â Â Â  this.footprintParts = new Map();
Â Â Â Â Â Â Â  this.compatibilityGroups = [];
Â Â Â  }

Â Â Â  addFootprint(analysisData) {
Â Â Â Â Â Â Â  const footprintRecord = {
Â Â Â Â Â Â Â Â Â Â Â  id: "footprint_${this.footprints.length + 1}",
Â Â Â Â Â Â Â Â Â Â Â  timestamp: new Date(),
Â Â Â Â Â Â Â Â Â Â Â  imageUrl: analysisData.imageUrl,
Â Â Â Â Â Â Â Â Â Â Â  predictions: analysisData.predictions,
Â Â Â Â Â Â Â Â Â Â Â  features: analysisData.features,
Â Â Â Â Â Â Â Â Â Â Â  perspectiveAnalysis: analysisData.perspectiveAnalysis,
Â Â Â Â Â Â Â Â Â Â Â  orientation: analysisData.orientation
Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  this.footprints.push(footprintRecord);
Â Â Â Â Â Â Â  console.log("ğŸ•µï¸â€â™‚ï¸ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ¾Ğº Ğ² ÑĞµÑÑĞ¸Ñ ${this.sessionId}: ${footprintRecord.id}");
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (this.footprints.length > 1) {
Â Â Â Â Â Â Â Â Â Â Â  this.autoCompareWithPrevious(footprintRecord);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return footprintRecord;
Â Â Â  }

Â Â Â  autoCompareWithPrevious(newFootprint) {
Â Â Â Â Â Â Â  console.log("ğŸ•µï¸â€â™‚ï¸ ĞĞ²Ñ‚Ğ¾ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ° Ñ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¼Ğ¸...");
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const previousFootprints = this.footprints.slice(0, -1);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  previousFootprints.forEach((previous, index) => {
Â Â Â Â Â Â Â Â Â Â Â  const comparison = compareFootprints(previous.features, newFootprint.features);
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  const comparisonRecord = {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  id: "comparison_${this.comparisons.length + 1}",
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  timestamp: new Date(),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  footprintA: previous.id,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  footprintB: newFootprint.id,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  result: comparison,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  similarity: comparison.overallScore,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  notes: this.generateComparisonNotes(comparison, previous, newFootprint)
Â Â Â Â Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  this.comparisons.push(comparisonRecord);
Â Â Â Â Â Â Â Â Â Â Â  console.log("ğŸ” Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ ${previous.id} vs ${newFootprint.id}: ${comparison.overallScore}%");
Â Â Â Â Â Â Â  });
Â Â Â  }

Â Â Â  generateComparisonNotes(comparison, footprintA, footprintB) {
Â Â Â Â Â Â Â  const notes = [];
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (comparison.overallScore > 70) {
Â Â Â Â Â Â Â Â Â Â Â  notes.push('Ğ’Ğ«Ğ¡ĞĞšĞĞ¯ Ğ¡Ğ¥ĞĞ”Ğ˜ĞœĞĞ¡Ğ¢Ğ¬ - Ğ²ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾ Ğ¾Ğ´Ğ¸Ğ½ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº');
Â Â Â Â Â Â Â  } else if (comparison.overallScore > 50) {
Â Â Â Â Â Â Â Â Â Â Â  notes.push('Ğ¡Ğ Ğ•Ğ”ĞĞ¯Ğ¯ Ğ¡Ğ¥ĞĞ”Ğ˜ĞœĞĞ¡Ğ¢Ğ¬ - Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·');
Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â  notes.push('ĞĞ˜Ğ—ĞšĞĞ¯ Ğ¡Ğ¥ĞĞ”Ğ˜ĞœĞĞ¡Ğ¢Ğ¬ - Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸');
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  if (comparison.mirrorUsed) {
Â Â Â Â Â Â Â Â Â Â Â  notes.push('Ğ£Ñ‡Ñ‚ĞµĞ½Ğ° Ğ·ĞµÑ€ĞºĞ°Ğ»ÑŒĞ½Ğ°Ñ ÑĞ¸Ğ¼Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ (Ğ»ĞµĞ²Ñ‹Ğ¹/Ğ¿Ñ€Ğ°Ğ²Ñ‹Ğ¹)');
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  return notes.join('; ');
Â Â Â  }

Â Â Â  getSessionSummary() {
Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â Â Â  sessionId: this.sessionId,
Â Â Â Â Â Â Â Â Â Â Â  expert: this.expert,
Â Â Â Â Â Â Â Â Â Â Â  duration: new Date() - this.startTime,
Â Â Â Â Â Â Â Â Â Â Â  footprintsCount: this.footprints.length,
Â Â Â Â Â Â Â Â Â Â Â  comparisonsCount: this.comparisons.length,
Â Â Â Â Â Â Â Â Â Â Â  averageSimilarity: this.comparisons.length > 0 ?
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  this.comparisons.reduce((sum, comp) => sum + comp.similarity, 0) / this.comparisons.length : 0,
Â Â Â Â Â Â Â Â Â Â Â  status: this.status
Â Â Â Â Â Â Â  };
Â Â Â  }

Â Â Â  generateExpertReport() {
Â Â Â Â Â Â Â  const summary = this.getSessionSummary();
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  let report = "ğŸ•µï¸â€â™‚ï¸ **ĞĞĞĞ›Ğ˜Ğ— Ğ¢Ğ ĞĞŸĞ«**\n\n";
Â Â Â Â Â Â Â  report += "**Ğ¡ĞµÑÑĞ¸Ñ:** ${summary.sessionId}\n";
Â Â Â Â Â Â Â  report += "**Ğ­ĞºÑĞ¿ĞµÑ€Ñ‚:** ${summary.expert}\n";
Â Â Â Â Â Â Â  report += "**ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ:** ${Math.round(summary.duration / 60000)} Ğ¼Ğ¸Ğ½.\n";
Â Â Â Â Â Â Â  report += "**ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ²:** ${summary.footprintsCount}\n";
Â Â Â Â Â Â Â  report += "**Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğ¹:** ${summary.comparisonsCount}\n";
Â Â Â Â Â Â Â  report += "**Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ ÑÑ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ:** ${summary.averageSimilarity.toFixed(1)}%\n\n";
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (this.comparisons.length > 0) {
Â Â Â Â Â Â Â Â Â Â Â  report += "**ĞšĞ›Ğ®Ğ§Ğ•Ğ’Ğ«Ğ• Ğ’Ğ«Ğ’ĞĞ”Ğ«:**\n";
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  const highSimilarity = this.comparisons.filter(c => c.similarity > 70);
Â Â Â Â Â Â Â Â Â Â Â  if (highSimilarity.length > 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  report += "â€¢ ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ ${highSimilarity.length} Ğ¿Ğ°Ñ€ Ñ Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ¹ ÑÑ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒÑ\n";
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  const uniqueGroups = this.identifyUniqueGroups();
Â Â Â Â Â Â Â Â Â Â Â  report += "â€¢ Ğ’Ñ‹ÑĞ²Ğ»ĞµĞ½Ğ¾ ${uniqueGroups.length} ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¼Ğ¾Ñ€Ñ„Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ³Ñ€ÑƒĞ¿Ğ¿\n";
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  report += "\n**Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡:** ${this.status === 'active' ? 'ĞĞšĞ¢Ğ˜Ğ’ĞĞ' : 'Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ'}";
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return report;
Â Â Â  }

Â Â Â  identifyUniqueGroups() {
Â Â Â Â Â Â Â  const groups = [];
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  this.footprints.forEach(footprint => {
Â Â Â Â Â Â Â Â Â Â Â  let assigned = false;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  for (let group of groups) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const avgSimilarity = group.members.reduce((sum, member) => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const comparison = this.comparisons.find(c =>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  (c.footprintA === footprint.id && c.footprintB === member) ||
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  (c.footprintB === footprint.id && c.footprintA === member)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return sum + (comparison ? comparison.similarity : 0);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }, 0) / group.members.length;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (avgSimilarity > 60) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  group.members.push(footprint.id);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  assigned = true;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  break;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  if (!assigned) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  groups.push({ id: "group_${groups.length + 1}", members: [footprint.id] });
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return groups;
Â Â Â  }

Â Â Â      analyzeFootprintParts(imageWidth, imageHeight) {
    console.log("ğŸ•µï¸â€â™‚ï¸ ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒÑ ÑƒĞ·Ğ¾Ñ€Ñ‹ Ğ¿Ñ€Ğ¾Ñ‚ĞµĞºÑ‚Ğ¾Ñ€Ğ° Ğ´Ğ»Ñ ${this.footprints.length} Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ²...");
   
    const assembler = footprintAssembler;
   
    this.footprints.forEach(footprint => {
        // ğŸ”§ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ’Ğ«Ğ§Ğ˜Ğ¡Ğ›Ğ¯Ğ•Ğœ patternType, Ğ° Ğ½Ğµ Ğ±ĞµÑ€ĞµĞ¼ Ğ¸Ğ· footprint
        const patternType = assembler.classifyFootprintPattern(footprint.predictions, imageWidth, imageHeight);
        footprint.patternType = patternType;
        footprint.partType = patternType; // Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾Ğ¹ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
        footprint.assemblyPotential = this.calculateAssemblyPotential(footprint);
        console.log("ğŸ“‹ ĞÑ‚Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ¾Ğº ${footprint.id}: ${patternType} (Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»: ${footprint.assemblyPotential})");
    });
   
    this.updateCompatibilityGroups();
}



Â Â Â  calculateAssemblyPotential(footprint) {
Â Â Â Â Â Â Â  if (!footprint.features) return 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  let score = 0;
Â Â Â Â Â Â Â  const details = footprint.features.detailCount || 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (details > 15) score += 40;
Â Â Â Â Â Â Â  else if (details > 8) score += 25;
Â Â Â Â Â Â Â  else if (details > 3) score += 15;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (footprint.features.hasOutline) score += 30;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (footprint.features.largeDetails > 2) score += 20;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return Math.min(score, 100);
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞ»ĞµĞ´Ñ‹ Ğ¿Ğ¾ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğ¼ Ğ»ÑĞ´ÑĞ¼/Ğ¾Ğ±ÑƒĞ²Ğ¸
Â Â Â Â  */
Â Â Â  updateCompatibilityGroups() {
Â Â Â Â Â Â Â  console.log("ğŸ•µï¸â€â™‚ï¸ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° ÑĞ»ĞµĞ´Ğ¾Ğ² Ğ¿Ğ¾ Ğ»ÑĞ´ÑĞ¼...");
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  this.compatibilityGroups = [];
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ”„ ĞŸĞ ĞĞ¥ĞĞ”Ğ˜Ğœ ĞŸĞ Ğ’Ğ¡Ğ•Ğœ Ğ¡Ğ›Ğ•Ğ”ĞĞœ Ğ˜ Ğ ĞĞ¡ĞŸĞ Ğ•Ğ”Ğ•Ğ›Ğ¯Ğ•Ğœ ĞŸĞ Ğ“Ğ Ğ£ĞŸĞŸĞĞœ
Â Â Â Â Â Â Â  this.footprints.forEach(footprint => {
Â Â Â Â Â Â Â Â Â Â Â  let assignedToGroup = false;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // ğŸ” Ğ˜Ğ©Ğ•Ğœ ĞŸĞĞ”Ğ¥ĞĞ”Ğ¯Ğ©Ğ£Ğ® Ğ“Ğ Ğ£ĞŸĞŸĞ£
Â Â Â Â Â Â Â Â Â Â Â  for (let group of this.compatibilityGroups) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const groupCompatibility = this.assessGroupCompatibility(group, footprint);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (groupCompatibility > 0.6) { // ğŸ‘ˆ ĞŸĞĞ ĞĞ“ Ğ”Ğ›Ğ¯ ĞĞ”ĞĞĞ“Ğ Ğ§Ğ•Ğ›ĞĞ’Ğ•ĞšĞ
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  group.push(footprint);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  assignedToGroup = true;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.log("âœ… Ğ¡Ğ»ĞµĞ´ ${footprint.id} Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ (ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ: ${groupCompatibility.toFixed(3)})");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  break;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // ğŸ†• Ğ•Ğ¡Ğ›Ğ˜ ĞĞ• ĞĞĞ¨Ğ›Ğ˜ Ğ“Ğ Ğ£ĞŸĞŸĞ£ - Ğ¡ĞĞ—Ğ”ĞĞ•Ğœ ĞĞĞ’Ğ£Ğ®
Â Â Â Â Â Â Â Â Â Â Â  if (!assignedToGroup) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  this.compatibilityGroups.push([footprint]);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.log("ğŸ†• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ½Ğ¾Ğ²Ğ°Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ° Ğ´Ğ»Ñ ÑĞ»ĞµĞ´Ğ° ${footprint.id}");
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  console.log("ğŸ¯ ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ğ³Ñ€ÑƒĞ¿Ğ¿ (Ğ»ÑĞ´ĞµĞ¹): ${this.compatibilityGroups.length}");
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞÑ†ĞµĞ½Ğ¸Ğ²Ğ°ĞµÑ‚ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ ÑĞ»ĞµĞ´Ğ° Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ¹
Â Â Â Â  */
Â Â Â  assessGroupCompatibility(group, newFootprint) {
Â Â Â Â Â Â Â  if (group.length === 0) return 0.5;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  let totalCompatibility = 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  group.forEach(existingFootprint => {
Â Â Â Â Â Â Â Â Â Â Â  const compatibility = this.calculateFootprintCompatibility(existingFootprint, newFootprint);
Â Â Â Â Â Â Â Â Â Â Â  totalCompatibility += compatibility;
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return totalCompatibility / group.length;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ´Ğ²ÑƒÑ… ÑĞ»ĞµĞ´Ğ¾Ğ²
Â Â Â Â  */
Â Â Â  calculateFootprintCompatibility(footprintA, footprintB) {
Â Â Â Â Â Â Â  const assembler = footprintAssembler;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ¯ ĞšĞĞœĞ‘Ğ˜ĞĞ˜Ğ ĞĞ’ĞĞĞĞ«Ğ™ ĞĞĞĞ›Ğ˜Ğ—:
Â Â Â Â Â Â Â  let imageWidth = 800, imageHeight = 600;
Â Â Â Â Â Â Â  if (footprintA.features?.imageSize) {
Â Â Â Â Â Â Â Â Â Â Â  imageWidth = footprintA.features.imageSize.width;
Â Â Â Â Â Â Â Â Â Â Â  imageHeight = footprintA.features.imageSize.height;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return assembler.advancedCompatibilityAnalysis(
Â Â Â Â Â Â Â Â Â Â Â  [footprintA],
Â Â Â Â Â Â Â Â Â Â Â  footprintB,
Â Â Â Â Â Â Â Â Â Â Â  imageWidth,
Â Â Â Â Â Â Â Â Â Â Â  imageHeight
Â Â Â Â Â Â Â  ) ? 0.8 : 0.2; // ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ boolean Ğ² score
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¸Ğ· ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ¹ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
Â Â Â Â  */
Â Â Â  assembleModelFromGroup(group, imageWidth, imageHeight) {
Â Â Â Â Â Â Â  if (group.length < 2) {
Â Â Â Â Â Â Â Â Â Â Â  return { success: false, error: 'ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ÑĞ»ĞµĞ´Ğ¾Ğ² Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ Ğ´Ğ»Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸' };
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  console.log("ğŸ§© Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ¸Ğ· ${group.length} ÑĞ»ĞµĞ´Ğ¾Ğ²...");
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const assembler = footprintAssembler;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‡Ğ°ÑÑ‚Ğ¸ ĞµÑĞ»Ğ¸ ĞµÑ‰Ğµ Ğ½Ğµ ÑĞ´ĞµĞ»Ğ°Ğ½Ğ¾
Â Â Â Â Â Â Â  if (!group[0].patternType) {
Â Â Â Â Â Â Â Â Â Â Â  group.forEach(footprint => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const patternType = assembler.classifyFootprintPattern(
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  footprint.predictions,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  imageWidth,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  imageHeight
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  footprint.patternType = patternType;
Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const result = assembler.assembleFullModel(group, imageWidth, imageHeight);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (result.success) {
Â Â Â Â Â Â Â Â Â Â Â  console.log("âœ… ĞœĞ¾Ğ´ĞµĞ»ÑŒ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ° Ğ¸Ğ· Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹: ${result.completeness}% Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ‚Ñ‹");
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return result;
Â Â Â  }

Â Â Â  assembleModelFromParts(imageWidth, imageHeight) {
Â Â Â Â Â Â Â  if (this.footprints.length < 2) {
Â Â Â Â Â Â Â Â Â Â Â  return { success: false, error: 'ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ² Ğ´Ğ»Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸' };
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  console.log("ğŸ§© ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºÑƒ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¸Ğ· ${this.footprints.length} Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ²...");
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const assembler = footprintAssembler;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (!this.footprints[0].partType) {
Â Â Â Â Â Â Â Â Â Â Â  this.analyzeFootprintParts(imageWidth, imageHeight);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const result = assembler.assembleFullModel(this.footprints, imageWidth, imageHeight);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (result.success) {
Â Â Â Â Â Â Â Â Â Â Â  const assembledModel = {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  id: "assembled_${this.assembledModels.length + 1}",
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  timestamp: new Date(),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  model: result.model,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sourcePrints: result.usedPrints.map(p => p.id),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  completeness: result.completeness,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  confidence: result.confidence
Â Â Â Â Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  this.assembledModels.push(assembledModel);
Â Â Â Â Â Â Â Â Â Â Â  console.log("âœ… ĞœĞ¾Ğ´ĞµĞ»ÑŒ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ°: ${result.completeness}% Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ‚Ñ‹, ${result.confidence}% ÑƒĞ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸");
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return result;
Â Â Â  }

Â Â Â     getPartsStatistics() {
        const parts = { 
            left_small: 0, left_medium: 0, left_large: 0,
            right_small: 0, right_medium: 0, right_large: 0,
            center_small: 0, center_medium: 0, center_large: 0,
            unknown: 0 
        };
       
        this.footprints.forEach(footprint => {
            const patternType = footprint.patternType || 'unknown';  // â† Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•!
            parts[patternType] = (parts[patternType] || 0) + 1;
        });
       
        return parts;
    }

Â Â Â  generateEnhancedReport() {
Â Â Â Â Â Â Â  const summary = this.getSessionSummary();
Â Â Â Â Â Â Â  const partsStats = this.getPartsStatistics();
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  let report = "ğŸ•µï¸â€â™‚ï¸ **Ğ ĞĞ¡Ğ¨Ğ˜Ğ Ğ•ĞĞĞ«Ğ™ ĞĞĞĞ›Ğ˜Ğ— Ğ¢Ğ ĞĞŸĞ«**\n\n";
Â Â Â Â Â Â Â  report += `**Ğ¡ĞµÑÑĞ¸Ñ:** ${summary.sessionId}\n";
Â Â Â Â Â Â Â  report += "**Ğ­ĞºÑĞ¿ĞµÑ€Ñ‚:** ${this.expert}\n";
Â Â Â Â Â Â Â  report += "**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** ${this.status === 'active' ? 'ğŸŸ¢ ĞĞšĞ¢Ğ˜Ğ’ĞĞ' : 'ğŸ”´ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ'}\n";
Â Â Â Â Â Â Â  report += "**ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ:** ${Math.round(summary.duration / 60000)} Ğ¼Ğ¸Ğ½.\n\n";
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â         report += "ğŸ“Š **Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ Ğ£Ğ—ĞĞ ĞĞ’:**\n";
        report += "â€¢ Ğ’ÑĞµĞ³Ğ¾: ${summary.footprintsCount}\n";
        report += "â€¢ Ğ›ĞµĞ²Ñ‹Ğµ: ${partsStats.left_small + partsStats.left_medium + partsStats.left_large}\n";
        report += "â€¢ ĞŸÑ€Ğ°Ğ²Ñ‹Ğµ: ${partsStats.right_small + partsStats.right_medium + partsStats.right_large}\n";
        report += "â€¢ Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ: ${partsStats.center_small + partsStats.center_medium + partsStats.center_large}\n";
        report += "â€¢ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğµ: ${partsStats.unknown}\n\n`;

Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  report += "ğŸ” **Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ¯:**\n";
Â Â Â Â Â Â Â  report += "â€¢ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾: ${summary.comparisonsCount}\n";
Â Â Â Â Â Â Â  report += "â€¢ Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ ÑÑ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ: ${summary.averageSimilarity.toFixed(1)}%\n\n";
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  report += "ğŸ§© **Ğ¡Ğ‘ĞĞ ĞšĞ ĞœĞĞ”Ğ•Ğ›Ğ•Ğ™:**\n";
Â Â Â Â Â Â Â  report += "â€¢ Ğ¡Ğ¾Ğ±Ñ€Ğ°Ğ½Ğ¾ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹: ${this.assembledModels.length}\n";
Â Â Â Â Â Â Â  report += "â€¢ Ğ“Ñ€ÑƒĞ¿Ğ¿ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸: ${this.compatibilityGroups.length}\n\n";
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (this.assembledModels.length > 0) {
Â Â Â Â Â Â Â Â Â Â Â  const bestModel = this.assembledModels.reduce((best, current) => current.completeness > best.completeness ? current : best);
Â Â Â Â Â Â Â Â Â Â Â  report += "ğŸ† **Ğ›Ğ£Ğ§Ğ¨ĞĞ¯ ĞœĞĞ”Ğ•Ğ›Ğ¬:**\n";
Â Â Â Â Â Â Â Â Â Â Â  report += "â€¢ ĞŸĞ¾Ğ»Ğ½Ğ¾Ñ‚Ğ°: ${bestModel.completeness}%\n";
Â Â Â Â Â Â Â Â Â Â Â  report += "â€¢ Ğ£Ğ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ: ${bestModel.confidence}%\n";
Â Â Â Â Â Â Â Â Â Â Â  report += "â€¢ Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ²: ${bestModel.sourcePrints.length}\n";
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (this.notes) {
Â Â Â Â Â Â Â Â Â Â Â  report += "\nğŸ“ **Ğ—ĞĞœĞ•Ğ¢ĞšĞ˜ Ğ­ĞšĞ¡ĞŸĞ•Ğ Ğ¢Ğ:**\n${this.notes}\n";
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return report;
Â Â Â  }
 }


// =============================================================================
// ğŸ§© Ğ£ĞœĞĞĞ¯ Ğ¡Ğ‘ĞĞ ĞšĞ ĞœĞĞ”Ğ•Ğ›Ğ•Ğ™ Ğ˜Ğ— Ğ§ĞĞ¡Ğ¢Ğ˜Ğ§ĞĞ«Ğ¥ ĞĞ¢ĞŸĞ•Ğ§ĞĞ¢ĞšĞĞ’
// =============================================================================

class FootprintAssembler {
Â Â Â  constructor() {
Â Â Â Â Â Â Â  this.partialPrints = new Map();
Â Â Â Â Â Â Â  this.assembledModels = new Map();
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞšĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµÑ‚ Ñ„Ñ€Ğ°Ğ³Ğ¼ĞµĞ½Ñ‚Ñ‹ Ğ¿Ñ€Ğ¾Ñ‚ĞµĞºÑ‚Ğ¾Ñ€Ğ° Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ ÑƒĞ·Ğ¾Ñ€Ğ° Ğ¸ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ğ»ĞµĞ²Ñ‹Ğ¹/Ğ¿Ñ€Ğ°Ğ²Ñ‹Ğ¹
Â Â Â Â  */
Â Â Â  classifyFootprintPattern(predictions, imageWidth, imageHeight) {
Â Â Â Â Â Â Â  if (!predictions || predictions.length === 0) return 'unknown_fragment';
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const features = extractFeatures(predictions);
Â Â Â Â Â Â Â  const bbox = this.calculateOverallBoundingBox(predictions);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  console.log("ğŸ¨ ĞĞ½Ğ°Ğ»Ğ¸Ğ· ÑƒĞ·Ğ¾Ñ€Ğ° Ğ¿Ñ€Ğ¾Ñ‚ĞµĞºÑ‚Ğ¾Ñ€Ğ°: ${features.detailCount} Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹, ${features.largeDetails} ĞºÑ€ÑƒĞ¿Ğ½Ñ‹Ñ…");

Â Â Â Â Â Â Â  // ğŸ” ĞĞĞĞ›Ğ˜Ğ— Ğ¡Ğ˜ĞœĞœĞ•Ğ¢Ğ Ğ˜Ğ˜ Ğ”Ğ›Ğ¯ ĞĞŸĞ Ğ•Ğ”Ğ•Ğ›Ğ•ĞĞ˜Ğ¯ Ğ›Ğ•Ğ’Ğ«Ğ™/ĞŸĞ ĞĞ’Ğ«Ğ™
Â Â Â Â Â Â Â  const symmetryAnalysis = this.analyzeFootprintSymmetry(predictions, bbox);
Â Â Â Â Â Â Â  const footSide = symmetryAnalysis.side;
Â Â Â Â Â Â Â  const symmetryScore = symmetryAnalysis.score;

Â Â Â Â Â Â Â  // ğŸ¯ ĞšĞ›ĞĞ¡Ğ¡Ğ˜Ğ¤Ğ˜ĞšĞĞ¦Ğ˜Ğ¯ ĞŸĞ Ğ¥ĞĞ ĞĞšĞ¢Ğ•Ğ Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞĞœ Ğ£Ğ—ĞĞ Ğ
Â Â Â Â Â Â Â  let patternComplexity = 'unknown';
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (features.detailCount > 20) {
Â Â Â Â Â Â Â Â Â Â Â  patternComplexity = 'high_density';
Â Â Â Â Â Â Â  } else if (features.detailCount > 10) {
Â Â Â Â Â Â Â Â Â Â Â  patternComplexity = 'medium_density';
Â Â Â Â Â Â Â  } else if (features.detailCount > 5) {
Â Â Â Â Â Â Â Â Â Â Â  patternComplexity = 'low_density';
Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â  patternComplexity = 'sparse';
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  // ğŸ”§ Ğ£Ğ§Ğ•Ğ¢ ĞšĞ Ğ£ĞŸĞĞ«Ğ¥ Ğ­Ğ›Ğ•ĞœĞ•ĞĞ¢ĞĞ’
Â Â Â Â Â Â Â  if (features.largeDetails > 5) {
Â Â Â Â Â Â Â Â Â Â Â  patternComplexity = 'large_elements_' + patternComplexity;
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  // ğŸ“ Ğ£Ğ§Ğ•Ğ¢ Ğ ĞĞ—ĞœĞ•Ğ Ğ Ğ¤Ğ ĞĞ“ĞœĞ•ĞĞ¢Ğ
Â Â Â Â Â Â Â  const coverage = (bbox.width * bbox.height) / (imageWidth * imageHeight);
Â Â Â Â Â Â Â  let sizeCategory = 'medium';
Â Â Â Â Â Â Â  if (coverage > 0.3) sizeCategory = 'large';
Â Â Â Â Â Â Â  if (coverage < 0.1) sizeCategory = 'small';

Â Â Â Â Â Â Â  const result = "${footSide}_${sizeCategory}_${patternComplexity}";
Â Â Â Â Â Â Â  console.log("ğŸ“‹ ĞšĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ: ${result} (ÑĞ¸Ğ¼Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ: ${symmetryScore.toFixed(2)})");
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return result;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞ¸Ğ¼Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ»ĞµĞ²Ñ‹Ğ¹/Ğ¿Ñ€Ğ°Ğ²Ñ‹Ğ¹ ÑĞ»ĞµĞ´
Â Â Â Â  */
Â Â Â  analyzeFootprintSymmetry(predictions, bbox) {
Â Â Â Â Â Â Â  if (!predictions || predictions.length < 3) {
Â Â Â Â Â Â Â Â Â Â Â  return { side: 'unknown', score: 0.5 };
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â  const centerX = bbox.minX + bbox.width / 2;
Â Â Â Â Â Â Â Â Â Â Â  let leftDensity = 0, rightDensity = 0;

Â Â Â Â Â Â Â Â Â Â Â  predictions.forEach(pred => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (pred.points && pred.points.length > 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const predBbox = this.calculateBoundingBox(pred.points);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const predCenterX = predBbox.minX + predBbox.width / 2;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const area = predBbox.width * predBbox.height;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (predCenterX < centerX) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  leftDensity += area;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  rightDensity += area;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  });

Â Â Â Â Â Â Â Â Â Â Â  const totalDensity = leftDensity + rightDensity;
Â Â Â Â Â Â Â Â Â Â Â  if (totalDensity === 0) return { side: 'unknown', score: 0.5 };

Â Â Â Â Â Â Â Â Â Â Â  const rightRatio = rightDensity / totalDensity;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // ğŸ“Š ĞĞŸĞ Ğ•Ğ”Ğ•Ğ›Ğ¯Ğ•Ğœ Ğ¡Ğ¢ĞĞ ĞĞĞ£
Â Â Â Â Â Â Â Â Â Â Â  let side = 'unknown';
Â Â Â Â Â Â Â Â Â Â Â  if (rightRatio > 0.6) side = 'right';
Â Â Â Â Â Â Â Â Â Â Â  else if (rightRatio < 0.4) side = 'left';
Â Â Â Â Â Â Â Â Â Â Â  else side = 'center';

Â Â Â Â Â Â Â Â Â Â Â  return { side, score: rightRatio };

Â Â Â Â Â Â Â  } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â  console.log('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° ÑĞ¸Ğ¼Ğ¼ĞµÑ‚Ñ€Ğ¸Ğ¸:', error.message);
Â Â Â Â Â Â Â Â Â Â Â  return { side: 'unknown', score: 0.5 };
Â Â Â Â Â Â Â  }
Â Â Â  }

/**
* ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞ¸Ğ¼Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ»ĞµĞ²Ñ‹Ğ¹/Ğ¿Ñ€Ğ°Ğ²Ñ‹Ğ¹ ÑĞ»ĞµĞ´
*/
analyzeSymmetry(predictions, bbox) {
Â Â Â  if (!predictions || predictions.length < 5) return 0.5;
Â Â Â 
Â Â Â  try {
Â Â Â Â Â Â Â  const centerX = bbox.minX + bbox.width / 2;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹ ÑĞ»ĞµĞ²Ğ° Ğ¸ ÑĞ¿Ñ€Ğ°Ğ²Ğ° Ğ¾Ñ‚ Ñ†ĞµĞ½Ñ‚Ñ€Ğ°
Â Â Â Â Â Â Â  let leftCount = 0, rightCount = 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  predictions.forEach(pred => {
Â Â Â Â Â Â Â Â Â Â Â  if (pred.points && pred.points.length > 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const predBbox = this.calculateBoundingBox(pred.points);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const predCenterX = predBbox.minX + predBbox.width / 2;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (predCenterX < centerX) leftCount++;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  else rightCount++;
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const total = leftCount + rightCount;
Â Â Â Â Â Â Â  if (total === 0) return 0.5;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ°ÑĞ¸Ğ¼Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ (0.0 - ÑĞ¸Ğ»ÑŒĞ½Ğ¾ Ğ»ĞµĞ²Ñ‹Ğ¹, 1.0 - ÑĞ¸Ğ»ÑŒĞ½Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ñ‹Ğ¹, 0.5 - ÑĞ¸Ğ¼Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ‡Ğ½Ñ‹Ğ¹)
Â Â Â Â Â Â Â  return rightCount / total;
Â Â Â Â Â Â Â 
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  return 0.5;
Â Â Â  }
}

/**
* Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ bounding box
*/
calculateBoundingBox(points) {
Â Â Â  const xs = points.map(p => p.x);
Â Â Â  const ys = points.map(p => p.y);
Â Â Â  return {
Â Â Â Â Â Â Â  minX: Math.min(...xs),
Â Â Â Â Â Â Â  maxX: Math.max(...xs),
Â Â Â Â Â Â Â  minY: Math.min(...ys),
Â Â Â Â Â Â Â  maxY: Math.max(...ys),
Â Â Â Â Â Â Â  width: Math.max(...xs) - Math.min(...xs),
Â Â Â Â Â Â Â  height: Math.max(...ys) - Math.min(...ys)
Â Â Â  };
}
Â Â Â  /**
Â Â Â Â  * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ bounding box Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¿Ñ€ĞµĞ´ÑĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğ¹
Â Â Â Â  */
Â Â Â  calculateOverallBoundingBox(predictions) {
Â Â Â Â Â Â Â  if (!predictions || predictions.length === 0) {
Â Â Â Â Â Â Â Â Â Â Â  return { minX: 0, maxX: 0, minY: 0, maxY: 0, width: 0, height: 0 };
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  let minX = Infinity, minY = Infinity, maxX = 0, maxY = 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  predictions.forEach(pred => {
Â Â Â Â Â Â Â Â Â Â Â  if (pred.points && pred.points.length > 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  pred.points.forEach(point => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  minX = Math.min(minX, point.x);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  minY = Math.min(minY, point.y);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  maxX = Math.max(maxX, point.x);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  maxY = Math.max(maxY, point.y);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â Â Â  minX, minY, maxX, maxY,
Â Â Â Â Â Â Â Â Â Â Â  width: maxX - minX,
Â Â Â Â Â Â Â Â Â Â Â  height: maxY - minY
Â Â Â Â Â Â Â  };
Â Â Â  }

/**
Â Â Â Â  * Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ğ¾Ğµ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ğ¿ĞµÑ€ĞµĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¹ Ğ¸ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ¾Ğ¼ Ğ¼ĞµĞ»ĞºĞ¸Ñ… Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹
Â Â Â Â  */
Â Â Â  advancedPatternComparison(predictionsA, predictionsB) {
Â Â Â Â Â Â Â  if (!predictionsA || !predictionsB) return 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  console.log("ğŸ” Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ğ¾Ğµ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ: ${predictionsA.length} vs ${predictionsB.length} Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹");

Â Â Â Â Â Â Â  let totalScore = 0;
Â Â Â Â Â Â Â  let validComparisons = 0;

Â Â Â Â Â Â Â  // ğŸ”„ Ğ¡Ğ ĞĞ’ĞĞ˜Ğ’ĞĞ•Ğœ Ğ’ ĞĞ‘Ğ• Ğ¡Ğ¢ĞĞ ĞĞĞ« Ğ”Ğ›Ğ¯ Ğ¢ĞĞ§ĞĞĞ¡Ğ¢Ğ˜
Â Â Â Â Â Â Â  const scoreAB = this.compareDetailsWithPriority(predictionsA, predictionsB);
Â Â Â Â Â Â Â  const scoreBA = this.compareDetailsWithPriority(predictionsB, predictionsA);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ“Š Ğ£Ğ¡Ğ Ğ•Ğ”ĞĞ¯Ğ•Ğœ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢Ğ«
Â Â Â Â Â Â Â  const finalScore = (scoreAB + scoreBA) / 2;
Â Â Â Â Â Â Â  console.log("ğŸ¯ Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ score: ${finalScore.toFixed(3)}");
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return finalScore;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ñ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ¾Ğ¼ Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ñ… Ğ¼ĞµĞ»ĞºĞ¸Ñ… Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹
Â Â Â Â  */
Â Â Â  compareDetailsWithPriority(sourcePredictions, targetPredictions) {
Â Â Â Â Â Â Â  if (!sourcePredictions || !targetPredictions) return 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  let totalScore = 0;
Â Â Â Â Â Â Â  let comparisonCount = 0;

Â Â Â Â Â Â Â  sourcePredictions.forEach(sourcePred => {
Â Â Â Â Â Â Â Â Â Â Â  if (!sourcePred.points || sourcePred.points.length < 3) return;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  const sourceBbox = this.calculateBoundingBox(sourcePred.points);
Â Â Â Â Â Â Â Â Â Â Â  const sourceArea = sourceBbox.width * sourceBbox.height;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  let bestMatchScore = 0;
Â Â Â Â Â Â Â Â Â Â Â  let bestMatchSizeRatio = 1;

Â Â Â Â Â Â Â Â Â Â Â  // ğŸ” Ğ˜Ğ©Ğ•Ğœ Ğ›Ğ£Ğ§Ğ¨Ğ•Ğ• Ğ¡ĞĞ’ĞŸĞĞ”Ğ•ĞĞ˜Ğ• Ğ¡ Ğ£Ğ§Ğ•Ğ¢ĞĞœ Ğ ĞĞ—ĞœĞ•Ğ Ğ
Â Â Â Â Â Â Â Â Â Â Â  targetPredictions.forEach(targetPred => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (!targetPred.points || targetPred.points.length < 3) return;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const targetBbox = this.calculateBoundingBox(targetPred.points);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const targetArea = targetBbox.width * targetBbox.height;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const overlapScore = this.calculateSmartOverlap(sourceBbox, targetBbox, sourcePred, targetPred);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const sizeRatio = Math.min(sourceArea, targetArea) / Math.max(sourceArea, targetArea);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // ğŸ¯ ĞŸĞ Ğ˜ĞĞ Ğ˜Ğ¢Ğ•Ğ¢ Ğ¢ĞĞ§ĞĞ«Ğœ Ğ¡ĞĞ’ĞŸĞĞ”Ğ•ĞĞ˜Ğ¯Ğœ ĞœĞ•Ğ›ĞšĞ˜Ğ¥ Ğ”Ğ•Ğ¢ĞĞ›Ğ•Ğ™
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (overlapScore > bestMatchScore ||
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  (overlapScore > 0.3 && sizeRatio < bestMatchSizeRatio)) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  bestMatchScore = overlapScore;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  bestMatchSizeRatio = sizeRatio;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  });

Â Â Â Â Â Â Â Â Â Â Â  // ğŸ’ Ğ’Ğ•Ğ¡ĞĞ’ĞĞ™ ĞšĞĞ­Ğ¤Ğ¤Ğ˜Ğ¦Ğ˜Ğ•ĞĞ¢: Ğ¼ĞµĞ»ĞºĞ¸Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ²Ğ°Ğ¶Ğ½ĞµĞµ
Â Â Â Â Â Â Â Â Â Â Â  let weight = 1.0;
Â Â Â Â Â Â Â Â Â Â Â  if (sourceArea < 500) weight = 1.5;Â Â Â  // ĞœĞµĞ»ĞºĞ¸Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸
Â Â Â Â Â Â Â Â Â Â Â  if (sourceArea < 200) weight = 2.0;Â Â Â  // ĞÑ‡ĞµĞ½ÑŒ Ğ¼ĞµĞ»ĞºĞ¸Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸
Â Â Â Â Â Â Â Â Â Â Â  if (sourceArea > 2000) weight = 0.7;Â Â  // ĞšÑ€ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸

Â Â Â Â Â Â Â Â Â Â Â  totalScore += bestMatchScore * weight;
Â Â Â Â Â Â Â Â Â Â Â  comparisonCount += weight;
Â Â Â Â Â Â Â  });

Â Â Â Â Â Â Â  return comparisonCount > 0 ? totalScore / comparisonCount : 0;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ£Ğ¼Ğ½Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡ĞµÑ‚ Ğ¿ĞµÑ€ĞµĞºÑ€Ñ‹Ñ‚Ğ¸Ñ Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚ĞµĞ¹ ÑĞ»ĞµĞ´Ğ¾Ğ²
Â Â Â Â  */
Â Â Â  calculateSmartOverlap(bboxA, bboxB, predA, predB) {
Â Â Â Â Â Â Â  // ğŸ“ Ğ’Ğ«Ğ§Ğ˜Ğ¡Ğ›Ğ¯Ğ•Ğœ Ğ‘ĞĞ—ĞĞ’ĞĞ• ĞŸĞ•Ğ Ğ•ĞšĞ Ğ«Ğ¢Ğ˜Ğ•
Â Â Â Â Â Â Â  const overlapX = Math.max(0, Math.min(bboxA.maxX, bboxB.maxX) - Math.max(bboxA.minX, bboxB.minX));
Â Â Â Â Â Â Â  const overlapY = Math.max(0, Math.min(bboxA.maxY, bboxB.maxY) - Math.max(bboxA.minY, bboxB.minY));
Â Â Â Â Â Â Â  const overlapArea = overlapX * overlapY;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const areaA = bboxA.width * bboxA.height;
Â Â Â Â Â Â Â  const areaB = bboxB.width * bboxB.height;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (overlapArea === 0) return 0;

Â Â Â Â Â Â Â  // ğŸ¯ ĞĞ¡ĞĞĞ’ĞĞĞ™ SCORE ĞŸĞ•Ğ Ğ•ĞšĞ Ğ«Ğ¢Ğ˜Ğ¯
Â Â Â Â Â Â Â  const overlapToA = overlapArea / areaA;
Â Â Â Â Â Â Â  const overlapToB = overlapArea / areaB;
Â Â Â Â Â Â Â  let baseScore = Math.min(overlapToA, overlapToB);

Â Â Â Â Â Â Â  // ğŸ”¥ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜ Ğ’ĞĞ–ĞĞ«Ğ• Ğ¡Ğ›Ğ£Ğ§ĞĞ˜:

Â Â Â Â Â Â Â  // 1. ĞœĞ•Ğ›ĞšĞĞ¯ Ğ”Ğ•Ğ¢ĞĞ›Ğ¬ Ğ’ĞĞ£Ğ¢Ğ Ğ˜ ĞšĞ Ğ£ĞŸĞĞĞ™ - Ğ’Ğ«Ğ¡ĞĞšĞĞ¯ Ğ¢ĞĞ§ĞĞĞ¡Ğ¢Ğ¬
Â Â Â Â Â Â Â  // ğŸ”§ Ğ¤Ğ˜ĞšĞ¡: Ğ‘Ğ¾Ğ»ĞµĞµ ÑÑ‚Ñ€Ğ¾Ğ³Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ»Ñ Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ñ… Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹
if (areaB < areaA * 0.1 && overlapToB > 0.9 && predA.class === predB.class) {
    console.log(`ğŸ’ ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ° Ñ‚Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ¼ĞµĞ»ĞºĞ°Ñ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ĞºÑ€ÑƒĞ¿Ğ½Ğ¾Ğ¹!`);
    return 0.95;
}

Â Â Â Â Â Â Â  // 2. Ğ’ĞœĞ¯Ğ¢Ğ˜ĞĞ/ĞĞ¢Ğ¡Ğ£Ğ¢Ğ¡Ğ¢Ğ’Ğ˜Ğ• ĞœĞĞ¢Ğ•Ğ Ğ˜ĞĞ›Ğ - ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ÑƒÑ€
Â Â Â Â Â Â Â  if (this.isNegativeImpression(predA) || this.isNegativeImpression(predB)) {
Â Â Â Â Â Â Â Â Â Â Â  baseScore *= 0.8; // Ğ¡Ğ½Ğ¸Ğ¶Ğ°ĞµĞ¼ Ğ²ĞµÑ Ğ´Ğ»Ñ Ğ²Ğ¼ÑÑ‚Ğ¸Ğ½
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  // 3. Ğ¡Ğ¥ĞĞ–Ğ˜Ğ™ Ğ¢Ğ˜ĞŸ Ğ”Ğ•Ğ¢ĞĞ›Ğ˜ - Ğ±Ğ¾Ğ½ÑƒÑ
Â Â Â Â Â Â Â  if (predA.class === predB.class) {
Â Â Â Â Â Â Â Â Â Â Â  baseScore += 0.15;
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  // 4. Ğ¢ĞĞ§ĞĞ«Ğ• ĞœĞ•Ğ›ĞšĞ˜Ğ• Ğ”Ğ•Ğ¢ĞĞ›Ğ˜ - Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚
Â Â Â Â Â Â Â  if (areaA < 1000 && areaB < 1000 && baseScore > 0.6) {
Â Â Â Â Â Â Â Â Â Â Â  baseScore += 0.25;
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  return Math.min(baseScore, 1.0);
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒ Ğ²Ğ¼ÑÑ‚Ğ¸Ğ½Ğ¾Ğ¹/Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¼ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ğ¾Ğ¼
Â Â Â Â  */
Â Â Â  isNegativeImpression(prediction) {
Â Â Â Â Â Â Â  // ğŸ” ĞŸĞ Ğ˜Ğ—ĞĞĞšĞ˜ Ğ’ĞœĞ¯Ğ¢Ğ˜ĞĞ«/ĞĞ¢Ğ¡Ğ£Ğ¢Ğ¡Ğ¢Ğ’Ğ˜Ğ¯ ĞœĞĞ¢Ğ•Ğ Ğ˜ĞĞ›Ğ:
Â Â Â Â Â Â Â  // - Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ¿Ğ¾Ğ»Ğ¸Ğ³Ğ¾Ğ½
Â Â Â Â Â Â Â  // - ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ğ³ĞµĞ¾Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹Â 
Â Â Â Â Â Â Â  // - ĞœĞ°Ğ»Ğ¾ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ñ… Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹
Â Â Â Â Â Â Â  if (!prediction.points) return false;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const bbox = this.calculateBoundingBox(prediction.points);
Â Â Â Â Â Â Â  const area = bbox.width * bbox.height;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // Ğ‘Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ğ¿Ğ»Ğ¾Ñ‰Ğ°Ğ´ÑŒ + Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ° = Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ°Ñ Ğ²Ğ¼ÑÑ‚Ğ¸Ğ½Ğ°
Â Â Â Â Â Â Â  return area > 5000 && prediction.points.length <= 8;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ bounding box
Â Â Â Â  */
Â Â Â  calculateBoundingBox(points) {
Â Â Â Â Â Â Â  const xs = points.map(p => p.x);
Â Â Â Â Â Â Â  const ys = points.map(p => p.y);
Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â Â Â  minX: Math.min(...xs),
Â Â Â Â Â Â Â Â Â Â Â  maxX: Math.max(...xs),
Â Â Â Â Â Â Â Â Â Â Â  minY: Math.min(...ys),
Â Â Â Â Â Â Â Â Â Â Â  maxY: Math.max(...ys),
Â Â Â Â Â Â Â Â Â Â Â  width: Math.max(...xs) - Math.min(...xs),
Â Â Â Â Â Â Â Â Â Â Â  height: Math.max(...ys) - Math.min(...ys)
Â Â Â Â Â Â Â  };
Â Â Â  }
     
Â Â Â  /**
Â Â Â Â  * ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¸Ğ· Ñ‡Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ²
Â Â Â Â  */
Â Â Â  assembleFullModel(partialPrints, imageWidth, imageHeight) {
Â Â Â Â Â Â Â  if (partialPrints.length < 2) {
Â Â Â Â Â Â Â Â Â Â Â  return { success: false, error: 'ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ² Ğ´Ğ»Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸' };
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ĞšĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²ÑĞµ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¸
Â Â Â Â Â Â Â  const classifiedPrints = partialPrints.map(print => ({
Â Â Â Â Â Â Â Â Â Â Â  ...print,
Â Â Â Â Â Â Â Â Â Â Â  partType: this.classifyFootprintPattern(print.predictions, imageWidth, imageHeight),
Â Â Â Â Â Â Â Â Â Â Â  bbox: this.calculateOverallBoundingBox(print.predictions)
Â Â Â Â Â Â Â  }));
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
Â Â Â Â Â Â Â  const compatibleGroups = this.groupCompatiblePrints(classifiedPrints);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (compatibleGroups.length === 0) {
Â Â Â Â Â Â Â Â Â Â Â  return { success: false, error: 'ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ñ‹Ñ… Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ²' };
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ»ÑƒÑ‡ÑˆÑƒÑ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ
Â Â Â Â Â Â Â  const bestGroup = this.selectBestGroup(compatibleGroups);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ
Â Â Â Â Â Â Â  const assembledModel = this.mergeFootprints(bestGroup);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â Â Â  success: true,
Â Â Â Â Â Â Â Â Â Â Â  model: assembledModel,
Â Â Â Â Â Â Â Â Â Â Â  usedPrints: bestGroup,
Â Â Â Â Â Â Â Â Â Â Â  completeness: this.calculateCompleteness(bestGroup),
Â Â Â Â Â Â Â Â Â Â Â  confidence: this.calculateConfidence(bestGroup)
Â Â Â Â Â Â Â  };
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ñ‹Ğµ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¸
Â Â Â Â  */
Â Â Â  groupCompatiblePrints(classifiedPrints) {
Â Â Â Â Â Â Â  const groups = [];
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  classifiedPrints.forEach(print => {
Â Â Â Â Â Â Â Â Â Â Â  let assigned = false;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  for (let group of groups) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (this.arePrintsCompatible(group, print)) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  group.push(print);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  assigned = true;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  break;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  if (!assigned) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  groups.push([print]);
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return groups.filter(group => group.length >= 2);
Â Â Â  }

/**
Â Â Â Â  * Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ ĞºĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ¼
Â Â Â Â  */
Â Â Â  arePrintsCompatible(group, newPrint) {
Â Â Â Â Â Â Â  console.log(`ğŸ¯ Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸...`);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ”§ Ğ‘Ğ«Ğ¡Ğ¢Ğ ĞĞ¯ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ: ĞµÑĞ»Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ° Ğ¿ÑƒÑÑ‚Ğ°Ñ, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚ÑƒÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ
Â Â Â Â Â Â Â  if (group.length === 0) {
Â Â Â Â Â Â Â Â Â Â Â  return this.simpleCompatibilityCheck(newPrint);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ¯ ĞšĞĞœĞ‘Ğ˜ĞĞ˜Ğ ĞĞ’ĞĞĞĞ«Ğ™ ĞĞĞĞ›Ğ˜Ğ— Ğ”Ğ›Ğ¯ ĞĞ•ĞŸĞ£Ğ¡Ğ¢ĞĞ™ Ğ“Ğ Ğ£ĞŸĞŸĞ«
Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â  // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ¸Ğ· Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ° Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ
Â Â Â Â Â Â Â Â Â Â Â  const firstFootprint = group[0];
Â Â Â Â Â Â Â Â Â Â Â  let imageWidth = 800, imageHeight = 600;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // ĞŸÑ‹Ñ‚Ğ°ĞµĞ¼ÑÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ² Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)
Â Â Â Â Â Â Â Â Â Â Â  if (firstFootprint.features?.imageSize) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  imageWidth = firstFootprint.features.imageSize.width;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  imageHeight = firstFootprint.features.imageSize.height;
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  return this.advancedCompatibilityAnalysis(group, newPrint, imageWidth, imageHeight);
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â  console.log('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ĞºĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´:', error.message);
Â Â Â Â Â Â Â Â Â Â Â  // ğŸ”§ Ğ Ğ•Ğ—Ğ•Ğ Ğ’ĞĞ«Ğ™ ĞœĞ•Ğ¢ĞĞ” Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…
Â Â Â Â Â Â Â Â Â Â Â  return this.fallbackCompatibilityCheck(group, newPrint);
Â Â Â Â Â Â Â  }
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ°
Â Â Â Â  */
Â Â Â  simpleCompatibilityCheck(newPrint) {
Â Â Â Â Â Â Â  // Ğ”Ğ»Ñ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ğ¸
Â Â Â Â Â Â Â  const features = newPrint.features;
Â Â Â Â Â Â Â  return features.detailCount >= 3; // ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 3 Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
Â Â Â Â  */
Â Â Â  fallbackCompatibilityCheck(group, newPrint) {
Â Â Â Â Â Â Â  console.log(`ğŸ”„ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸...`);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾ features
Â Â Â Â Â Â Â  const featureScores = group.map(existing =>
Â Â Â Â Â Â Â Â Â Â Â  this.calculateSimilarity(existing.features, newPrint.features)
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  const avgFeatureScore = featureScores.reduce((a, b) => a + b, 0) / featureScores.length;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return avgFeatureScore > 0.4;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½ (Ğ»ĞµĞ²Ñ‹Ğ¹/Ğ¿Ñ€Ğ°Ğ²Ñ‹Ğ¹)
Â Â Â Â  */
Â Â Â  areSidesCompatible(groupSides, newSide) {
Â Â Â Â Â Â Â  // âŒ Ğ ĞĞ—ĞĞ«Ğ• Ğ¡Ğ¢ĞĞ ĞĞĞ« - ĞĞ• Ğ¡ĞĞ’ĞœĞ•Ğ¡Ğ¢Ğ˜ĞœĞ«
Â Â Â Â Â Â Â  if (groupSides.includes('left') && newSide === 'right') return false;
Â Â Â Â Â Â Â  if (groupSides.includes('right') && newSide === 'left') return false;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // âœ… ĞĞ”Ğ˜ĞĞĞšĞĞ’Ğ«Ğ• Ğ¡Ğ¢ĞĞ ĞĞĞ« Ğ˜Ğ›Ğ˜ UNKNOWN/CENTER - Ğ¡ĞĞ’ĞœĞ•Ğ¡Ğ¢Ğ˜ĞœĞ«
Â Â Â Â Â Â Â  return true;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ñ‚Ğ¸Ğ¿Ğ¾Ğ² ÑƒĞ·Ğ¾Ñ€Ğ¾Ğ²
Â Â Â Â  */
Â Â Â  arePatternTypesCompatible(groupPatterns, newPattern) {
Â Â Â Â Â Â Â  // ğŸ¯ Ğ˜Ğ—Ğ’Ğ›Ğ•ĞšĞĞ•Ğœ ĞĞ¡ĞĞĞ’ĞĞ«Ğ• Ğ¥ĞĞ ĞĞšĞ¢Ğ•Ğ Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ˜ Ğ£Ğ—ĞĞ ĞĞ’
Â Â Â Â Â Â Â  const extractPatternInfo = (pattern) => {
Â Â Â Â Â Â Â Â Â Â Â  const parts = pattern.split('_');
Â Â Â Â Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  size: parts[1] || 'medium',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  density: parts[2] || 'unknown'
Â Â Â Â Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â  };

Â Â Â Â Â Â Â  const newInfo = extractPatternInfo(newPattern);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ”„ ĞŸĞ ĞĞ’Ğ•Ğ Ğ¯Ğ•Ğœ Ğ¡ĞĞ’ĞœĞ•Ğ¡Ğ¢Ğ˜ĞœĞĞ¡Ğ¢Ğ¬ Ğ¡ ĞšĞĞ–Ğ”Ğ«Ğœ Ğ’ Ğ“Ğ Ğ£ĞŸĞŸĞ•
Â Â Â Â Â Â Â  return groupPatterns.some(groupPattern => {
Â Â Â Â Â Â Â Â Â Â Â  const groupInfo = extractPatternInfo(groupPattern);
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // ğŸ“Š Ğ¡ĞĞ’ĞœĞ•Ğ¡Ğ¢Ğ˜ĞœĞ«Ğ• ĞšĞĞœĞ‘Ğ˜ĞĞĞ¦Ğ˜Ğ˜
Â Â Â Â Â Â Â Â Â Â Â  const compatibleSizes = ['small', 'medium', 'large']; // Ğ’ÑĞµ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ñ‹
Â Â Â Â Â Â Â Â Â Â Â  const compatibleDensities = {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  'high_density': ['high_density', 'medium_density'],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  'medium_density': ['high_density', 'medium_density', 'low_density'],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  'low_density': ['medium_density', 'low_density', 'sparse'],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  'sparse': ['low_density', 'sparse']
Â Â Â Â Â Â Â Â Â Â Â  };

Â Â Â Â Â Â Â Â Â Â Â  const sizeOK = compatibleSizes.includes(newInfo.size) && compatibleSizes.includes(groupInfo.size);
Â Â Â Â Â Â Â Â Â Â Â  const densityOK = compatibleDensities[newInfo.density]?.includes(groupInfo.density) ||
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  compatibleDensities[groupInfo.density]?.includes(newInfo.density);

Â Â Â Â Â Â Â Â Â Â Â  return sizeOK && densityOK;
Â Â Â Â Â Â Â  });
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ»ÑƒÑ‡ÑˆÑƒÑ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ Ğ´Ğ»Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸
Â Â Â Â  */
Â Â Â  selectBestGroup(groups) {
Â Â Â Â Â Â Â  return groups.reduce((best, current) => {
Â Â Â Â Â Â Â Â Â Â Â  const bestScore = this.calculateGroupScore(best);
Â Â Â Â Â Â Â Â Â Â Â  const currentScore = this.calculateGroupScore(current);
Â Â Â Â Â Â Â Â Â Â Â  return currentScore > bestScore ? current : best;
Â Â Â Â Â Â Â  });
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ score Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
Â Â Â Â  */
Â Â Â  calculateGroupScore(group) {
Â Â Â Â Â Â Â  const typeDiversity = new Set(group.map(p => p.partType)).size;
Â Â Â Â Â Â Â  const avgConfidence = group.reduce((sum, p) => sum + (p.features?.detailCount || 0), 0) / group.length;
Â Â Â Â Â Â Â  return typeDiversity * avgConfidence;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµÑ‚ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¸ Ğ² Ğ¾Ğ´Ğ½Ñƒ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ
Â Â Â Â  */
Â Â Â  mergeFootprints(prints) {
Â Â Â Â Â Â Â  const mergedPredictions = [];
Â Â Â Â Â Â Â  const mergedFeatures = {
Â Â Â Â Â Â Â Â Â Â Â  detailCount: 0,
Â Â Â Â Â Â Â Â Â Â Â  hasOutline: false,
Â Â Â Â Â Â Â Â Â Â Â  largeDetails: 0,
Â Â Â Â Â Â Â Â Â Â Â  density: 0,
Â Â Â Â Â Â Â Â Â Â Â  spatialSpread: 0
Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  prints.forEach(print => {
Â Â Â Â Â Â Â Â Â Â Â  if (print.predictions) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  mergedPredictions.push(...print.predictions);
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  if (print.features) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  mergedFeatures.detailCount += print.features.detailCount || 0;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  mergedFeatures.hasOutline = mergedFeatures.hasOutline || print.features.hasOutline;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  mergedFeatures.largeDetails += print.features.largeDetails || 0;
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â Â Â  predictions: mergedPredictions,
Â Â Â Â Â Â Â Â Â Â Â  features: mergedFeatures,
Â Â Â Â Â Â Â Â Â Â Â  sourcePrints: prints.map(p => p.id),
Â Â Â Â Â Â Â Â Â Â Â  timestamp: new Date()
Â Â Â Â Â Â Â  };
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ‚Ñƒ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
Â Â Â Â  */
Â Â Â  calculateCompleteness(prints) {
Â Â Â Â Â Â Â  const uniqueTypes = new Set(prints.map(p => p.partType));
Â Â Â Â Â Â Â  const maxPossibleTypes = 4; // full, heel, toe, center
Â Â Â Â Â Â Â  return (uniqueTypes.size / maxPossibleTypes) * 100;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ ÑƒĞ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ Ğ² Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
Â Â Â Â  */
Â Â Â  calculateConfidence(prints) {
Â Â Â Â Â Â Â  const similarities = [];
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  for (let i = 0; i < prints.length; i++) {
Â Â Â Â Â Â Â Â Â Â Â  for (let j = i + 1; j < prints.length; j++) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  similarities.push(this.calculateSimilarity(prints[i].features, prints[j].features));
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const avgSimilarity = similarities.length > 0 ?
Â Â Â Â Â Â Â Â Â Â Â  similarities.reduce((a, b) => a + b) / similarities.length : 0;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return Math.min(avgSimilarity * 100, 100);
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ ÑÑ…Ğ¾Ğ¶ĞµÑÑ‚ÑŒ features
Â Â Â Â  */
Â Â Â  calculateSimilarity(featuresA, featuresB) {
Â Â Â Â Â Â Â  if (!featuresA || !featuresB) return 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const countA = featuresA.detailCount || 0;
Â Â Â Â Â Â Â  const countB = featuresB.detailCount || 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (countA === 0 || countB === 0) return 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const countRatio = Math.min(countA, countB) / Math.max(countA, countB);
Â Â Â Â Â Â Â  const outlineMatch = featuresA.hasOutline === featuresB.hasOutline ? 0.3 : 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return countRatio * 0.7 + outlineMatch;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ "Ğ»ĞµĞ²Ñ‹Ğµ" ÑĞ»ĞµĞ´Ñ‹
Â Â Â Â  */
Â Â Â  filterOutlierFootprints(footprints, similarityThreshold = 0.6) {
Â Â Â Â Â Â Â  if (footprints.length < 3) return footprints;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return footprints.filter((footprint, index, array) => {
Â Â Â Â Â Â Â Â Â Â Â  const similarities = array
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  .filter((_, i) => i !== index)
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  .map(other => this.calculateSimilarity(footprint.features, other.features));
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  if (similarities.length === 0) return true;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  const avgSimilarity = similarities.reduce((a, b) => a + b) / similarities.length;
Â Â Â Â Â Â Â Â Â Â Â  return avgSimilarity >= similarityThreshold;
Â Â Â Â Â Â Â  });
Â Â Â  }

 // ... ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ¼ĞµÑ‚Ğ¾Ğ´Ñ‹ FootprintAssembler ...

Â Â Â  /**
Â Â Â Â  * ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ Ğ³ĞµĞ¾Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ° (Ğ¿Ğ¾Ğ²Ğ¾Ñ€Ğ¾Ñ‚, Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±, ÑĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ)
Â Â Â Â  */
Â Â Â  normalizeFootprintGeometry(predictions, imageWidth, imageHeight) {
Â Â Â Â Â Â Â  if (!predictions || predictions.length === 0) return predictions;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â  // 1. ĞĞĞ¥ĞĞ”Ğ˜Ğœ ĞšĞĞĞ¢Ğ£Ğ  Ğ”Ğ›Ğ¯ ĞĞŸĞ Ğ•Ğ”Ğ•Ğ›Ğ•ĞĞ˜Ğ¯ ĞĞ Ğ˜Ğ•ĞĞ¢ĞĞ¦Ğ˜Ğ˜
Â Â Â Â Â Â Â Â Â Â Â  const outline = predictions.find(pred =>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  pred.class === 'Outline-trail' || pred.class.includes('Outline')
Â Â Â Â Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  if (!outline || !outline.points) return predictions;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // 2. Ğ’Ğ«Ğ§Ğ˜Ğ¡Ğ›Ğ¯Ğ•Ğœ Ğ£Ğ“ĞĞ› ĞŸĞĞ’ĞĞ ĞĞ¢Ğ
Â Â Â Â Â Â Â Â Â Â Â  const angle = this.calculateOrientationAngle(outline.points);
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // 3. Ğ’Ğ«Ğ§Ğ˜Ğ¡Ğ›Ğ¯Ğ•Ğœ Ğ¦Ğ•ĞĞ¢Ğ  ĞœĞĞ¡Ğ¡
Â Â Â Â Â Â Â Â Â Â Â  const bbox = this.calculateOverallBoundingBox(predictions);
Â Â Â Â Â Â Â Â Â Â Â  const center = {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  x: bbox.minX + bbox.width / 2,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  y: bbox.minY + bbox.height / 2
Â Â Â Â Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // 4. Ğ•Ğ¡Ğ›Ğ˜ Ğ£Ğ“ĞĞ› Ğ‘ĞĞ›Ğ¬Ğ¨ĞĞ™ - ĞŸĞĞ’ĞĞ ĞĞ§Ğ˜Ğ’ĞĞ•Ğœ
Â Â Â Â Â Â Â Â Â Â Â  if (Math.abs(angle) > 10) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  console.log("ğŸ”„ ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒÑ Ğ¾Ñ€Ğ¸ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ: Ğ¿Ğ¾Ğ²Ğ¾Ñ€Ğ¾Ñ‚ Ğ½Ğ° ${angle.toFixed(1)}Â°");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return this.rotatePredictions(predictions, center, -angle);
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  return predictions;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â  console.log('âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ¾Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:', error.message);
Â Â Â Â Â Â Â Â Â Â Â  return predictions;
Â Â Â Â Â Â Â  }
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞŸĞ¾Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ²ÑĞµ Ğ¿Ñ€ĞµĞ´ÑĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ Ğ²Ğ¾ĞºÑ€ÑƒĞ³ Ñ†ĞµĞ½Ñ‚Ñ€Ğ°
Â Â Â Â  */
Â Â Â  rotatePredictions(predictions, center, angleDegrees) {
Â Â Â Â Â Â Â  const rad = angleDegrees * (Math.PI / 180);
Â Â Â Â Â Â Â  const cos = Math.cos(rad);
Â Â Â Â Â Â Â  const sin = Math.sin(rad);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return predictions.map(pred => {
Â Â Â Â Â Â Â Â Â Â Â  if (!pred.points) return pred;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ...pred,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  points: pred.points.map(point => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // ĞŸĞ•Ğ Ğ•ĞĞĞ¡Ğ˜Ğœ Ğ’ Ğ¦Ğ•ĞĞ¢Ğ  ĞšĞĞĞ Ğ”Ğ˜ĞĞĞ¢
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const dx = point.x - center.x;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const dy = point.y - center.y;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // ĞŸĞĞ’ĞĞ ĞĞ§Ğ˜Ğ’ĞĞ•Ğœ
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const newX = dx * cos - dy * sin;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const newY = dx * sin + dy * cos;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Ğ’ĞĞ—Ğ’Ğ ĞĞ©ĞĞ•Ğœ ĞĞ ĞœĞ•Ğ¡Ğ¢Ğ
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  x: newX + center.x,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  y: newY + center.y
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  })
Â Â Â Â Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â  });
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ ÑƒĞ³Ğ¾Ğ» Ğ¾Ñ€Ğ¸ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸ ĞºĞ¾Ğ½Ñ‚ÑƒÑ€Ğ°
Â Â Â Â  */
Â Â Â  calculateOrientationAngle(points) {
Â Â Â Â Â Â Â  if (!points || points.length < 3) return 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â  // Ğ’Ğ«Ğ§Ğ˜Ğ¡Ğ›Ğ¯Ğ•Ğœ Ğ¦Ğ•ĞĞ¢Ğ  ĞœĞĞ¡Ğ¡
Â Â Â Â Â Â Â Â Â Â Â  const center = points.reduce((acc, point) => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  acc.x += point.x;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  acc.y += point.y;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return acc;
Â Â Â Â Â Â Â Â Â Â Â  }, { x: 0, y: 0 });
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  center.x /= points.length;
Â Â Â Â Â Â Â Â Â Â Â  center.y /= points.length;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // ĞœĞ•Ğ¢ĞĞ” Ğ“Ğ›ĞĞ’ĞĞ«Ğ¥ ĞšĞĞœĞŸĞĞĞ•ĞĞ¢
Â Â Â Â Â Â Â Â Â Â Â  let xx = 0, yy = 0, xy = 0;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  points.forEach(point => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const dx = point.x - center.x;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const dy = point.y - center.y;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  xx += dx * dx;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  yy += dy * dy;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  xy += dx * dy;
Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  const angle = 0.5 * Math.atan2(2 * xy, xx - yy);
Â Â Â Â Â Â Â Â Â Â Â  return angle * (180 / Math.PI);
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â  return 0;
Â Â Â Â Â Â Â  }
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ Ğ³ĞµĞ¾Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ÑÑ…Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ²
Â Â Â Â  */
Â Â Â  calculateGeometricSimilarity(group, newPrint) {
Â Â Â Â Â Â Â  let totalScore = 0;
Â Â Â Â Â Â Â  let count = 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  group.forEach(existing => {
Â Â Â Â Â Â Â Â Â Â Â  // Ğ¡Ğ ĞĞ’ĞĞ˜Ğ’ĞĞ•Ğœ Ğ ĞĞ—ĞœĞ•Ğ Ğ« Ğ˜ Ğ¤ĞĞ ĞœĞ£
Â Â Â Â Â Â Â Â Â Â Â  const bboxA = this.calculateOverallBoundingBox(existing.predictions);
Â Â Â Â Â Â Â Â Â Â Â  const bboxB = this.calculateOverallBoundingBox(newPrint.predictions);
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ• Ğ¡ĞĞĞ¢ĞĞĞ¨Ğ•ĞĞ˜Ğ¯ Ğ¡Ğ¢ĞĞ ĞĞ
Â Â Â Â Â Â Â Â Â Â Â  const aspectRatioA = bboxA.width / bboxA.height;
Â Â Â Â Â Â Â Â Â Â Â  const aspectRatioB = bboxB.width / bboxB.height;
Â Â Â Â Â Â Â Â Â Â Â  const aspectScore = 1 - Math.abs(aspectRatioA - aspectRatioB) / Math.max(aspectRatioA, aspectRatioB);
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ• ĞŸĞ›ĞĞ©ĞĞ”Ğ•Ğ™ (Ğ»Ğ¾Ğ³Ğ°Ñ€Ğ¸Ñ„Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ´Ğ»Ñ ÑƒÑÑ‚Ğ¾Ğ¹Ñ‡Ğ¸Ğ²Ğ¾ÑÑ‚Ğ¸ Ğº Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ñƒ)
Â Â Â Â Â Â Â Â Â Â Â  const areaA = bboxA.width * bboxA.height;
Â Â Â Â Â Â Â Â Â Â Â  const areaB = bboxB.width * bboxB.height;
Â Â Â Â Â Â Â Â Â Â Â  const areaScore = 1 - Math.abs(Math.log(areaA) - Math.log(areaB)) / 5; // Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  totalScore += (aspectScore + areaScore) / 2;
Â Â Â Â Â Â Â Â Â Â Â  count++;
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return count > 0 ? totalScore / count : 0;
Â Â Â  }

 // =============================================================================
Â Â Â  // ğŸ¯ ĞšĞĞœĞ‘Ğ˜ĞĞ˜Ğ ĞĞ’ĞĞĞĞ«Ğ™ ĞĞĞĞ›Ğ˜Ğ—: Ğ¢ĞĞŸĞĞ›ĞĞ“Ğ˜Ğ¯ + Ğ”Ğ•Ğ¢ĞĞ›Ğ˜ + ĞĞ Ğ˜Ğ•ĞĞ¢ĞĞ¦Ğ˜Ğ¯
Â Â Â  // =============================================================================

Â Â Â  /**
Â Â Â Â  * ĞšĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
Â Â Â Â  */
Â Â Â  advancedCompatibilityAnalysis(group, newPrint, imageWidth, imageHeight) {
Â Â Â Â Â Â Â  console.log(`ğŸ¯ ĞšĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸...`);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const analysisResults = {
Â Â Â Â Â Â Â Â Â Â Â  // ğŸ§© Ğ¢ĞĞŸĞĞ›ĞĞ“Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ™ Ğ£Ğ ĞĞ’Ğ•ĞĞ¬ (ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°)
Â Â Â Â Â Â Â Â Â Â Â  topological: this.analyzeTopologicalCompatibility(group, newPrint, imageWidth, imageHeight),
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // ğŸ” Ğ”Ğ•Ğ¢ĞĞ›Ğ¬ĞĞ«Ğ™ Ğ£Ğ ĞĞ’Ğ•ĞĞ¬ (ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹)
Â Â Â Â Â Â Â Â Â Â Â  detailed: this.analyzeDetailedCompatibility(group, newPrint),
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  // ğŸ§­ ĞĞ Ğ˜Ğ•ĞĞ¢ĞĞ¦Ğ˜ĞĞĞĞ«Ğ™ Ğ£Ğ ĞĞ’Ğ•ĞĞ¬ (Ğ»ĞµĞ²Ñ‹Ğ¹/Ğ¿Ñ€Ğ°Ğ²Ñ‹Ğ¹, Ğ¿Ğ¾Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ñ‹)
Â Â Â Â Â Â Â Â Â Â Â  orientation: this.analyzeOrientationCompatibility(group, newPrint)
Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ“Š ĞĞ”ĞĞŸĞ¢Ğ˜Ğ’ĞĞĞ• Ğ’Ğ—Ğ’Ğ•Ğ¨Ğ˜Ğ’ĞĞĞ˜Ğ• Ğ¡ Ğ£Ğ§Ğ•Ğ¢ĞĞœ RECALL ĞœĞĞ”Ğ•Ğ›Ğ˜
Â Â Â Â Â Â Â  const weights = this.calculateAdaptiveWeights(group, newPrint);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const finalScore = (
Â Â Â Â Â Â Â Â Â Â Â  analysisResults.topological * weights.topological +
Â Â Â Â Â Â Â Â Â Â Â  analysisResults.detailed * weights.detailed +
Â Â Â Â Â Â Â Â Â Â Â  analysisResults.orientation * weights.orientation
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  console.log(`ğŸ¯ ĞšĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:`, {
Â Â Â Â Â Â Â Â Â Â Â  topological: analysisResults.topological.toFixed(3),
Â Â Â Â Â Â Â Â Â Â Â  detailed: analysisResults.detailed.toFixed(3),
Â Â Â Â Â Â Â Â Â Â Â  orientation: analysisResults.orientation.toFixed(3),
Â Â Â Â Â Â Â Â Â Â Â  weights: weights,
Â Â Â Â Â Â Â Â Â Â Â  final: finalScore.toFixed(3)
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return finalScore > 0.4; // ğŸ‘ˆ ĞŸĞĞĞ˜Ğ–Ğ•ĞĞĞ«Ğ™ ĞŸĞĞ ĞĞ“ Ğ˜Ğ—-Ğ—Ğ RECALL
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ñ‚Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
Â Â Â Â  */
Â Â Â  analyzeTopologicalCompatibility(group, newPrint, imageWidth, imageHeight) {
Â Â Â Â Â Â Â  console.log(`ğŸ§© Ğ¢Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸...`);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  let totalCompatibility = 0;
Â Â Â Â Â Â Â  let analysisCount = 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  group.forEach(existing => {
Â Â Â Â Â Â Â Â Â Â Â  const topologyA = this.extractTopologicalFeatures(existing.predictions, imageWidth, imageHeight);
Â Â Â Â Â Â Â Â Â Â Â  const topologyB = this.extractTopologicalFeatures(newPrint.predictions, imageWidth, imageHeight);
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  const topologyScore = this.compareTopologicalFeatures(topologyA, topologyB);
Â Â Â Â Â Â Â Â Â Â Â  totalCompatibility += topologyScore;
Â Â Â Â Â Â Â Â Â Â Â  analysisCount++;
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return analysisCount > 0 ? totalCompatibility / analysisCount : 0;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ Ñ‚Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°ĞºĞ¸
Â Â Â Â  */
Â Â Â  extractTopologicalFeatures(predictions, imageWidth, imageHeight) {
Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â Â Â  quadrantDensity: this.calculateQuadrantDensity(predictions, imageWidth, imageHeight),
Â Â Â Â Â Â Â Â Â Â Â  aspectRatio: this.calculateAspectRatio(predictions),
Â Â Â Â Â Â Â Â Â Â Â  centerOfMass: this.calculateCenterOfMass(predictions),
Â Â Â Â Â Â Â Â Â Â Â  boundaryPoints: this.extractBoundaryPoints(predictions)
Â Â Â Â Â Â Â  };
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹ Ğ¿Ğ¾ ĞºĞ²Ğ°Ğ´Ñ€Ğ°Ğ½Ñ‚Ğ°Ğ¼
Â Â Â Â  */
Â Â Â  calculateQuadrantDensity(predictions, imageWidth, imageHeight) {
Â Â Â Â Â Â Â  const quadrants = { topLeft: 0, topRight: 0, bottomLeft: 0, bottomRight: 0 };
Â Â Â Â Â Â Â  const centerX = imageWidth / 2;
Â Â Â Â Â Â Â  const centerY = imageHeight / 2;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  predictions.forEach(pred => {
Â Â Â Â Â Â Â Â Â Â Â  if (pred.points && pred.points.length > 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const bbox = this.calculateBoundingBox(pred.points);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const center = {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  x: bbox.minX + bbox.width / 2,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  y: bbox.minY + bbox.height / 2
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (center.x < centerX && center.y < centerY) quadrants.topLeft++;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  else if (center.x >= centerX && center.y < centerY) quadrants.topRight++;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  else if (center.x < centerX && center.y >= centerY) quadrants.bottomLeft++;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  else quadrants.bottomRight++;
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return quadrants;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ¡Ğ¾Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½ bounding box
Â Â Â Â  */
Â Â Â  calculateAspectRatio(predictions) {
Â Â Â Â Â Â Â  const bbox = this.calculateOverallBoundingBox(predictions);
Â Â Â Â Â Â Â  return bbox.width / bbox.height;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ¦ĞµĞ½Ñ‚Ñ€ Ğ¼Ğ°ÑÑ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹
Â Â Â Â  */
Â Â Â  calculateCenterOfMass(predictions) {
Â Â Â Â Â Â Â  let totalX = 0, totalY = 0, count = 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  predictions.forEach(pred => {
Â Â Â Â Â Â Â Â Â Â Â  if (pred.points && pred.points.length > 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const bbox = this.calculateBoundingBox(pred.points);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  totalX += bbox.minX + bbox.width / 2;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  totalY += bbox.minY + bbox.height / 2;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  count++;
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return count > 0 ? { x: totalX / count, y: totalY / count } : { x: 0, y: 0 };
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ“Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ñ„Ñ€Ğ°Ğ³Ğ¼ĞµĞ½Ñ‚Ğ°
Â Â Â Â  */
Â Â Â  extractBoundaryPoints(predictions) {
Â Â Â Â Â Â Â  const points = [];
Â Â Â Â Â Â Â  const bbox = this.calculateOverallBoundingBox(predictions);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ĞŸÑ€Ğ¾ÑÑ‚Ñ‹Ğµ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ñ‚Ğ¾Ñ‡ĞºĞ¸
Â Â Â Â Â Â Â  points.push({ x: bbox.minX, y: bbox.minY }); // Ğ»ĞµĞ²Ñ‹Ğ¹ Ğ²ĞµÑ€Ñ…Ğ½Ğ¸Ğ¹
Â Â Â Â Â Â Â  points.push({ x: bbox.maxX, y: bbox.minY }); // Ğ¿Ñ€Ğ°Ğ²Ñ‹Ğ¹ Ğ²ĞµÑ€Ñ…Ğ½Ğ¸Ğ¹Â 
Â Â Â Â Â Â Â  points.push({ x: bbox.minX, y: bbox.maxY }); // Ğ»ĞµĞ²Ñ‹Ğ¹ Ğ½Ğ¸Ğ¶Ğ½Ğ¸Ğ¹
Â Â Â Â Â Â Â  points.push({ x: bbox.maxX, y: bbox.maxY }); // Ğ¿Ñ€Ğ°Ğ²Ñ‹Ğ¹ Ğ½Ğ¸Ğ¶Ğ½Ğ¸Ğ¹
Â Â Â Â Â Â Â  points.push({ x: bbox.minX + bbox.width / 2, y: bbox.minY }); // Ğ²ĞµÑ€Ñ…Ğ½Ğ¸Ğ¹ Ñ†ĞµĞ½Ñ‚Ñ€
Â Â Â Â Â Â Â  points.push({ x: bbox.minX + bbox.width / 2, y: bbox.maxY }); // Ğ½Ğ¸Ğ¶Ğ½Ğ¸Ğ¹ Ñ†ĞµĞ½Ñ‚Ñ€
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return points;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°ĞºĞ¾Ğ²
Â Â Â Â  */
Â Â Â  compareTopologicalFeatures(topologyA, topologyB) {
Â Â Â Â Â Â Â  let totalScore = 0;
Â Â Â Â Â Â Â  let comparisonCount = 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // 1. Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ ĞºĞ²Ğ°Ğ´Ñ€Ğ°Ğ½Ñ‚Ğ°Ğ¼
Â Â Â Â Â Â Â  const quadrantScore = this.compareQuadrantDistribution(topologyA.quadrantDensity, topologyB.quadrantDensity);
Â Â Â Â Â Â Â  totalScore += quadrantScore;
Â Â Â Â Â Â Â  comparisonCount++;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // 2. Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¿Ğ¾Ñ€Ñ†Ğ¸Ğ¹
Â Â Â Â Â Â Â  const aspectScore = 1 - Math.abs(topologyA.aspectRatio - topologyB.aspectRatio) / Math.max(topologyA.aspectRatio, topologyB.aspectRatio);
Â Â Â Â Â Â Â  totalScore += aspectScore;
Â Â Â Â Â Â Â  comparisonCount++;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // 3. Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ½Ñ‚Ñ€Ğ¾Ğ² Ğ¼Ğ°ÑÑ
Â Â Â Â Â Â Â  const centerDistance = Math.sqrt(
Â Â Â Â Â Â Â Â Â Â Â  Math.pow(topologyA.centerOfMass.x - topologyB.centerOfMass.x, 2) +
Â Â Â Â Â Â Â Â Â Â Â  Math.pow(topologyA.centerOfMass.y - topologyB.centerOfMass.y, 2)
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  const centerScore = Math.max(0, 1 - centerDistance / 100); // ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµĞ¼
Â Â Â Â Â Â Â  totalScore += centerScore;
Â Â Â Â Â Â Â  comparisonCount++;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return totalScore / comparisonCount;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ ĞºĞ²Ğ°Ğ´Ñ€Ğ°Ğ½Ñ‚Ğ°Ğ¼
Â Â Â Â  */
Â Â Â  compareQuadrantDistribution(quadrantsA, quadrantsB) {
Â Â Â Â Â Â Â  const totalA = quadrantsA.topLeft + quadrantsA.topRight + quadrantsA.bottomLeft + quadrantsA.bottomRight;
Â Â Â Â Â Â Â  const totalB = quadrantsB.topLeft + quadrantsB.topRight + quadrantsB.bottomLeft + quadrantsB.bottomRight;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (totalA === 0 || totalB === 0) return 0.5;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const ratiosA = {
Â Â Â Â Â Â Â Â Â Â Â  topLeft: quadrantsA.topLeft / totalA,
Â Â Â Â Â Â Â Â Â Â Â  topRight: quadrantsA.topRight / totalA,
Â Â Â Â Â Â Â Â Â Â Â  bottomLeft: quadrantsA.bottomLeft / totalA,
Â Â Â Â Â Â Â Â Â Â Â  bottomRight: quadrantsA.bottomRight / totalA
Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const ratiosB = {
Â Â Â Â Â Â Â Â Â Â Â  topLeft: quadrantsB.topLeft / totalB,
Â Â Â Â Â Â Â Â Â Â Â  topRight: quadrantsB.topRight / totalB,
Â Â Â Â Â Â Â Â Â Â Â  bottomLeft: quadrantsB.bottomLeft / totalB,
Â Â Â Â Â Â Â Â Â Â Â  bottomRight: quadrantsB.bottomRight / totalB
Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const difference = (
Â Â Â Â Â Â Â Â Â Â Â  Math.abs(ratiosA.topLeft - ratiosB.topLeft) +
Â Â Â Â Â Â Â Â Â Â Â  Math.abs(ratiosA.topRight - ratiosB.topRight) +
Â Â Â Â Â Â Â Â Â Â Â  Math.abs(ratiosA.bottomLeft - ratiosB.bottomLeft) +
Â Â Â Â Â Â Â Â Â Â Â  Math.abs(ratiosA.bottomRight - ratiosB.bottomRight)
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return Math.max(0, 1 - difference);
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ ĞºĞ¾Ğ¼Ğ¿ĞµĞ½ÑĞ°Ñ†Ğ¸ĞµĞ¹ recall
Â Â Â Â  */
Â Â Â  analyzeDetailedCompatibility(group, newPrint) {
Â Â Â Â Â Â Â  let totalScore = 0;
Â Â Â Â Â Â Â  let comparisonCount = 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  group.forEach(existing => {
Â Â Â Â Â Â Â Â Â Â Â  // ğŸ”§ ĞšĞĞœĞŸĞ•ĞĞ¡ĞĞ¦Ğ˜Ğ¯ Ğ—Ğ ĞĞ˜Ğ—ĞšĞ˜Ğ™ RECALL - ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²ĞµÑ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ½Ñ‹Ñ… Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹
Â Â Â Â Â Â Â Â Â Â Â  const baseScore = this.advancedPatternComparison(existing.predictions, newPrint.predictions);
Â Â Â Â Â Â Â Â Â Â Â  const compensatedScore = Math.min(baseScore * 1.5, 1.0); // +50% Ğ²ĞµÑ
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  totalScore += compensatedScore;
Â Â Â Â Â Â Â Â Â Â Â  comparisonCount++;
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return comparisonCount > 0 ? totalScore / comparisonCount : 0;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¾Ñ€Ğ¸ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ¾Ğ¹ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
Â Â Â Â  */
Â Â Â  analyzeOrientationCompatibility(group, newPrint) {
Â Â Â Â Â Â Â  console.log(`ğŸ§­ ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¾Ñ€Ğ¸ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ¾Ğ¹ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸...`);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const groupOrientations = group.map(footprint => ({
Â Â Â Â Â Â Â Â Â Â Â  side: footprint.patternType?.split('_')[0] || 'unknown',
Â Â Â Â Â Â Â Â Â Â Â  angle: footprint.orientation?.angle || 0
Â Â Â Â Â Â Â  }));
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const newOrientation = {
Â Â Â Â Â Â Â Â Â Â Â  side: newPrint.patternType?.split('_')[0] || 'unknown',
Â Â Â Â Â Â Â Â Â Â Â  angle: newPrint.orientation?.angle || 0
Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ”§ Ğ“Ğ˜Ğ‘ĞšĞĞ¯ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ Ğ¡Ğ¢ĞĞ ĞĞ
Â Â Â Â Â Â Â  const sideCompatibility = this.assessSideCompatibility(groupOrientations, newOrientation);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ”§ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ Ğ£Ğ“Ğ›ĞĞ’ ĞŸĞĞ’ĞĞ ĞĞ¢Ğ
Â Â Â Â Â Â Â  const angleCompatibility = this.assessAngleCompatibility(groupOrientations, newOrientation);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const orientationScore = (sideCompatibility + angleCompatibility) / 2;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  console.log("ğŸ§­ ĞÑ€Ğ¸ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ°Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ: ${orientationScore.toFixed(3)}");
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return orientationScore;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * Ğ“Ğ¸Ğ±ĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½
Â Â Â Â  */
Â Â Â  assessSideCompatibility(groupOrientations, newOrientation) {
Â Â Â Â Â Â Â  const groupSides = groupOrientations.map(o => o.side);
Â Â Â Â Â Â Â  const newSide = newOrientation.side;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // 1. ĞĞ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ñ‹Ğµ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹ - Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾
Â Â Â Â Â Â Â  if (groupSides.includes(newSide)) return 1.0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // 2. Unknown/center - Ğ½ĞµĞ¹Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ¾
Â Â Â Â Â Â Â  if (newSide === 'unknown' || newSide === 'center') return 0.7;
Â Â Â Â Â Â Â  if (groupSides.includes('unknown') || groupSides.includes('center')) return 0.7;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // 3. Ğ Ğ°Ğ·Ğ½Ñ‹Ğµ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹ - Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ° ÑĞ±Ğ¾Ñ€ĞºĞ° Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ³Ğ¾ ÑĞ»ĞµĞ´Ğ°
Â Â Â Â Â Â Â  if ((groupSides.includes('left') && newSide === 'right') ||
Â Â Â Â Â Â Â Â Â Â Â  (groupSides.includes('right') && newSide === 'left')) {
Â Â Â Â Â Â Â Â Â Â Â  return 0.6;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return 0.3;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑƒĞ³Ğ»Ğ¾Ğ² Ğ¿Ğ¾Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ğ°
Â Â Â Â  */
Â Â Â  assessAngleCompatibility(groupOrientations, newOrientation) {
Â Â Â Â Â Â Â  if (groupOrientations.length === 0) return 0.7;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  let totalAngleScore = 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  groupOrientations.forEach(groupOrientation => {
Â Â Â Â Â Â Â Â Â Â Â  const angleDiff = Math.abs(groupOrientation.angle - newOrientation.angle);
Â Â Â Â Â Â Â Â Â Â Â  const normalizedDiff = Math.min(angleDiff / 45, 1.0); // ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµĞ¼ Ğº 45 Ğ³Ñ€Ğ°Ğ´ÑƒÑĞ°Ğ¼
Â Â Â Â Â Â Â Â Â Â Â  totalAngleScore += 1 - normalizedDiff;
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return totalAngleScore / groupOrientations.length;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğµ Ğ²Ğ·Ğ²ĞµÑˆĞ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ recall Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
Â Â Â Â  */
Â Â Â  calculateAdaptiveWeights(group, newPrint) {
Â Â Â Â Â Â Â  const detailQuality = this.assessDetailQuality(group, newPrint);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ¯ Ğ£Ğ§Ğ˜Ğ¢Ğ«Ğ’ĞĞ•Ğœ RECALL 40% - Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ½Ñ‹Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ½ĞµĞ¿Ğ¾Ğ»Ğ½Ñ‹Ğµ
Â Â Â Â Â Â Â  const effectiveDetailQuality = detailQuality * 0.4;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  let weights = {
Â Â Â Â Â Â Â Â Â Â Â  topological: 0.6,Â  // ğŸ”¥ ĞĞ¡ĞĞĞ’ĞĞĞ™ Ğ’Ğ•Ğ¡ Ğ¢ĞĞŸĞĞ›ĞĞ“Ğ˜Ğ˜
Â Â Â Â Â Â Â Â Â Â Â  detailed: 0.3,Â Â Â Â  // ğŸ”¥ Ğ’Ğ¢ĞĞ ĞĞ¡Ğ¢Ğ•ĞŸĞ•ĞĞĞ«Ğ• Ğ”Ğ•Ğ¢ĞĞ›Ğ˜
Â Â Â Â Â Â Â Â Â Â Â  orientation: 0.1
Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ ĞĞ§Ğ•ĞĞ¬ Ñ‡ĞµÑ‚ĞºĞ¸Ñ… ÑĞ»ĞµĞ´Ğ¾Ğ² ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ²ĞµÑ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹
Â Â Â Â Â Â Â  if (effectiveDetailQuality > 0.6) {
Â Â Â Â Â Â Â Â Â Â Â  weights.topological = 0.3;
Â Â Â Â Â Â Â Â Â Â Â  weights.detailed = 0.6;
Â Â Â Â Â Â Â Â Â Â Â  weights.orientation = 0.1;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  console.log(`âš–ï¸ ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ²ĞµÑĞ° (ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾: ${effectiveDetailQuality.toFixed(3)}):`, weights);
Â Â Â Â Â Â Â  return weights;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞÑ†ĞµĞ½ĞºĞ° ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ ÑĞ»ĞµĞ´Ğ¾Ğ²
Â Â Â Â  */
Â Â Â  assessDetailQuality(group, newPrint) {
Â Â Â Â Â Â Â  let totalQuality = 0;
Â Â Â Â Â Â Â  let count = 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  group.forEach(footprint => {
Â Â Â Â Â Â Â Â Â Â Â  const quality = this.calculateFootprintQuality(footprint);
Â Â Â Â Â Â Â Â Â Â Â  totalQuality += quality;
Â Â Â Â Â Â Â Â Â Â Â  count++;
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  totalQuality += this.calculateFootprintQuality(newPrint);
Â Â Â Â Â Â Â  count++;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return totalQuality / count;
Â Â Â  }

Â Â Â  /**
Â Â Â Â  * ĞÑ†ĞµĞ½ĞºĞ° ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ°
Â Â Â Â  */
Â Â Â  calculateFootprintQuality(footprint) {
Â Â Â Â Â Â Â  const features = footprint.features;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  let qualityScore = 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // 1. ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹
Â Â Â Â Â Â Â  const detailScore = Math.min(features.detailCount / 30, 1.0);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // 2. Ğ Ğ°Ğ·Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ğµ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ¾Ğ²
Â Â Â Â Â Â Â  const sizeDiversity = this.calculateSizeDiversity(footprint.predictions);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // 3. ĞĞ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚ÑƒÑ€Ğ°
Â Â Â Â Â Â Â  const outlineBonus = features.hasOutline ? 0.2 : 0;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  qualityScore = (detailScore * 0.5) + (sizeDiversity * 0.3) + outlineBonus;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return Math.min(qualityScore, 1.0);
Â Â Â    }

Â Â Â  /**
Â Â Â Â  * Ğ Ğ°ÑÑ‡ĞµÑ‚ Ñ€Ğ°Ğ·Ğ½Ğ¾Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ¾Ğ² Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹
Â Â Â Â  */
Â Â Â  calculateSizeDiversity(predictions) {
Â Â Â Â Â Â Â  if (predictions.length < 2) return 0.3;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const areas = predictions
Â Â Â Â Â Â Â Â Â Â Â  .filter(pred => pred.points && pred.points.length > 0)
Â Â Â Â Â Â Â Â Â Â Â  .map(pred => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const bbox = this.calculateBoundingBox(pred.points);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return bbox.width * bbox.height;
Â Â Â Â Â Â Â Â Â Â Â  })
Â Â Â Â Â Â Â Â Â Â Â  .filter(area => area > 0);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (areas.length < 2) return 0.3;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const minArea = Math.min(...areas);
Â Â Â Â Â Â Â  const maxArea = Math.max(...areas);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  return minArea > 0 ? Math.min(maxArea / minArea, 10) / 10 : 0.3;
Â Â Â  }            
    
}
function simplifyPolygon(points, epsilon = 1.0) {
Â Â Â  if (points.length <= 4) return points;

Â Â Â  function douglasPecker(points, epsilon) {
Â Â Â Â Â Â Â  if (points.length <= 2) return points;
Â Â Â Â Â Â Â  let maxDistance = 0;
Â Â Â Â Â Â Â  let index = 0;
Â Â Â Â Â Â Â  const start = points[0];
Â Â Â Â Â Â Â  const end = points[points.length - 1];

Â Â Â Â Â Â Â  for (let i = 1; i < points.length - 1; i++) {
Â Â Â Â Â Â Â Â Â Â Â  const distance = perpendicularDistance(points[i], start, end);
Â Â Â Â Â Â Â Â Â Â Â  if (distance > maxDistance) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  maxDistance = distance;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  index = i;
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  if (maxDistance > epsilon) {
Â Â Â Â Â Â Â Â Â Â Â  const left = douglasPecker(points.slice(0, index + 1), epsilon);
Â Â Â Â Â Â Â Â Â Â Â  const right = douglasPecker(points.slice(index), epsilon);
Â Â Â Â Â Â Â Â Â Â Â  return left.slice(0, -1).concat(right);
Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â  return [start, end];
Â Â Â Â Â Â Â  }
Â Â Â  }

Â Â Â  function perpendicularDistance(point, lineStart, lineEnd) {
Â Â Â Â Â Â Â  const area = Math.abs(
Â Â Â Â Â Â Â Â Â Â Â  (lineEnd.x - lineStart.x) * (lineStart.y - point.y) -
Â Â Â Â Â Â Â Â Â Â Â  (lineStart.x - point.x) * (lineEnd.y - lineStart.y)
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  const lineLength = Math.sqrt(
Â Â Â Â Â Â Â Â Â Â Â  Math.pow(lineEnd.x - lineStart.x, 2) + Math.pow(lineEnd.y - lineStart.y, 2)
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  return area / lineLength;
Â Â Â  }

Â Â Â  return douglasPecker(points, epsilon);
}

/**
* ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ Ğ¾Ñ€Ğ¸ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€ĞµĞ´ÑĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğ¹ (Ğ¿Ğ¾Ğ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ğº Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»Ğ¸)
*/
function normalizeOrientation(predictions) {
Â Â Â  console.log('ğŸ”„ ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒÑ Ğ¾Ñ€Ğ¸ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ ÑĞ»ĞµĞ´Ğ¾Ğ²...');
Â Â Â 
Â Â Â  if (!predictions || predictions.length === 0) {
Â Â Â Â Â Â Â  return predictions;
Â Â Â  }

Â Â Â  try {
Â Â Â Â Â Â Â  // Ğ˜Ğ©Ğ•Ğœ ĞšĞĞĞ¢Ğ£Ğ  Ğ¡Ğ›Ğ•Ğ”Ğ Ğ”Ğ›Ğ¯ ĞĞŸĞ Ğ•Ğ”Ğ•Ğ›Ğ•ĞĞ˜Ğ¯ ĞĞ Ğ˜Ğ•ĞĞ¢ĞĞ¦Ğ˜Ğ˜
Â Â Â Â Â Â Â  const outline = predictions.find(pred =>
Â Â Â Â Â Â Â Â Â Â Â  pred.class === 'Outline-trail' || pred.class.includes('Outline')
Â Â Â Â Â Â Â  );

Â Â Â Â Â Â Â  if (!outline || !outline.points) {
Â Â Â Â Â Â Â Â Â Â Â  console.log('âš ï¸ ĞšĞ¾Ğ½Ñ‚ÑƒÑ€ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½, Ğ¾Ñ€Ğ¸ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ½Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ°');
Â Â Â Â Â Â Â Â Â Â Â  return predictions;
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  // Ğ’Ğ«Ğ§Ğ˜Ğ¡Ğ›Ğ¯Ğ•Ğœ Ğ£Ğ“ĞĞ› ĞŸĞĞ’ĞĞ ĞĞ¢Ğ
Â Â Â Â Â Â Â  const angle = calculateOrientationAngle(outline.points);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // Ğ•Ğ¡Ğ›Ğ˜ Ğ£Ğ“ĞĞ› ĞœĞĞ›Ğ•ĞĞ¬ĞšĞ˜Ğ™ - ĞĞ• ĞŸĞĞ’ĞĞ ĞĞ§Ğ˜Ğ’ĞĞ•Ğœ
Â Â Â Â Â Â Â  if (Math.abs(angle) < 5) {
Â Â Â Â Â Â Â Â Â Â Â  console.log('âœ… Ğ¡Ğ»ĞµĞ´ ÑƒĞ¶Ğµ Ğ¾Ñ€Ğ¸ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ (<5Â°)');
Â Â Â Â Â Â Â Â Â Â Â  return predictions;
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  // Ğ’Ğ«Ğ§Ğ˜Ğ¡Ğ›Ğ¯Ğ•Ğœ Ğ¦Ğ•ĞĞ¢Ğ  ĞšĞĞĞ¢Ğ£Ğ Ğ
Â Â Â Â Â Â Â  const bbox = calculateBoundingBox(outline.points);
Â Â Â Â Â Â Â  const center = {
Â Â Â Â Â Â Â Â Â Â Â  x: bbox.minX + bbox.width / 2,
Â Â Â Â Â Â Â Â Â Â Â  y: bbox.minY + bbox.height / 2
Â Â Â Â Â Â Â  };

Â Â Â Â Â Â Â  // ĞŸĞĞ’ĞĞ ĞĞ§Ğ˜Ğ’ĞĞ•Ğœ Ğ’Ğ¡Ğ• Ğ¢ĞĞ§ĞšĞ˜ Ğ’Ğ¡Ğ•Ğ¥ ĞŸĞ Ğ•Ğ”Ğ¡ĞšĞĞ—ĞĞĞ˜Ğ™
Â Â Â Â Â Â Â  const rad = -angle * (Math.PI / 180); // Ğ¼Ğ¸Ğ½ÑƒÑ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¿ĞµĞ½ÑĞ°Ñ†Ğ¸Ğ¸
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const normalizedPredictions = predictions.map(pred => {
Â Â Â Â Â Â Â Â Â Â Â  if (!pred.points) return pred;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ...pred,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  points: pred.points.map(point => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // ĞŸĞ•Ğ Ğ•ĞĞĞ¡Ğ˜Ğœ Ğ’ Ğ¦Ğ•ĞĞ¢Ğ  ĞšĞĞĞ Ğ”Ğ˜ĞĞĞ¢
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const dx = point.x - center.x;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const dy = point.y - center.y;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // ĞŸĞĞ’ĞĞ ĞĞ§Ğ˜Ğ’ĞĞ•Ğœ
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const newX = dx * Math.cos(rad) - dy * Math.sin(rad);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const newY = dx * Math.sin(rad) + dy * Math.cos(rad);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Ğ’ĞĞ—Ğ’Ğ ĞĞ©ĞĞ•Ğœ ĞĞ ĞœĞ•Ğ¡Ğ¢Ğ
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  x: newX + center.x,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  y: newY + center.y
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  })
Â Â Â Â Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â  });

Â Â Â Â Â Â Â  console.log(`âœ… ĞÑ€Ğ¸ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ°: Ğ¿Ğ¾Ğ²Ğ¾Ñ€Ğ¾Ñ‚ Ğ½Ğ° ${angle.toFixed(1)}Â°`);
Â Â Â Â Â Â Â  return normalizedPredictions;

Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  console.log('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ñ€Ğ¸ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸:', error.message);
Â Â Â Â Â Â Â  return predictions;
Â Â Â  }
}

function getEpsilonForClass(className) {
Â Â Â  switch(className) {
Â Â Â Â Â Â Â  case 'shoe-protector': return 1.5;
Â Â Â Â Â Â Â  case 'Outline-trail': return 0.8;
Â Â Â Â Â Â Â  case 'Heel': return 1.0;
Â Â Â Â Â Â Â  case 'Toe': return 1.0;
Â Â Â Â Â Â Â  default: return 1.2;
Â Â Â  }
}

/**
* Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ ÑĞ¸Ğ¼Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ ĞºĞ¾Ğ½Ñ‚ÑƒÑ€Ğ° ÑĞ»ĞµĞ´Ğ° (ÑƒĞ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ)
*/
function calculateOutlineSymmetry(points) {
Â Â Â  if (!points || points.length < 4) return 1.0;
Â Â Â 
Â Â Â  try {
Â Â Â Â Â Â Â  const bbox = calculateBoundingBox(points);
Â Â Â Â Â Â Â  // Ğ£Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡ĞµÑ‚ ÑĞ¸Ğ¼Ğ¼ĞµÑ‚Ñ€Ğ¸Ğ¸
Â Â Â Â Â Â Â  return 0.8; // Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ¾Ñ†ĞµĞ½ĞºĞ°
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  return 1.0;
Â Â Â  }
}

/**
* ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€Ğ°Ğ²Ğ½Ğ¾Ğ¼ĞµÑ€Ğ½Ğ¾ÑÑ‚ÑŒ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹ (ÑƒĞ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ)
*/
function analyzeDetailDistribution(predictions) {
Â Â Â  const details = predictions.filter(pred =>
Â Â Â Â Â Â Â  pred.class === 'shoe-protector' && pred.points
Â Â Â  );
Â Â Â 
Â Â Â  if (details.length < 3) return 1.0;
Â Â Â 
Â Â Â  try {
Â Â Â Â Â Â Â  // Ğ£Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡ĞµÑ‚ Ñ€Ğ°Ğ²Ğ½Ğ¾Ğ¼ĞµÑ€Ğ½Ğ¾ÑÑ‚Ğ¸
Â Â Â Â Â Â Â  return 0.7; // Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ¾Ñ†ĞµĞ½ĞºĞ°
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  return 1.0;
Â Â Â  }
}

// ğŸ¯ Ğ’Ğ¡ĞŸĞĞœĞĞ“ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜:

function calculatePatternMatch(ref, footprint) {
Â Â Â  // Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ¸ Ñ‚Ğ¸Ğ¿Ğ° Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹
Â Â Â  const baseScore = Math.min(
Â Â Â Â Â Â Â  (footprint.detailCount / Math.max(ref.detailCount, 1)) * 80,
Â Â Â Â Â Â Â  80
Â Â Â  );
Â Â Â  // Ğ‘Ğ¾Ğ½ÑƒÑ Ğ·Ğ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚ÑƒÑ€Ğ°
Â Â Â  const outlineBonus = (footprint.hasOutline && ref.hasOutline) ? 20 : 0;
Â Â Â  return Math.min(baseScore + outlineBonus, 100);
}

function calculateSpatialMatch(ref, footprint) {
Â Â Â  // Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ°Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 3 Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸
Â Â Â  if (ref.detailCount < 3 || footprint.detailCount < 3) return 40;
Â Â Â 
Â Â Â  // Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ»Ğ¾Ñ‚Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹
Â Â Â  const densitySimilarity = Math.min(
Â Â Â Â Â Â Â  footprint.detailCount / Math.max(ref.detailCount, 1),
Â Â Â Â Â Â Â  1
Â Â Â  ) * 60;
Â Â Â 
Â Â Â  return 40 + densitySimilarity; // Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ 40% + Ğ¿Ğ»Ğ¾Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ
}

function calculateDetailMatch(ref, footprint) {
Â Â Â  // Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ ĞºÑ€ÑƒĞ¿Ğ½Ñ‹Ñ… Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹
Â Â Â  const largeDetailsScore = footprint.largeDetails > 0 ?
Â Â Â Â Â Â Â  Math.min((footprint.largeDetails / Math.max(ref.largeDetails, 1)) * 70, 70) : 0;
Â Â Â 
Â Â Â  // Ğ‘Ğ¾Ğ½ÑƒÑ Ğ·Ğ° ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ ÑƒĞ·Ğ¾Ñ€Ğ° (Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¼ĞµĞ»ĞºĞ¸Ñ… Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹)
Â Â Â  const complexityBonus = (footprint.detailCount > 8) ? 30 : 0;
Â Â Â 
Â Â Â  return Math.min(largeDetailsScore + complexityBonus, 100);
}

function calculateShapeMatch(ref, footprint) {
Â Â Â  let score = 50; // Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ÑÑ‡ĞµÑ‚
Â Â Â 
Â Â Â  // Ğ‘Ğ¾Ğ½ÑƒÑÑ‹ Ğ·Ğ° Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ½Ñ‹Ğµ Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸
Â Â Â  if (footprint.hasOutline) score += 30;
Â Â Â  if (footprint.largeDetails > 2) score += 20;
Â Â Â 
Â Â Â  return Math.min(score, 100);
}

// ğŸ”„ Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ˜ Ğ˜Ğ— ĞŸĞ£Ğ‘Ğ›Ğ˜Ğ§ĞĞĞ™ Ğ¡Ğ¡Ğ«Ğ›ĞšĞ˜ Ğ¯ĞĞ”Ğ•ĞšĞ¡.Ğ”Ğ˜Ğ¡ĞšĞ
async function loadStatsFromPublicLink() {
Â Â Â  try {
Â Â Â Â Â Â Â  console.log('ğŸ”„ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Ğ¿Ğ¾ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¹ ÑÑÑ‹Ğ»ĞºĞµ...');

Â Â Â Â Â Â Â  const apiUrl = `https://cloud-api.yandex.net/v1/disk/public/resources/download?public_key=https://disk.yandex.ru/d/vjXtSXW8otwaNg`;

Â Â Â Â Â Â Â  const linkResponse = await withRetry(async () => {
Â Â Â Â Â Â Â Â Â Â Â  return await axios.get(apiUrl, { timeout: 10000 });
Â Â Â Â Â Â Â  }, "ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞº");

Â Â Â Â Â Â Â  console.log('âœ… ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ° ÑÑÑ‹Ğ»ĞºĞ° Ğ´Ğ»Ñ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ');

Â Â Â Â Â Â Â  const fileResponse = await withRetry(async () => {
Â Â Â Â Â Â Â Â Â Â Â  return await axios.get(linkResponse.data.href, {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  timeout: 10000,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  responseType: 'text'
Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  }, "Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸");

Â Â Â Â Â Â Â  console.log('ğŸ“¥ Ğ¤Ğ°Ğ¹Ğ» ÑĞºĞ°Ñ‡Ğ°Ğ½, Ğ´Ğ»Ğ¸Ğ½Ğ°:', fileResponse.data.length);

Â Â Â Â Â Â Â  const remoteStats = JSON.parse(fileResponse.data);

Â Â Â Â Â Â Â  // ğŸ”§ Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ£ ĞĞ Ğ¡Ğ£Ğ©Ğ•Ğ¡Ğ¢Ğ’ĞĞ’ĞĞĞ˜Ğ• ĞœĞ•ĞĞ•Ğ”Ğ–Ğ•Ğ Ğ
Â Â Â Â Â Â Â  if (!getSessionManager()) {
Â Â Â Â Â Â Â Â Â Â Â  console.log('âš ï¸ SessionManager Ğ½Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ², Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸');
Â Â Â Â Â Â Â Â Â Â Â  return false;
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  // ğŸ”§ Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ£ Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ«
Â Â Â Â Â Â Â  if (!remoteStats.global) {
Â Â Â Â Â Â Â Â Â Â Â  throw new Error('ĞĞµĞ²ĞµÑ€Ğ½Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ„Ğ°Ğ¹Ğ»Ğ° ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸');
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  // ğŸ”§ Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ• ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ˜
Â Â Â Â Â Â Â  if (getSessionManager().globalStats) {
Â Â Â Â Â Â Â Â Â Â Â  Object.assign(getSessionManager().globalStats, remoteStats.global);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (getSessionManager().userStats) {
Â Â Â Â Â Â Â Â Â Â Â  getSessionManager().userStats.clear();
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (remoteStats.users && Array.isArray(remoteStats.users)) {
Â Â Â Â Â Â Â Â Â Â Â  remoteStats.users.forEach(([userId, userData]) => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  getSessionManager().userStats.set(userId, userData);
Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  console.log('ğŸ¯ Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ° Ğ¸Ğ· Ğ¾Ğ±Ğ»Ğ°ĞºĞ°');
Â Â Â Â Â Â Â  return true;

Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  console.log('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¿Ğ¾ÑĞ»Ğµ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº:', error.message);
Â Â Â Â Â Â Â  console.log('ğŸ’« ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ ÑĞ¾ ÑĞ²ĞµĞ¶ĞµĞ¹ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸');
Â Â Â Â Â Â Â  return false;
Â Â Â  }
}

// =============================================================================
// ğŸ“± ĞĞ¡ĞĞĞ’ĞĞ«Ğ• ĞšĞĞœĞĞĞ”Ğ« Ğ‘ĞĞ¢Ğ
// =============================================================================

bot.onText(/\/trail_start/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const username = msg.from.username || msg.from.first_name;
Â Â Â 
Â Â Â  console.log(`ğŸ•µï¸â€â™‚ï¸ Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸ Ğ¾Ñ‚ ${username} (chatId: ${chatId})`);
Â Â Â 
Â Â Â  try {
Â Â Â Â Â Â Â  // ğŸ”§ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ¯Ğ•Ğœ: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ³Ğ¾Ñ‚Ğ¾Ğ²
Â Â Â Â Â Â Â  if (!getSessionManager()) {
Â Â Â Â Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.');
Â Â Â Â Â Â Â Â Â Â Â  return;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const session = getSessionManager().getTrailSession(chatId, username);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ”§ ĞŸĞ ĞĞ’Ğ•Ğ Ğ¯Ğ•Ğœ Ñ‡Ñ‚Ğ¾ ÑĞµÑÑĞ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾
Â Â Â Â Â Â Â  if (!session || !session.startTime) {
Â Â Â Â Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°.');
Â Â Â Â Â Â Â Â Â Â Â  return;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  console.log(`âœ… Ğ¡ĞµÑÑĞ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°:`, {
Â Â Â Â Â Â Â Â Â Â Â  sessionId: session.sessionId,
Â Â Â Â Â Â Â Â Â Â Â  status: session.status,
Â Â Â Â Â Â Â Â Â Â Â  footprintsCount: session.footprints.length
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  `ğŸ•µï¸â€â™‚ï¸ **Ğ Ğ•Ğ–Ğ˜Ğœ Ğ¢Ğ ĞĞŸĞ« ĞĞšĞ¢Ğ˜Ğ’Ğ˜Ğ ĞĞ’ĞĞ**\n\n` +
Â Â Â Â Â Â Â Â Â Â Â  `**Ğ¡ĞµÑÑĞ¸Ñ:** ${session.sessionId}\n` +
Â Â Â Â Â Â Â Â Â Â Â  `**Ğ­ĞºÑĞ¿ĞµÑ€Ñ‚:** ${username}\n` +
Â Â Â Â Â Â Â Â Â Â Â  `**Ğ’Ñ€ĞµĞ¼Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°:** ${session.startTime.toLocaleString('ru-RU')}\n\n` +
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  `ğŸ” **Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²ÑĞµ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¸ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸:**\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑŒÑÑ Ğ² Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ ÑĞµÑÑĞ¸Ñ\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞ¾Ğ±Ğ¾Ğ¹\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ½Ğ° ÑÑ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ\n\n` +
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  `ğŸ“¸ **ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞ¹Ñ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ² Ğ¿Ğ¾Ğ´Ğ¾ÑˆĞ²**\n\n` +
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  `**ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ÑĞºÑĞ¿ĞµÑ€Ñ‚Ğ°:**\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ /trail_status - ÑÑ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑÑĞ¸Ğ¸\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ /trail_report - ÑĞºÑĞ¿ĞµÑ€Ñ‚Ğ½Ğ¾Ğµ Ğ·Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ /trail_notes - Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ /trail_finish - Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ ÑĞµÑÑĞ¸Ñ\n\n` +
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  `âš ï¸ *Ğ’ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ¾ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ±Ğ¾Ñ‚Ğ°*`
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â 
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  console.log('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸:', error);
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑĞµÑÑĞ¸Ğ¸. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°.');
Â Â Â  }
});

// =============================================================================
// ğŸ”„ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ¯ Ğ¡Ğ›Ğ•Ğ”ĞĞ’
// =============================================================================

bot.onText(/\/compare$/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â 
Â Â Â  if (sessionManager.referencePrints.size === 0) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  'ğŸ“ **Ğ¡ĞŸĞ˜Ğ¡ĞĞš Ğ­Ğ¢ĞĞ›ĞĞĞĞ’ ĞŸĞ£Ğ¡Ğ¢**\n\n' +
Â Â Â Â Â Â Â Â Â Â Â  'Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚Ğµ ÑÑ‚Ğ°Ğ»Ğ¾Ğ½Ñ‹:\n' +
Â Â Â Â Â Â Â Â Â Â Â  '`/save_reference ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ_ĞœĞ¾Ğ´ĞµĞ»Ğ¸`\n\n' +
Â Â Â Â Â Â Â Â Â Â Â  'Ğ˜Ğ»Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°'
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  return;
Â Â Â  }

Â Â Â  let message = 'ğŸ” **Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ• Ğ¡ Ğ­Ğ¢ĞĞ›ĞĞĞĞœ**\n\n';
Â Â Â  message += 'ğŸ“ **Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ»Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ:**\n';
Â Â Â 
Â Â Â  sessionManager.referencePrints.forEach((ref, modelName) => {
Â Â Â Â Â Â Â  const details = ref.features ? ref.features.detailCount : '?';
Â Â Â Â Â Â Â  message += `â€¢ \`/compare ${modelName}\` (${details} Ğ´ĞµÑ‚.)\n`;
Â Â Â  });
Â Â Â 
Â Â Â  message += '\nğŸ’¡ **Ğ˜Ğ»Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°**';
Â Â Â 
Â Â Â  await bot.sendMessage(chatId, message);
});

bot.onText(/\/compare (.+)/, async (msg, match) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const modelName = match[1].trim();
Â Â Â  const session = sessionManager.getSession(chatId);

Â Â Â  const reference = sessionManager.referencePrints.get(modelName);
Â Â Â  if (!reference) {
Â Â Â Â Â Â Â  let message = `âŒ Ğ­Ñ‚Ğ°Ğ»Ğ¾Ğ½ "${modelName}" Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½\n\n`;
Â Â Â Â Â Â Â  message += 'ğŸ“‹ **Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ÑÑ‚Ğ°Ğ»Ğ¾Ğ½Ñ‹:**\n';
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  sessionManager.referencePrints.forEach((ref, name) => {
Â Â Â Â Â Â Â Â Â Â Â  message += `â€¢ ${name}\n`;
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, message);
Â Â Â Â Â Â Â  return;
Â Â Â  }

Â Â Â  session.waitingForComparison = {
Â Â Â Â Â Â Â  modelName: modelName,
Â Â Â Â Â Â Â  reference: reference
Â Â Â  };
Â Â Â 
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  `ğŸ” Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°Ñ ÑĞ¾ ÑĞ»ĞµĞ´Ğ¾Ğ¼: "${modelName}"\n\n` +
Â Â Â Â Â Â Â  'ğŸ“¸ **ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ ÑĞ»ĞµĞ´Ğ°:**\n' +
Â Â Â Â Â Â Â  'â€¢ Ğ¡Ğ»ĞµĞ´ Ğ½Ğ° Ğ³Ñ€ÑƒĞ½Ñ‚Ğµ/Ğ¿ĞµÑĞºĞµ\n' +
Â Â Â Â Â Â Â  'â€¢ ĞŸÑ€ÑĞ¼Ğ¾Ğ¹ ÑƒĞ³Ğ¾Ğ» ÑÑŠĞµĞ¼ĞºĞ¸\n' +
Â Â Â Â Â Â Â  'â€¢ Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ°Ñ Ñ‡ĞµÑ‚ĞºĞ¾ÑÑ‚ÑŒ\n\n' +
Â Â Â Â Â Â Â  'ğŸ¯ **ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚:**\n' +
Â Â Â Â Â Â Â  'â€¢ ĞšÑ€ÑƒĞ¿Ğ½Ñ‹Ğµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ ÑƒĞ·Ğ¾Ñ€Ğ°\n' +
Â Â Â Â Â Â Â  'â€¢ Ğ Ğ°ÑĞ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹\n' +
Â Â Â Â Â Â Â  'â€¢ Ğ¥Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ½Ñ‹Ğµ Ñ„Ğ¾Ñ€Ğ¼Ñ‹\n\n' +
Â Â Â Â Â Â Â  'âŒ Ğ”Ğ»Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹: /cancel'
Â Â Â  );
});

// =============================================================================
// ğŸ’¾ ĞšĞĞœĞĞĞ”Ğ« Ğ”Ğ›Ğ¯ Ğ ĞĞ‘ĞĞ¢Ğ« Ğ¡ Ğ­Ğ¢ĞĞ›ĞĞĞĞœĞ˜
// =============================================================================

bot.onText(/\/save_reference$/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â 
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  'ğŸ’¾ **Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ• Ğ­Ğ¢ĞĞ›ĞĞĞĞĞ“Ğ ĞĞ¢ĞŸĞ•Ğ§ĞĞ¢ĞšĞ**\n\n' +
Â Â Â Â Â Â Â  'ğŸ“ **Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»:**\n' +
Â Â Â Â Â Â Â  'ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: `/save_reference Nike_Air_Max_90`\n\n' +
Â Â Â Â Â Â Â  'ğŸ’¡ **Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸:**\n' +
Â Â Â Â Â Â Â  'â€¢ Ğ¤Ğ¾Ñ‚Ğ¾ Ñ‡Ğ¸ÑÑ‚Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ¾ÑˆĞ²Ñ‹ ÑĞ²ĞµÑ€Ñ…Ñƒ\n' +
Â Â Â Â Â Â Â  'â€¢ Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞµĞµ Ğ¾ÑĞ²ĞµÑ‰ĞµĞ½Ğ¸Ğµ Ğ±ĞµĞ· Ñ‚ĞµĞ½ĞµĞ¹\n' +
Â Â Â Â Â Â Â  'â€¢ Ğ§ĞµÑ‚ĞºĞ¸Ğ¹ Ñ„Ğ¾ĞºÑƒÑ Ğ½Ğ° Ğ¿Ñ€Ğ¾Ñ‚ĞµĞºÑ‚Ğ¾Ñ€Ğµ\n' +
Â Â Â Â Â Â Â  'â€¢ ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±ĞµĞ· Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ğ¾Ğ² (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ _)\n\n' +
Â Â Â Â Â Â Â  'âŒ Ğ”Ğ»Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹: /cancel'
Â Â Â  );
});

bot.onText(/\/save_reference (.+)/, async (msg, match) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const modelName = match[1].trim();
Â Â Â  const session = sessionManager.getSession(chatId);

Â Â Â  if (modelName.length < 2) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğµ');
Â Â Â Â Â Â Â  return;
Â Â Â  }

Â Â Â  session.waitingForReference = modelName;
Â Â Â 
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  `ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑ ÑÑ‚Ğ°Ğ»Ğ¾Ğ½: "${modelName}"\n\n` +
Â Â Â Â Â Â Â  'ğŸ“¸ **ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¿Ğ¾Ğ´Ğ¾ÑˆĞ²Ñ‹:**\n' +
Â Â Â Â Â Â Â  'â€¢ Ğ§Ğ¸ÑÑ‚Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ¾ÑˆĞ²Ğ°, Ğ²Ğ¸Ğ´ ÑĞ²ĞµÑ€Ñ…Ñƒ\n' +
Â Â Â Â Â Â Â  'â€¢ Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞµĞµ Ğ¾ÑĞ²ĞµÑ‰ĞµĞ½Ğ¸Ğµ\n' +
Â Â Â Â Â Â Â  'â€¢ ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ\n\n' +
Â Â Â Â Â Â Â  'âŒ Ğ”Ğ»Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹: /cancel'
Â Â Â  );
});

bot.onText(/\/list_references/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;

Â Â Â  if (sessionManager.referencePrints.size === 0) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  'ğŸ“ **Ğ¡ĞŸĞ˜Ğ¡ĞĞš Ğ­Ğ¢ĞĞ›ĞĞĞĞ’ ĞŸĞ£Ğ¡Ğ¢**\n\n' +
Â Â Â Â Â Â Â Â Â Â Â  'Ğ”Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ°Ğ»Ğ¾Ğ½Ğ¾Ğ²:\n' +
Â Â Â Â Â Â Â Â Â Â Â  '`/save_reference ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ_ĞœĞ¾Ğ´ĞµĞ»Ğ¸`'
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  return;
Â Â Â  }

Â Â Â  let list = 'ğŸ“ **Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞĞ«Ğ• Ğ­Ğ¢ĞĞ›ĞĞĞ«:**\n\n';
Â Â Â  let counter = 1;

Â Â Â  sessionManager.referencePrints.forEach((ref, modelName) => {
Â Â Â Â Â Â Â  const date = ref.timestamp.toLocaleDateString('ru-RU');
Â Â Â Â Â Â Â  const details = ref.features ? ref.features.detailCount : '?';
Â Â Â Â Â Â Â  list += `${counter}. **${modelName}**\n`;
Â Â Â Â Â Â Â  list += `Â Â  ğŸ“… ${date} | ğŸ”µ ${details} Ğ´ĞµÑ‚.\n\n`;
Â Â Â Â Â Â Â  counter++;
Â Â Â  });

Â Â Â  await bot.sendMessage(chatId, list);
});



bot.onText(/\/cancel/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const session = sessionManager.getSession(chatId);
Â Â Â 
Â Â Â  session.waitingForReference = null;
Â Â Â  session.waitingForComparison = null; // â† Ğ”ĞĞ‘ĞĞ’Ğ¬Ğ¢Ğ• Ğ­Ğ¢Ğ£ Ğ¡Ğ¢Ğ ĞĞšĞ£
Â Â Â 
Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°');
});



// =============================================================================
// ğŸ•µï¸â€â™‚ï¸ ĞšĞĞœĞĞĞ”Ğ« Ğ Ğ•Ğ–Ğ˜ĞœĞ Ğ¢Ğ ĞĞŸĞ«
// =============================================================================
bot.onText(/\/trail_start/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const username = msg.from.username || msg.from.first_name;
Â Â Â 
Â Â Â  console.log(`ğŸ•µï¸â€â™‚ï¸ Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞµÑÑĞ¸Ğ¸ Ğ¾Ñ‚ ${username} (chatId: ${chatId})`);
Â Â Â 
Â Â Â  const session = newSessionManager.getTrailSession(chatId, username);
Â Â Â 
Â Â Â  console.log(`âœ… Ğ¡ĞµÑÑĞ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°:`, {
Â Â Â Â Â Â Â  sessionId: session.sessionId,
Â Â Â Â Â Â Â  status: session.status,
Â Â Â Â Â Â Â  footprintsCount: session.footprints.length
Â Â Â  });
Â Â Â 
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  `ğŸ•µï¸â€â™‚ï¸ **Ğ Ğ•Ğ–Ğ˜Ğœ Ğ¢Ğ ĞĞŸĞ« ĞĞšĞ¢Ğ˜Ğ’Ğ˜Ğ ĞĞ’ĞĞ**\n\n` +
Â Â Â Â Â Â Â  `**Ğ¡ĞµÑÑĞ¸Ñ:** ${session.sessionId}\n` +
Â Â Â Â Â Â Â  `**Ğ­ĞºÑĞ¿ĞµÑ€Ñ‚:** ${username}\n` +
Â Â Â Â Â Â Â  `**Ğ’Ñ€ĞµĞ¼Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°:** ${session.startTime.toLocaleString('ru-RU')}\n\n` +
Â Â Â Â Â Â Â  `ğŸ” **Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²ÑĞµ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¸ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸:**\n` +
Â Â Â Â Â Â Â  `â€¢ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑŒÑÑ Ğ² Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ ÑĞµÑÑĞ¸Ñ\n` +
Â Â Â Â Â Â Â  `â€¢ Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞ¾Ğ±Ğ¾Ğ¹\n` +
Â Â Â Â Â Â Â  `â€¢ ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ½Ğ° ÑÑ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ\n\n` +
Â Â Â Â Â Â Â  `ğŸ“¸ **ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞ¹Ñ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ² Ğ¿Ğ¾Ğ´Ğ¾ÑˆĞ²**\n\n` +
Â Â Â Â Â Â Â  `**ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ÑĞºÑĞ¿ĞµÑ€Ñ‚Ğ°:**\n` +
Â Â Â Â Â Â Â  `â€¢ /trail_status - ÑÑ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑÑĞ¸Ğ¸\n` +
Â Â Â Â Â Â Â  `â€¢ /trail_report - ÑĞºÑĞ¿ĞµÑ€Ñ‚Ğ½Ğ¾Ğµ Ğ·Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ\n` +
Â Â Â Â Â Â Â  `â€¢ /trail_notes - Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸\n` +
Â Â Â Â Â Â Â  `â€¢ /trail_finish - Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ ÑĞµÑÑĞ¸Ñ\n\n` +
Â Â Â Â Â Â Â  `âš ï¸ *Ğ’ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ¾ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ±Ğ¾Ñ‚Ğ°*`
Â Â Â  );
});

bot.onText(/\/help/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  await handleShowHelp(chatId);
});

bot.onText(/\/trail_status/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â 
Â Â Â  // ğŸ”§ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ newSessionManager
Â Â Â  const session = getSessionManager().trailSessions.get(chatId);
Â Â Â 
Â Â Â  if (!session) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  'âŒ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ ÑĞµÑÑĞ¸Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ñ‚Ñ€Ğ¾Ğ¿Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.\n' +
Â Â Â Â Â Â Â Â Â Â Â  'Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /trail_start Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹.'
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  const summary = session.getSessionSummary();
Â Â Â 
Â Â Â  let status = `ğŸ•µï¸â€â™‚ï¸ **Ğ Ğ•Ğ–Ğ˜Ğœ Ğ¢Ğ ĞĞŸĞ« ĞĞšĞ¢Ğ˜Ğ’Ğ˜Ğ ĞĞ’ĞĞ**\n\n`;
Â Â Â  status += `**ID:** ${summary.sessionId}\n`;
Â Â Â  status += `**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** ${summary.status === 'active' ? 'ğŸŸ¢ ĞĞšĞ¢Ğ˜Ğ’ĞĞ' : 'ğŸ”´ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ'}\n`;
Â Â Â  status += `**ĞÑ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ²:** ${summary.footprintsCount}\n`;
Â Â Â  status += `**Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğ¹:** ${summary.comparisonsCount}\n`;
Â Â Â  status += `**Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ ÑÑ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ:** ${summary.averageSimilarity.toFixed(1)}%\n`;
Â Â Â  status += `**Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ:** ${Math.round(summary.duration / 60000)} Ğ¼Ğ¸Ğ½.\n`;
Â Â Â 
Â Â Â  if (session.notes) {
Â Â Â Â Â Â Â  status += `\n**Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ ÑĞºÑĞ¿ĞµÑ€Ñ‚Ğ°:**\n${session.notes}`;
Â Â Â  }
Â Â Â 
Â Â Â  await bot.sendMessage(chatId, status);
});

bot.onText(/\/trail_report/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  // ğŸ”§ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ¯Ğ•Ğœ
Â Â Â  const session = getSessionManager().trailSessions.get(chatId);
Â Â Â 
Â Â Â  if (!session) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸ Ğ´Ğ»Ñ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°.');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  if (session.footprints.length < 2) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  'ğŸ“Š **ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°**\n\n' +
Â Â Â Â Â Â Â Â Â Â Â  'Ğ”Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ ÑĞºÑĞ¿ĞµÑ€Ñ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2 Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ°.\n' +
Â Â Â Â Â Â Â Â Â Â Â  `Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ² ÑĞµÑÑĞ¸Ğ¸: ${session.footprints.length} Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ²`
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  const report = session.generateExpertReport();
Â Â Â  await bot.sendMessage(chatId, report);
});

bot.onText(/\/trail_notes(?:\s+(.+))?/, async (msg, match) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const session = sessionManager.trailSessions.get(chatId);
Â Â Â 
Â Â Â  if (!session) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸ Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¼ĞµÑ‚Ğ¾Ğº.');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  const notesText = match ? match[1] : null;
Â Â Â 
Â Â Â  if (!notesText) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  'ğŸ“ **Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¼ĞµÑ‚Ğ¾Ğº Ğº ÑĞµÑÑĞ¸Ğ¸**\n\n' +
Â Â Â Â Â Â Â Â Â Â Â  'Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: `/expert_notes Ğ’Ğ°Ñˆ Ñ‚ĞµĞºÑÑ‚ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸`\n\n' +
Â Â Â Â Â Â Â Â Â Â Â  'Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸:\n' +
Â Â Â Â Â Â Â Â Â Â Â  (session.notes || 'ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ·Ğ°Ğ¼ĞµÑ‚Ğ¾Ğº')
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  session.notes = notesText;
Â Â Â  await bot.sendMessage(chatId, 'âœ… Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ ÑĞºÑĞ¿ĞµÑ€Ñ‚Ğ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹');
});

bot.onText(/\/trail_finish/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const session = getSessionManager().trailSessions.get(chatId);
Â Â Â 
Â Â Â  if (!session) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸ Ğ´Ğ»Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ.');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  session.status = 'completed';
Â Â Â  const report = session.generateExpertReport();
Â Â Â 
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  `ğŸ”š **Ğ¡Ğ•Ğ¡Ğ¡Ğ˜Ğ¯ ĞĞĞĞ›Ğ˜Ğ—Ğ Ğ¢Ğ ĞĞŸĞ« Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ**\n\n${report}\n\n` +
Â Â Â Â Â Â Â  `ğŸ“ Ğ’ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹ Ğ´Ğ¾ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ±Ğ¾Ñ‚Ğ°.\n` +
Â Â Â Â Â Â Â  `ğŸ”„ Ğ”Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /trail_start`
Â Â Â  );
});

// =============================================================================
// ğŸ¯ ĞĞĞ’Ğ«Ğ• ĞšĞĞœĞĞĞ”Ğ« Ğ”Ğ›Ğ¯ Ğ¡Ğ‘ĞĞ ĞšĞ˜ ĞœĞĞ”Ğ•Ğ›Ğ•Ğ™ Ğ˜ Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ™
// =============================================================================

// ğŸ” ĞšĞĞœĞĞĞ”Ğ Ğ”Ğ•Ğ¢ĞĞ›Ğ¬ĞĞĞ“Ğ Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ¯
bot.onText(/\/compare_footprints (\d+) (\d+)/, async (msg, match) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const footprintIdA = parseInt(match[1]);
Â Â Â  const footprintIdB = parseInt(match[2]);
Â Â Â 
Â Â Â  console.log(`ğŸ” Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ: ${footprintIdA} vs ${footprintIdB}`);
Â Â Â 
Â Â Â  const session = getSessionManager().trailSessions.get(chatId);
Â Â Â  if (!session) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  'âŒ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ ÑĞµÑÑĞ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.\n' +
Â Â Â Â Â Â Â Â Â Â Â  'Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /trail_start Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹.'
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  const footprintA = session.footprints.find(f => f.id === `footprint_${footprintIdA}`);
Â Â Â  const footprintB = session.footprints.find(f => f.id === `footprint_${footprintIdB}`);
Â Â Â 
Â Â Â  if (!footprintA || !footprintB) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  'âŒ ĞĞ´Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ Ğ¾Ğ±Ğ° Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹.\n\n' +
Â Â Â Â Â Â Â Â Â Â Â  'ğŸ“‹ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¸:\n' +
Â Â Â Â Â Â Â Â Â Â Â  session.footprints.map(f => `â€¢ ${f.id.replace('footprint_', '')}: ${f.partType || 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾'}`).join('\n')
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  await bot.sendMessage(chatId, 'ğŸ¨ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ...');
Â Â Â 
Â Â Â  const visualizer = new ComparisonVisualizer();
Â Â Â  const vizPath = await visualizer.createComparisonVisualization(
Â Â Â Â Â Â Â  footprintA,
Â Â Â Â Â Â Â  footprintB,
Â Â Â Â Â Â Â  footprintA.imageUrl
Â Â Â  );
Â Â Â 
Â Â Â  if (vizPath) {
Â Â Â Â Â Â Â  const similarity = visualizer.calculateOverallSimilarity(footprintA, footprintB);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  await bot.sendPhoto(chatId, vizPath, {
Â Â Â Â Â Â Â Â Â Â Â  caption: `ğŸ” **Ğ”Ğ•Ğ¢ĞĞ›Ğ¬ĞĞĞ• Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ•**\n\n` +
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  `ğŸ†” ĞÑ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¸: #${footprintIdA} vs #${footprintIdB}\n` +
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  `ğŸ¯ ĞĞ±Ñ‰ĞµĞµ ÑÑ…Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾: ${similarity.toFixed(1)}%\n` +
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  `ğŸ“Š Ğ¢Ğ¸Ğ¿Ñ‹: ${footprintA.partType || 'Ğ½ĞµĞ¸Ğ·Ğ².'} vs ${footprintB.partType || 'Ğ½ĞµĞ¸Ğ·Ğ².'}\n\n` +
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  `ğŸ’¡ *Ğ—ĞµĞ»ĞµĞ½Ñ‹Ğ¹ = ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ, ĞšÑ€Ğ°ÑĞ½Ñ‹Ğ¹ = Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ¸Ñ, Ğ–ĞµĞ»Ñ‚Ñ‹Ğ¹ = Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ*`
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»
Â Â Â Â Â Â Â  fs.unlinkSync(vizPath);
Â Â Â  } else {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ');
Â Â Â  }
});

// ğŸ§© ĞšĞĞœĞĞĞ”Ğ Ğ¡Ğ‘ĞĞ ĞšĞ˜ ĞœĞĞ”Ğ•Ğ›Ğ˜
bot.onText(/\/assemble_model/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â 
Â Â Â  console.log(`ğŸ§© Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ğ° ${chatId}`);
Â Â Â 
Â Â Â  // ğŸ”§ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ newSessionManager
Â Â Â  const session = getSessionManager().trailSessions.get(chatId);
Â Â Â  if (!session || session.footprints.length < 2) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  'âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ² Ğ´Ğ»Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸.\n\n' +
Â Â Â Â Â Â Â Â Â Â Â  'Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2 Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ°.\n' +
Â Â Â Â Â Â Â Â Â Â Â  `Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ² ÑĞµÑÑĞ¸Ğ¸: ${session ? session.footprints.length : 0} Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ²`
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  'ğŸ§© ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºÑƒ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¸Ğ· Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ñ‡Ğ°ÑÑ‚ĞµĞ¹...\n' +
Â Â Â Â Â Â Â  'ğŸ“Š ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒÑ Ğ³ĞµĞ¾Ğ¼ĞµÑ‚Ñ€Ğ¸Ñ Ğ¸ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ...'
Â Â Â  );
Â Â Â 
Â Â Â  // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°
Â Â Â  let imageWidth = 800, imageHeight = 600; // Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
Â Â Â  try {
Â Â Â Â Â Â Â  const firstFootprint = session.footprints[0];
Â Â Â Â Â Â Â  const image = await loadImage(firstFootprint.imageUrl);
Â Â Â Â Â Â Â  imageWidth = image.width;
Â Â Â Â Â Â Â  imageHeight = image.height;
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  console.log('âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ');
Â Â Â  }
Â Â Â 
Â Â Â  const result = session.assembleModelFromParts(imageWidth, imageHeight);
Â Â Â 
Â Â Â  if (result.success) {
Â Â Â Â Â Â Â  const partsStats = session.getPartsStatistics();
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  let message = `ğŸ§© **ĞœĞĞ”Ğ•Ğ›Ğ¬ Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ Ğ¡ĞĞ‘Ğ ĞĞĞ!**\n\n`;
Â Â Â Â Â Â Â  message += `ğŸ“Š **Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ²:** ${result.usedPrints.length}\n`;
Â Â Â Â Â Â Â  message += `ğŸ¯ **ĞŸĞ¾Ğ»Ğ½Ğ¾Ñ‚Ğ° Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸:** ${result.completeness}%\n`;
Â Â Â Â Â Â Â  message += `âœ… **Ğ£Ğ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ:** ${result.confidence}%\n\n`;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  message += `ğŸ“‹ **Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ñ‡Ğ°ÑÑ‚ĞµĞ¹:**\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ›ĞµĞ²Ñ‹Ğµ: ${partsStats.left_small + partsStats.left_medium + partsStats.left_large}\n`;
Â Â Â Â Â Â Â  message += `â€¢ ĞŸÑ€Ğ°Ğ²Ñ‹Ğµ: ${partsStats.right_small + partsStats.right_medium + partsStats.right_large}\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ: ${partsStats.center_small + partsStats.center_medium + partsStats.center_large}\n`;
Â Â Â Â Â Â Â  message += `â€¢ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğµ: ${partsStats.unknown}\n\n`;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  message += `ğŸ’¾ **Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ°Ğº ÑÑ‚Ğ°Ğ»Ğ¾Ğ½:**\n`;
Â Â Â Â Â Â Â  message += '`/save_assembled "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ_ĞœĞ¾Ğ´ĞµĞ»Ğ¸"`\n\n';
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  message += `ğŸ” **ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹:** /show_groups`;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, message);
Â Â Â  } else {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  `âŒ **Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ°ÑÑŒ**\n\n` +
Â Â Â Â Â Â Â Â Â Â Â  `ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: ${result.error}\n\n` +
Â Â Â Â Â Â Â Â Â Â Â  `ğŸ’¡ **Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸:**\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ²\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ Ğ² ÑÑ…Ğ¾Ğ¶ĞµÑÑ‚Ğ¸ ÑĞ»ĞµĞ´Ğ¾Ğ²\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /compare_footprints Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸`
Â Â Â Â Â Â Â  );
Â Â Â  }
});

// ğŸ¨ Ğ”ĞĞ‘ĞĞ’Ğ˜Ğ¢Ğ¬ ĞŸĞ Ğ¯ĞœĞ£Ğ® ĞšĞĞœĞĞĞ”Ğ£ Ğ’Ğ˜Ğ—Ğ£ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜
bot.onText(/\/visualize_results/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â 
Â Â Â  // ğŸ”§ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ newSessionManager
Â Â Â  const session = getSessionManager().trailSessions.get(chatId);
Â Â Â  if (!session) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ñ‚Ñ€Ğ¾Ğ¿Ñ‹');
Â Â Â Â Â Â Â  return;
Â Â Â  }

Â Â Â  if (session.assembledModels.length === 0) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  'âŒ ĞĞµÑ‚ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸\n\n' +
Â Â Â Â Â Â Â Â Â Â Â  'Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ÑĞ¾Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹:\n' +
Â Â Â Â Â Â Â Â Â Â Â  '`/assemble_model`'
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  return;
Â Â Â  }

Â Â Â  await visualizationHandler.handleVisualizeResults({ chatId });
});

// ğŸ’¾ ĞšĞĞœĞĞĞ”Ğ Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ¯ Ğ¡ĞĞ‘Ğ ĞĞĞĞĞ™ ĞœĞĞ”Ğ•Ğ›Ğ˜
bot.onText(/\/save_assembled (.+)/, async (msg, match) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const modelName = match[1].trim();
Â Â Â 
Â Â Â  console.log(`ğŸ’¾ Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸: "${modelName}"`);
Â Â Â 
Â Â Â  const session = getSessionManager().trailSessions.get(chatId);
Â Â Â  if (!session || session.assembledModels.length === 0) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  'âŒ ĞĞµÑ‚ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ.\n' +
Â Â Â Â Â Â Â Â Â Â Â  'Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /assemble_model'
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  // Ğ‘ĞµÑ€ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ÑÑ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½ÑƒÑ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ
Â Â Â  const lastModel = session.assembledModels[session.assembledModels.length - 1];
Â Â Â 
Â Â Â  // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ĞºĞ°Ğº ÑÑ‚Ğ°Ğ»Ğ¾Ğ½
Â Â Â  sessionManager.referencePrints.set(modelName, {
Â Â Â Â Â Â Â  features: lastModel.model.features,
Â Â Â Â Â Â Â  imageUrl: lastModel.model.sourcePrints[0] ?
Â Â Â Â Â Â Â Â Â Â Â  session.footprints.find(f => f.id === lastModel.model.sourcePrints[0])?.imageUrl : '',
Â Â Â Â Â Â Â  timestamp: new Date(),
Â Â Â Â Â Â Â  predictions: lastModel.model.predictions,
Â Â Â Â Â Â Â  isAssembled: true,
Â Â Â Â Â Â Â  sourcePrints: lastModel.model.sourcePrints,
Â Â Â Â Â Â Â  completeness: lastModel.completeness,
Â Â Â Â Â Â Â  confidence: lastModel.confidence
Â Â Â  });
Â Â Â 
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  `âœ… **Ğ¡ĞĞ‘Ğ ĞĞĞĞĞ¯ ĞœĞĞ”Ğ•Ğ›Ğ¬ Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ**\n\n` +
Â Â Â Â Â Â Â  `ğŸ·ï¸ **ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ:** "${modelName}"\n` +
Â Â Â Â Â Â Â  `ğŸ“Š **Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº:** ${lastModel.model.sourcePrints.length} Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ²\n` +
Â Â Â Â Â Â Â  `ğŸ¯ **ĞŸĞ¾Ğ»Ğ½Ğ¾Ñ‚Ğ°:** ${lastModel.completeness}%\n` +
Â Â Â Â Â Â Â  `âœ… **Ğ£Ğ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ:** ${lastModel.confidence}%\n\n` +
Â Â Â Â Â Â Â  `ğŸ’¡ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ: \`/compare ${modelName}\` Ğ´Ğ»Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ`
Â Â Â  );
Â Â Â 
Â Â Â  // ĞĞ²Ñ‚Ğ¾ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
Â Â Â  const dataManager = new DataPersistence();
Â Â Â  await dataManager.saveAllData();
});

// ğŸ”§ ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞĞĞ¯ ĞšĞĞœĞĞĞ”Ğ ĞŸĞĞšĞĞ—Ğ Ğ“Ğ Ğ£ĞŸĞŸ
bot.onText(/\/show_groups/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  // ğŸ”§ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ¯Ğ•Ğœ
Â Â Â  const session = getSessionManager().trailSessions.get(chatId);
Â Â Â 
Â Â Â  if (!session) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ ÑĞµÑÑĞ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  session.updateCompatibilityGroups();
Â Â Â 
Â Â Â  if (session.compatibilityGroups.length === 0) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ Ğ“Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ½Ğµ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ñ‹. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ ÑĞ»ĞµĞ´Ğ¾Ğ².');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  let message = `ğŸ•µï¸â€â™‚ï¸ **ĞĞĞĞ›Ğ˜Ğ— Ğ¢Ğ ĞĞŸĞ«: ĞĞ‘ĞĞĞ Ğ£Ğ–Ğ•ĞĞĞ«Ğ• Ğ›Ğ®Ğ”Ğ˜**\n\n`;
Â Â Â  message += `Ğ’ÑĞµĞ³Ğ¾ ÑĞ»ĞµĞ´Ğ¾Ğ²: ${session.footprints.length}\n`;
Â Â Â  message += `ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ğ»ÑĞ´ĞµĞ¹: ${session.compatibilityGroups.length}\n\n`;
Â Â Â 
Â Â Â  session.compatibilityGroups.forEach((group, index) => {
Â Â Â Â Â Â Â  message += `**ğŸ‘¤ Ğ§Ğ•Ğ›ĞĞ’Ğ•Ğš ${index + 1}** (${group.length} ÑĞ»ĞµĞ´Ğ¾Ğ²):\n`;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const groupAnalysis = analyzeGroupCharacteristics(group);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  message += `â€¢ ğŸ¯ Ğ£Ğ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ: ${groupAnalysis.confidence}%\n`;
Â Â Â Â Â Â Â  message += `â€¢ ğŸ‘£ ĞŸÑ€ĞµĞ¾Ğ±Ğ»Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹ Ñ‚Ğ¸Ğ¿: ${groupAnalysis.dominantPattern}\n`;
Â Â Â Â Â Â Â  message += `â€¢ ğŸ“ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€: ${groupAnalysis.avgSize}\n`;
Â Â Â Â Â Â Â  message += `â€¢ ğŸ” Ğ¡Ğ»ĞµĞ´Ñ‹: ${group.map(f => f.id.replace('footprint_', '#')).join(', ')}\n\n`;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  message += `ğŸ’¡ *Ğ”Ğ»Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸:* /assemble_from_group ${index + 1}\n\n`;
Â Â Â  });
Â Â Â 
Â Â Â  await bot.sendMessage(chatId, message);
});

// ğŸ†• ĞšĞĞœĞĞĞ”Ğ Ğ”Ğ›Ğ¯ Ğ¡Ğ‘ĞĞ ĞšĞ˜ ĞšĞĞĞšĞ Ğ•Ğ¢ĞĞĞ™ Ğ“Ğ Ğ£ĞŸĞŸĞ«
bot.onText(/\/assemble_from_group (\d+)/, async (msg, match) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const groupNumber = parseInt(match[1]) - 1;
Â Â Â  const session = getSessionManager().trailSessions.get(chatId);
Â Â Â 
Â Â Â  if (!session) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ ÑĞµÑÑĞ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  session.updateCompatibilityGroups();
Â Â Â 
Â Â Â  if (groupNumber < 0 || groupNumber >= session.compatibilityGroups.length) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  `âŒ Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ° â„–${groupNumber + 1} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°. Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹: 1-${session.compatibilityGroups.length}`
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  const group = session.compatibilityGroups[groupNumber];
Â Â Â 
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  `ğŸ§© Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ´Ğ»Ñ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ° ${groupNumber + 1}...\n` +
Â Â Â Â Â Â Â  `ğŸ“Š Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ ${group.length} ÑĞ»ĞµĞ´Ğ¾Ğ²`
Â Â Â  );
Â Â Â 
Â Â Â  // ğŸ”§ Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ•Ğœ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ¡Ğ›Ğ•Ğ”Ğ« Ğ˜Ğ— Ğ’Ğ«Ğ‘Ğ ĞĞĞĞĞ™ Ğ“Ğ Ğ£ĞŸĞŸĞ«
Â Â Â  let imageWidth = 800, imageHeight = 600;
Â Â Â  if (group[0].features?.imageSize) {
Â Â Â Â Â Â Â  imageWidth = group[0].features.imageSize.width;
Â Â Â Â Â Â Â  imageHeight = group[0].features.imageSize.height;
Â Â Â  }
Â Â Â 
Â Â Â  const result = session.assembleModelFromGroup(group, imageWidth, imageHeight);
Â Â Â 
Â Â Â  if (result.success) {
Â Â Â Â Â Â Â  let message = `ğŸ‘¤ **ĞœĞĞ”Ğ•Ğ›Ğ¬ Ğ§Ğ•Ğ›ĞĞ’Ğ•ĞšĞ ${groupNumber + 1}**\n\n`;
Â Â Â Â Â Â Â  message += `ğŸ“Š Ğ¡Ğ»ĞµĞ´Ğ¾Ğ² Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¾: ${result.usedPrints.length}\n`;
Â Â Â Â Â Â Â  message += `ğŸ¯ ĞŸĞ¾Ğ»Ğ½Ğ¾Ñ‚Ğ° Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸: ${result.completeness}%\n`;
Â Â Â Â Â Â Â  message += `âœ… Ğ£Ğ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ: ${result.confidence}%\n\n`;
Â Â Â Â Â Â Â  message += `ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ°Ğº: /save_assembled Ğ§ĞµĞ»Ğ¾Ğ²ĞµĞº_${groupNumber + 1}\n\n`;
Â Â Â Â Â Â Â  message += `ğŸ” ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸: /debug_group ${groupNumber + 1}`;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, message);
Â Â Â  } else {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, `âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ: ${result.error}`);
Â Â Â  }
});

/**
* Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ¸ÑÑ‚Ğ¸Ğº Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
*/
function analyzeGroupCharacteristics(group) {
Â Â Â  if (group.length === 0) {
Â Â Â Â Â Â Â  return { confidence: 0, dominantPattern: 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾', avgSize: 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾' };
Â Â Â  }
Â Â Â 
Â Â Â  // ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ñ€ĞµĞ¾Ğ±Ğ»Ğ°Ğ´Ğ°ÑÑ‰ĞµĞ³Ğ¾ Ñ‚Ğ¸Ğ¿Ğ° ÑƒĞ·Ğ¾Ñ€Ğ°
Â Â Â  const patternCounts = {};
Â Â Â  group.forEach(footprint => {
Â Â Â Â Â Â Â  const pattern = footprint.patternType || 'unknown';
Â Â Â Â Â Â Â  patternCounts[pattern] = (patternCounts[pattern] || 0) + 1;
Â Â Â  });
Â Â Â 
Â Â Â  const dominantPattern = Object.entries(patternCounts)
Â Â Â Â Â Â Â  .sort((a, b) => b[1] - a[1])[0][0];
Â Â Â 
Â Â Â  // Ğ Ğ°ÑÑ‡ĞµÑ‚ ÑƒĞ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ (Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ğ° - Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ»ÑƒÑ‡ÑˆĞ¸Ñ‚ÑŒ)
Â Â Â  const confidence = Math.min((group.length / 3) * 100, 100);
Â Â Â 
Â Â Â  // Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ "Ñ€Ğ°Ğ·Ğ¼ĞµÑ€" Ğ¿Ğ¾ Ğ´ĞµÑ‚Ğ°Ğ»ÑĞ¼
Â Â Â  const avgDetails = group.reduce((sum, f) => sum + (f.features?.detailCount || 0), 0) / group.length;
Â Â Â  const avgSize = avgDetails > 20 ? 'ĞºÑ€ÑƒĞ¿Ğ½Ñ‹Ğ¹' : avgDetails > 10 ? 'ÑÑ€ĞµĞ´Ğ½Ğ¸Ğ¹' : 'Ğ¼ĞµĞ»ĞºĞ¸Ğ¹';
Â Â Â 
Â Â Â  return {
Â Â Â Â Â Â Â  confidence: Math.round(confidence),
Â Â Â Â Â Â Â  dominantPattern: dominantPattern.split('_')[0] || 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾',
Â Â Â Â Â Â Â  avgSize: avgSize
Â Â Â  };
}

// ğŸ’¾ ĞšĞĞœĞĞĞ”Ğ Ğ Ğ£Ğ§ĞĞĞ“Ğ Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ¯
bot.onText(/\/save_data/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â 
Â Â Â  await bot.sendMessage(chatId, 'ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑ Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ...');
Â Â Â 
Â Â Â  const dataManager = new DataPersistence();
Â Â Â  await dataManager.saveAllData();
Â Â Â 
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  'âœ… **Ğ’ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹!**\n\n' +
Â Â Â Â Â Â Â  'ğŸ“Š Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾:\n' +
Â Â Â Â Â Â Â  `â€¢ Ğ¡ĞµÑÑĞ¸Ğ¸: ${sessionManager.trailSessions.size}\n` +
Â Â Â Â Â Â Â  `â€¢ Ğ­Ñ‚Ğ°Ğ»Ğ¾Ğ½Ñ‹: ${sessionManager.referencePrints.size}\n` +
Â Â Â Â Â Â Â  `â€¢ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸: ${sessionManager.userStats.size}\n\n` +
Â Â Â Â Â Â Â  'ğŸ’¡ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°'
Â Â Â  );
});

// ğŸ“ˆ ĞšĞĞœĞĞĞ”Ğ Ğ ĞĞ¡Ğ¨Ğ˜Ğ Ğ•ĞĞĞĞ™ Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ˜
bot.onText(/\/detailed_stats/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â 
Â Â Â  const session = sessionManager.trailSessions.get(chatId);
Â Â Â  if (!session) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ ÑĞµÑÑĞ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  const report = session.generateEnhancedReport();
Â Â Â  await bot.sendMessage(chatId, report);
});

// ğŸ”§ ĞšĞĞœĞĞĞ”Ğ Ğ”Ğ›Ğ¯ Ğ”Ğ•Ğ¢ĞĞ›Ğ¬ĞĞĞ“Ğ ĞĞĞĞ›Ğ˜Ğ—Ğ Ğ£Ğ—ĞĞ ĞĞ’
bot.onText(/\/debug_patterns/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const session = sessionManager.trailSessions.get(chatId);
Â Â Â 
Â Â Â  if (!session || session.footprints.length === 0) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞµÑ‚ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ² Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  let message = `ğŸ”¬ **Ğ”Ğ•Ğ¢ĞĞ›Ğ¬ĞĞ«Ğ™ ĞĞĞĞ›Ğ˜Ğ— Ğ£Ğ—ĞĞ ĞĞ’ ĞŸĞ ĞĞ¢Ğ•ĞšĞ¢ĞĞ Ğ**\n\n`;
Â Â Â 
Â Â Â  session.footprints.forEach((footprint, index) => {
Â Â Â Â Â Â Â  message += `ğŸ‘£ **ĞÑ‚Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ¾Ğº #${index + 1}:**\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ¢Ğ¸Ğ¿: ${footprint.patternType || 'Ğ½Ğµ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½'}\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸: ${footprint.features?.detailCount || 0}\n`;
Â Â Â Â Â Â Â  message += `â€¢ ĞšÑ€ÑƒĞ¿Ğ½Ñ‹Ğµ: ${footprint.features?.largeDetails || 0}\n`;
Â Â Â Â Â Â Â  message += `â€¢ ĞŸĞ»Ğ¾Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ: ${footprint.features?.density?.toFixed(2) || '?'}\n\n`;
Â Â Â  });
Â Â Â 
Â Â Â  // ğŸ” ĞĞĞĞ›Ğ˜Ğ— Ğ¡ĞĞ’ĞœĞ•Ğ¡Ğ¢Ğ˜ĞœĞĞ¡Ğ¢Ğ˜ ĞœĞ•Ğ–Ğ”Ğ£ Ğ’Ğ¡Ğ•ĞœĞ˜ ĞŸĞĞ ĞĞœĞ˜
Â Â Â  if (session.footprints.length >= 2) {
Â Â Â Â Â Â Â  message += `ğŸ”„ **ĞĞĞĞ›Ğ˜Ğ— Ğ¡ĞĞ’ĞœĞ•Ğ¡Ğ¢Ğ˜ĞœĞĞ¡Ğ¢Ğ˜:**\n`;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  for (let i = 0; i < session.footprints.length; i++) {
Â Â Â Â Â Â Â Â Â Â Â  for (let j = i + 1; j < session.footprints.length; j++) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const score = footprintAssembler.advancedPatternComparison(
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  session.footprints[i].predictions,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  session.footprints[j].predictions
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  message += `#${i+1}â†”#${j+1}: ${score.toFixed(3)}\n`;
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }
Â Â Â  }
Â Â Â 
Â Â Â  await bot.sendMessage(chatId, message);
});

// ğŸ”§ ĞšĞĞœĞĞĞ”Ğ« Ğ”Ğ›Ğ¯ Ğ¢Ğ•Ğ¡Ğ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯ Ğ˜ ĞĞ¢Ğ›ĞĞ”ĞšĞ˜

// Ğ¢ĞµÑÑ‚ ĞºĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ñ‡Ğ°ÑÑ‚ĞµĞ¹
bot.onText(/\/test_classify/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const session = sessionManager.trailSessions.get(chatId);
Â Â Â 
Â Â Â  if (!session || session.footprints.length === 0) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞµÑ‚ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ² Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  let message = `ğŸ§ª **Ğ¢Ğ•Ğ¡Ğ¢ ĞšĞ›ĞĞ¡Ğ¡Ğ˜Ğ¤Ğ˜ĞšĞĞ¦Ğ˜Ğ˜ Ğ§ĞĞ¡Ğ¢Ğ•Ğ™**\n\n`;
Â Â Â 
Â Â Â  session.footprints.forEach((footprint, index) => {
Â Â Â Â Â Â Â  const partType = footprint.partType || 'Ğ½Ğµ ĞºĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½';
Â Â Â Â Â Â Â  const potential = footprint.assemblyPotential || 0;
Â Â Â Â Â Â Â  message += `ğŸ“¸ ĞÑ‚Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ¾Ğº ${index + 1}: ${partType} (Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»: ${potential}%)\n`;
Â Â Â  });
Â Â Â 
Â Â Â  await bot.sendMessage(chatId, message);
});

// Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ¸ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ)
bot.onText(/\/debug_reset/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â 
Â Â Â  sessionManager.trailSessions.delete(chatId);
Â Â Â  const session = sessionManager.getTrailSession(chatId, msg.from.username || msg.from.first_name);
Â Â Â 
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  'ğŸ”„ **Ğ¡Ğ‘Ğ ĞĞ¡ Ğ¡Ğ•Ğ¡Ğ¡Ğ˜Ğ˜ Ğ”Ğ›Ğ¯ Ğ¢Ğ•Ğ¡Ğ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯**\n\n' +
Â Â Â Â Â Â Â  'Ğ¡ĞµÑÑĞ¸Ñ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ° Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾.\n' +
Â Â Â Â Â Â Â  'ĞœĞ¾Ğ¶ĞµÑ‚Ğµ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹ ÑĞ±Ğ¾Ñ€ĞºĞ¸.'
Â Â Â  );
});

// ğŸ”§ ĞšĞĞœĞĞĞ”Ğ Ğ”Ğ›Ğ¯ Ğ¢Ğ•Ğ¡Ğ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯ Ğ“Ğ•ĞĞœĞ•Ğ¢Ğ Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ™ ĞĞĞ ĞœĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜
bot.onText(/\/test_geometry/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const session = sessionManager.trailSessions.get(chatId);
Â Â Â 
Â Â Â  if (!session || session.footprints.length === 0) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞµÑ‚ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ² Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ³ĞµĞ¾Ğ¼ĞµÑ‚Ñ€Ğ¸Ğ¸');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  let message = `ğŸ“ **Ğ¢Ğ•Ğ¡Ğ¢ Ğ“Ğ•ĞĞœĞ•Ğ¢Ğ Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ™ ĞĞĞ ĞœĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜**\n\n`;
Â Â Â 
Â Â Â  session.footprints.forEach((footprint, index) => {
Â Â Â Â Â Â Â  const bbox = footprintAssembler.calculateOverallBoundingBox(footprint.predictions);
Â Â Â Â Â Â Â  const aspectRatio = bbox.width / bbox.height;
Â Â Â Â Â Â Â  const area = bbox.width * bbox.height;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  message += `ğŸ“¸ **ĞÑ‚Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ¾Ğº ${index + 1}:**\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ Ğ°Ğ·Ğ¼ĞµÑ€: ${bbox.width.toFixed(0)}x${bbox.height.toFixed(0)}px\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ¡Ğ¾Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ğµ: ${aspectRatio.toFixed(2)}\n`;
Â Â Â Â Â Â Â  message += `â€¢ ĞŸĞ»Ğ¾Ñ‰Ğ°Ğ´ÑŒ: ${area.toFixed(0)}pxÂ²\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ¢Ğ¸Ğ¿: ${footprint.partType || 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾'}\n\n`;
Â Â Â  });
Â Â Â 
Â Â Â  // ĞŸĞ ĞĞ’Ğ•Ğ Ğ¯Ğ•Ğœ Ğ“Ğ•ĞĞœĞ•Ğ¢Ğ Ğ˜Ğ§Ğ•Ğ¡ĞšĞ£Ğ® Ğ¡ĞĞ’ĞœĞ•Ğ¡Ğ¢Ğ˜ĞœĞĞ¡Ğ¢Ğ¬
Â Â Â  if (session.footprints.length >= 2) {
Â Â Â Â Â Â Â  message += `ğŸ” **Ğ“Ğ•ĞĞœĞ•Ğ¢Ğ Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ• Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ•:**\n`;
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  for (let i = 0; i < session.footprints.length; i++) {
Â Â Â Â Â Â Â Â Â Â Â  for (let j = i + 1; j < session.footprints.length; j++) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const score = footprintAssembler.calculateGeometricSimilarity(
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  [session.footprints[i]],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  session.footprints[j]
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  message += `â€¢ #${i+1} vs #${j+1}: ${score.toFixed(2)}\n`;
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }
Â Â Â  }
Â Â Â 
Â Â Â  await bot.sendMessage(chatId, message);
});

// ğŸ”ï¸ ĞšĞĞœĞĞĞ”Ğ: ĞŸĞ•Ğ Ğ•Ğ—ĞĞŸĞ£Ğ¡Ğš ĞŸĞ•Ğ Ğ•Ğ’Ğ•Ğ ĞĞ£Ğ¢ĞĞ™ ĞŸĞ˜Ğ ĞĞœĞ˜Ğ”Ğ«
bot.onText(/\/rebuild_hierarchy/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const session = getSessionManager().trailSessions.get(chatId);
Â Â 
Â Â Â  if (!session || session.footprints.length === 0) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸ Ğ¸Ğ»Ğ¸ ÑĞ»ĞµĞ´Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â 
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  'ğŸ”ï¸ **Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿ĞµÑ€ĞµĞ²ĞµÑ€Ğ½ÑƒÑ‚Ğ¾Ğ¹ Ğ¿Ğ¸Ñ€Ğ°Ğ¼Ğ¸Ğ´Ñ‹...**\n\n' +
Â Â Â Â Â Â Â  'ğŸ“Š ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ñ ÑĞ»ĞµĞ´Ñ‹: ' + session.footprints.length + '\n' +
Â Â Â Â Â Â Â  'â³ Ğ­Ñ‚Ğ¾ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ½ÑÑ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ¸Ğ½ÑƒÑ‚...'
Â Â Â  );
Â Â 
Â Â Â  try {
Â Â Â Â Â Â Â  // ğŸ”§ Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ•Ğœ Ğ—ĞĞ“Ğ›Ğ£Ğ¨ĞšĞ£
Â Â Â Â Â Â Â  const hierarchy = getModelHierarchy(session);
Â Â Â Â Â Â Â  const finalModels = await hierarchy.processHierarchy();
Â Â Â Â Â Â Â  const stats = hierarchy.getStats();
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  let message = 'ğŸ¯ **ĞŸĞ•Ğ Ğ•Ğ’Ğ•Ğ ĞĞ£Ğ¢ĞĞ¯ ĞŸĞ˜Ğ ĞĞœĞ˜Ğ”Ğ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ**\n\n';
Â Â Â Â Â Â Â  message += `ğŸ“Š **Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ:**\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ğ¾ ÑĞ»ĞµĞ´Ğ¾Ğ²: ${stats.levels.raw}\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹: ${stats.levels.final}\n`;
Â Â Â Â Â Â Â  message += `â€¢ ĞĞµĞ¾Ğ¿Ğ¾Ğ·Ğ½Ğ°Ğ½Ğ½Ñ‹Ñ… ÑĞ»ĞµĞ´Ğ¾Ğ²: ${stats.levels.orphans}\n`;
Â Â Â Â Â Â Â  message += `â€¢ ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¾ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹: ${stats.modelsMerged}\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ£ÑÑ‹Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ ÑĞ»ĞµĞ´Ğ¾Ğ²: ${stats.orphansAdopted}\n\n`;
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  message += `ğŸ’¡ **Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ¸**\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ÑĞ±Ğ¾Ñ€ĞºĞ¸\n`;
Â Â Â Â Â Â Â  message += `â€¢ /show_groups - Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ³Ñ€ÑƒĞ¿Ğ¿\n`;
Â Â Â Â Â Â Â  message += `â€¢ /assemble_from_group - Ñ€ÑƒÑ‡Ğ½Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ°`;
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, message);
Â Â Â Â Â Â 
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¸Ñ€Ğ°Ğ¼Ğ¸Ğ´Ñ‹:', error);
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  'âŒ **ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿ĞµÑ€ĞµĞ²ĞµÑ€Ğ½ÑƒÑ‚Ğ¾Ğ¹ Ğ¿Ğ¸Ñ€Ğ°Ğ¼Ğ¸Ğ´Ñ‹**\n\n' +
Â Â Â Â Â Â Â Â Â Â Â  'ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: ' + error.message
Â Â Â Â Â Â Â  );
Â Â Â  }
});

// ğŸ” ĞšĞĞœĞĞĞ”Ğ: Ğ”Ğ•Ğ¢ĞĞ›Ğ˜ ĞŸĞ•Ğ Ğ•Ğ’Ğ•Ğ ĞĞ£Ğ¢ĞĞ™ ĞŸĞ˜Ğ ĞĞœĞ˜Ğ”Ğ«
bot.onText(/\/hierarchy_debug/, async (msg) => {
Â Â Â  const chatId = msg.chat.id;
Â Â Â  const session = getSessionManager().trailSessions.get(chatId);
Â Â 
Â Â Â  if (!session || session.footprints.length === 0) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸ Ğ¸Ğ»Ğ¸ ÑĞ»ĞµĞ´Ğ¾Ğ²');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â 
Â Â Â  try {
Â Â Â Â Â Â Â  // ğŸ”§ Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ•Ğœ Ğ—ĞĞ“Ğ›Ğ£Ğ¨ĞšĞ£
Â Â Â Â Â Â Â  const hierarchy = getModelHierarchy(session);
Â Â Â Â Â Â Â  await hierarchy.processHierarchy();
Â Â Â Â Â Â Â  const stats = hierarchy.getStats();
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  let message = 'ğŸ” **Ğ”Ğ•Ğ¢ĞĞ›Ğ˜ ĞŸĞ•Ğ Ğ•Ğ’Ğ•Ğ ĞĞ£Ğ¢ĞĞ™ ĞŸĞ˜Ğ ĞĞœĞ˜Ğ”Ğ«**\n\n';
Â Â Â Â Â Â Â  message += `ğŸ“Š **Ğ Ğ•Ğ–Ğ˜Ğœ Ğ—ĞĞ“Ğ›Ğ£Ğ¨ĞšĞ˜**\n`;
Â Â Â Â Â Â Â  message += `â€¢ ModelHierarchy Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½\n`;
Â Â Â Â Â Â Â  message += `â€¢ ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: circular dependency\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°\n\n`;
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  message += `ğŸ’¡ **ĞĞ›Ğ¬Ğ¢Ğ•Ğ ĞĞĞ¢Ğ˜Ğ’ĞĞ«Ğ• ĞšĞĞœĞĞĞ”Ğ«:**\n`;
Â Â Â Â Â Â Â  message += `â€¢ /show_groups - Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ ÑĞ»ĞµĞ´Ğ¾Ğ²\n`;
Â Â Â Â Â Â Â  message += `â€¢ /assemble_model - ÑĞ±Ğ¾Ñ€ĞºĞ° Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹\n`;
Â Â Â Â Â Â Â  message += `â€¢ /visualize_results - Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ`;
Â Â Â Â Â Â 
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, message);
Â Â Â Â Â Â 
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹: ' + error.message);
Â Â Â  }
});

// =============================================================================
// ğŸ® Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ Ğ˜ĞĞ¢Ğ•Ğ ĞĞšĞ¢Ğ˜Ğ’ĞĞ«Ğ¥ ĞšĞĞĞŸĞĞš
// =============================================================================

/**
* ğŸ  Ğ£Ğ›Ğ£Ğ§Ğ¨Ğ•ĞĞĞĞ• Ğ“Ğ›ĞĞ’ĞĞĞ• ĞœĞ•ĞĞ®
*/
async function showMainMenu(chatId) {
Â Â Â  const session = getSessionManager().trailSessions.get(chatId);
Â Â Â  const hasActiveSession = session && session.status === 'active';
Â Â Â  const footprintsCount = hasActiveSession ? session.footprints.length : 0;
Â Â Â 
Â Â Â  const menuKeyboard = {
Â Â Â Â Â Â Â  reply_markup: {
Â Â Â Â Â Â Â Â Â Â Â  inline_keyboard: [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ•µï¸â€â™‚ï¸ ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ñ‚Ñ€Ğ¾Ğ¿Ñ‹", callback_data: "start_trail_analysis" },
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ“¸ ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑĞ»ĞµĞ´Ğ°", callback_data: "single_analysis" }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ Ğ¸ ÑÑ‚Ğ°Ğ»Ğ¾Ğ½Ñ‹
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ” Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ÑŒ Ñ ÑÑ‚Ğ°Ğ»Ğ¾Ğ½Ğ¾Ğ¼", callback_data: "compare_reference" },
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ğ»Ğ¾Ğ½", callback_data: "save_reference" }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹", callback_data: "show_stats" },
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "â„¹ï¸ ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ", callback_data: "show_help" }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ ÑĞµÑÑĞ¸Ñ - Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  hasActiveSession ? [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: `ğŸ” ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· (${footprintsCount} ÑĞ»ĞµĞ´Ğ¾Ğ²)`, callback_data: "continue_analysis" }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ] : []
Â Â Â Â Â Â Â Â Â Â Â  ].filter(row => row.length > 0) // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿ÑƒÑÑ‚Ñ‹Ğµ Ñ€ÑĞ´Ñ‹
Â Â Â Â Â Â Â  }
Â Â Â  };
Â Â Â 
Â Â Â  let message = `ğŸ¤– **Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ ĞšĞ Ğ˜ĞœĞ˜ĞĞĞ›Ğ˜Ğ¡Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ™ Ğ­ĞšĞ¡ĞŸĞ•Ğ Ğ¢Ğ˜Ğ—Ğ«**\n\n`;
Â Â Â 
Â Â Â  if (hasActiveSession) {
Â Â Â Â Â Â Â  message += `ğŸŸ¢ **ĞĞšĞ¢Ğ˜Ğ’ĞĞ Ğ¡Ğ•Ğ¡Ğ¡Ğ˜Ğ¯ ĞĞĞĞ›Ğ˜Ğ—Ğ**\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ¡Ğ»ĞµĞ´Ğ¾Ğ²: ${footprintsCount}\n`;
Â Â Â Â Â Â Â  message += `â€¢ ID: ${session.sessionId}\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ­ĞºÑĞ¿ĞµÑ€Ñ‚: ${session.expert}\n\n`;
Â Â Â  } else {
Â Â Â Â Â Â Â  message += `ğŸ“Š **Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹:**\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ­ĞºÑĞ¿ĞµÑ€Ñ‚Ğ¾Ğ²: ${getSessionManager().globalStats.totalUsers}\n`;
message += `â€¢ ĞÑ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¾Ğ²: ${getSessionManager().globalStats.totalPhotos}\n`;
message += `â€¢ ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²: ${getSessionManager().globalStats.totalAnalyses}\n\n`;
}
Â Â Â 
Â Â Â  message += `ğŸ® **Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:**`;
Â Â Â 
Â Â Â  await bot.sendMessage(chatId, message, menuKeyboard);
}

/**
* ğŸ” ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞĞĞ• ĞœĞ•ĞĞ® ĞĞĞĞ›Ğ˜Ğ—Ğ Ğ¢Ğ ĞĞŸĞ«
*/
async function showTrailAnalysisMenu(chatId, session = null) {
Â Â Â  if (!session) {
Â Â Â Â Â Â Â  session = newSessionManager.trailSessions.get(chatId);
Â Â Â  }
Â Â Â 
Â Â Â  const footprintsCount = session ? session.footprints.length : 0;
Â Â Â  const modelsCount = session ? session.assembledModels.length : 0;
Â Â Â  const groupsCount = session ? (session.compatibilityGroups ? session.compatibilityGroups.length : 0) : 0;
Â Â Â  const comparisonsCount = session ? session.comparisons.length : 0;
Â Â Â 
Â Â Â  const trailKeyboard = {
Â Â Â Â Â Â Â  reply_markup: {
Â Â Â Â Â Â Â Â Â Â Â  inline_keyboard: [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ“¸ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ»ĞµĞ´Ñ‹", callback_data: "add_footprints" },
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ”„ ĞĞ²Ñ‚Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·", callback_data: "auto_analyze" }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ],
                // ğŸ¨ Ğ’Ğ˜Ğ—Ğ£ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯
Â Â Â Â Â Â Â Â Â Â Â  [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ¨ Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ", callback_data: "visualization_menu" },
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ“ˆ ĞÑ‚Ñ‡ĞµÑ‚", callback_data: "detailed_report" }
Â Â Â Â Â Â Â Â Â Â Â  ],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: `ğŸ‘¥ Ğ“Ñ€ÑƒĞ¿Ğ¿Ñ‹ (${groupsCount})`, callback_data: "show_groups" },
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: `ğŸ§© Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸`, callback_data: "assemble_models" }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // ĞŸÑ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ”ï¸ Ğ£Ğ¼Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·", callback_data: "rebuild_hierarchy" },
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ“ˆ ĞÑ‚Ñ‡ĞµÑ‚", callback_data: "detailed_report" }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ", callback_data: "save_data" },
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ”™ Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ", callback_data: "main_menu" }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ]
Â Â Â Â Â Â Â Â Â Â Â  ]
Â Â Â Â Â Â Â  }
Â Â Â  };
Â Â Â 
Â Â Â  let message = `ğŸ” **Ğ Ğ•Ğ–Ğ˜Ğœ ĞĞĞĞ›Ğ˜Ğ—Ğ Ğ¢Ğ ĞĞŸĞ«**\n\n`;
Â Â Â 
Â Â Â  if (session) {
Â Â Â Â Â Â Â  message += `ğŸ“Š **Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑÑĞ¸Ğ¸:**\n`;
Â Â Â Â Â Â Â  message += `â€¢ ID: ${session.sessionId}\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ${session.status === 'active' ? 'ğŸŸ¢ ĞĞšĞ¢Ğ˜Ğ’ĞĞ' : 'ğŸ”´ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ'}\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ¡Ğ»ĞµĞ´Ğ¾Ğ²: ${footprintsCount}\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ“Ñ€ÑƒĞ¿Ğ¿: ${groupsCount}\n`;
Â Â Â Â Â Â Â  message += `â€¢ ĞœĞ¾Ğ´ĞµĞ»ĞµĞ¹: ${modelsCount}\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğ¹: ${comparisonsCount}\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ­ĞºÑĞ¿ĞµÑ€Ñ‚: ${session.expert}\n\n`;
Â Â Â  } else {
Â Â Â Â Â Â Â  message += `âŒ **Ğ¡ĞµÑÑĞ¸Ñ Ğ½Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°**\n\n`;
Â Â Â  }
Â Â Â 
Â Â Â  message += `ğŸ® **Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:**`;
Â Â Â 
Â Â Â  await bot.sendMessage(chatId, message, trailKeyboard);
}

/**
* ğŸ‘¥ ĞœĞ•ĞĞ® Ğ“Ğ Ğ£ĞŸĞŸ Ğ¡Ğ›Ğ•Ğ”ĞĞ’
*/
async function showGroupsMenu(chatId, groups, session) {
Â Â Â  const groupButtons = groups.map((group, index) => {
Â Â Â Â Â Â Â  const groupSize = group.length;
Â Â Â Â Â Â Â  const confidence = Math.min((groupSize / 3) * 100, 100);
Â Â Â Â Â Â Â  return [{
Â Â Â Â Â Â Â Â Â Â Â  text: `ğŸ‘¤ Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ° ${index + 1} (${groupSize} ÑĞ»ĞµĞ´Ğ¾Ğ², ${Math.round(confidence)}%)`,
Â Â Â Â Â Â Â Â Â Â Â  callback_data: `show_group_${index}`
Â Â Â Â Â Â Â  }];
Â Â Â  });
Â Â Â 
Â Â Â  const actionButtons = [
Â Â Â Â Â Â Â  [{ text: "ğŸ§© Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸", callback_data: "assemble_all_models" }],
Â Â Â Â Â Â Â  [{ text: "ğŸ”„ ĞŸĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹", callback_data: "recalculate_groups" }],
Â Â Â Â Â Â Â  [{ text: "ğŸ”™ Ğš Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ñƒ", callback_data: "back_to_analysis" }]
Â Â Â  ];
Â Â Â 
Â Â Â  const groupsKeyboard = {
Â Â Â Â Â Â Â  reply_markup: {
Â Â Â Â Â Â Â Â Â Â Â  inline_keyboard: [...groupButtons, ...actionButtons]
Â Â Â Â Â Â Â  }
Â Â Â  };
Â Â Â 
Â Â Â  const totalFootprints = groups.reduce((sum, group) => sum + group.length, 0);
Â Â Â 
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  `ğŸ‘¥ **ĞĞ‘ĞĞĞ Ğ£Ğ–Ğ•ĞĞ Ğ“Ğ Ğ£ĞŸĞŸ: ${groups.length}**\n\n` +
Â Â Â Â Â Â Â  `ğŸ“Š **Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°:**\n` +
Â Â Â Â Â Â Â  `â€¢ Ğ’ÑĞµĞ³Ğ¾ ÑĞ»ĞµĞ´Ğ¾Ğ²: ${totalFootprints}\n` +
Â Â Â Â Â Â Â  `â€¢ Ğ“Ñ€ÑƒĞ¿Ğ¿ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¾: ${groups.length}\n` +
Â Â Â Â Â Â Â  `â€¢ Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°: ${Math.round(totalFootprints / groups.length)} ÑĞ»ĞµĞ´Ğ¾Ğ²\n\n` +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  `ğŸ’¡ **Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ Ğ´Ğ»Ñ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ°:**\n` +
Â Â Â Â Â Â Â  `â€¢ ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ½Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸\n` +
Â Â Â Â Â Â Â  `â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ "Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸" Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹`,
Â Â Â Â Â Â Â  groupsKeyboard
Â Â Â  );
}

// =============================================================================
// ğŸ¯ ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ˜ Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ™ ĞšĞĞĞŸĞĞš
// =============================================================================

/**
* ğŸ¨ ĞœĞ•ĞĞ® Ğ’Ğ˜Ğ—Ğ£ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜
*/
async function showVisualizationMenu(chatId) {
Â Â Â  const session = getSessionManager().trailSessions.get(chatId);
Â Â Â  const modelsCount = session ? session.assembledModels.length : 0;

Â Â Â  const vizKeyboard = {
Â Â Â Â Â Â Â  reply_markup: {
Â Â Â Â Â Â Â Â Â Â Â  inline_keyboard: [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: `ğŸ§© Ğ’ÑĞµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ (${modelsCount})`, callback_data: "visualize_all_models" },
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ” Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸", callback_data: "show_model_details" }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ“Š Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ ÑĞ»ĞµĞ´Ğ¾Ğ²", callback_data: "compare_footprints_viz" },
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ¯ ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ³Ñ€ÑƒĞ¿Ğ¿", callback_data: "analyze_groups_viz" }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  { text: "ğŸ”™ Ğš Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ñƒ", callback_data: "back_to_analysis" }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ]
Â Â Â Â Â Â Â Â Â Â Â  ]
Â Â Â Â Â Â Â  }
Â Â Â  };

Â Â Â  let message = `ğŸ¨ **ĞœĞ•ĞĞ® Ğ’Ğ˜Ğ—Ğ£ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜**\n\n`;

Â Â Â  if (session) {
Â Â Â Â Â Â Â  message += `ğŸ“Š **Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:**\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ¡Ğ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹: ${modelsCount}\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ’ÑĞµĞ³Ğ¾ ÑĞ»ĞµĞ´Ğ¾Ğ²: ${session.footprints.length}\n`;
Â Â Â Â Â Â Â  message += `â€¢ Ğ“Ñ€ÑƒĞ¿Ğ¿: ${session.compatibilityGroups.length}\n\n`;
Â Â Â  }

Â Â Â  message += `ğŸ’¡ **Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚Ğ¸Ğ¿ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:**`;

Â Â Â  await bot.sendMessage(chatId, message, vizKeyboard);
}

/**
* ğŸš€ Ğ—ĞĞŸĞ£Ğ¡Ğš ĞĞĞĞ›Ğ˜Ğ—Ğ Ğ¢Ğ ĞĞŸĞ«
*/
async function startTrailAnalysis(chatId, user) {
Â Â Â   const session = newSessionManager.getTrailSession(chatId, user.username || user.first_name);
Â Â Â 
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  `ğŸ•µï¸â€â™‚ï¸ **ĞĞĞĞ›Ğ˜Ğ— Ğ¢Ğ ĞĞŸĞ« Ğ—ĞĞŸĞ£Ğ©Ğ•Ğ!**\n\n` +
Â Â Â Â Â Â Â  `**Ğ¡ĞµÑÑĞ¸Ñ:** ${session.sessionId}\n` +
Â Â Â Â Â Â Â  `**Ğ­ĞºÑĞ¿ĞµÑ€Ñ‚:** ${session.expert}\n` +
Â Â Â Â Â Â Â  `**Ğ’Ñ€ĞµĞ¼Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°:** ${session.startTime.toLocaleString('ru-RU')}\n\n` +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  `ğŸ“¸ **Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞ¹Ñ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ ÑĞ»ĞµĞ´Ğ¾Ğ² Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°.**\n\n` +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  `ğŸ¯ **Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸:**\n` +
Â Â Â Â Â Â Â  `â€¢ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ ÑĞ»ĞµĞ´Ñ‹ Ğ² ÑĞµÑÑĞ¸Ñ\n` +
Â Â Â Â Â Â Â  `â€¢ Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ Ğ¸Ñ… Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞ¾Ğ±Ğ¾Ğ¹\n` +
Â Â Â Â Â Â Â  `â€¢ ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ»ÑĞ´ĞµĞ¹\n` +
Â Â Â Â Â Â Â  `â€¢ Ğ¡Ğ¾Ğ±ĞµÑ€ĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸\n\n` +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  `ğŸ’¡ **Ğ¡Ğ¾Ğ²ĞµÑ‚:** ĞĞ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ñ 3-5 Ñ‡ĞµÑ‚ĞºĞ¸Ñ… Ñ„Ğ¾Ñ‚Ğ¾ ÑĞ»ĞµĞ´Ğ¾Ğ²!`
Â Â Â  );
Â Â Â 
Â Â Â  await showTrailAnalysisMenu(chatId, session);
}

/**
* ğŸ“¸ ĞĞĞĞ›Ğ˜Ğ— ĞĞ”ĞĞĞ“Ğ Ğ¡Ğ›Ğ•Ğ”Ğ
*/
async function handleSingleAnalysis(chatId) {
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  "ğŸ“¸ **Ğ Ğ•Ğ–Ğ˜Ğœ ĞĞĞĞ›Ğ˜Ğ—Ğ ĞĞ”ĞĞĞ“Ğ Ğ¡Ğ›Ğ•Ğ”Ğ**\n\n" +
Â Â Â Â Â Â Â  "ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ ÑĞ»ĞµĞ´Ğ° Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°.\n\n" +
Â Â Â Â Â Â Â  "ğŸ¯ **Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚:**\n" +
Â Â Â Â Â Â Â  "â€¢ ĞœĞ¾Ñ€Ñ„Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°ĞºĞ¸\n" +
Â Â Â Â Â Â Â  "â€¢ Ğ¢Ğ¸Ğ¿ Ğ¿Ñ€Ğ¾Ñ‚ĞµĞºÑ‚Ğ¾Ñ€Ğ°\n" +
Â Â Â Â Â Â Â  "â€¢ ĞšĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ\n" +
Â Â Â Â Â Â Â  "â€¢ Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑŠĞµĞ¼ĞºĞµ\n\n" +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  "ğŸ’¡ **Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğº Ñ„Ğ¾Ñ‚Ğ¾:**\n" +
Â Â Â Â Â Â Â  "â€¢ Ğ§ĞµÑ‚ĞºĞ¸Ğ¹ ÑĞ»ĞµĞ´ Ğ½Ğ° ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ÑÑ‚Ğ½Ğ¾Ğ¼ Ñ„Ğ¾Ğ½Ğµ\n" +
Â Â Â Â Â Â Â  "â€¢ ĞŸÑ€ÑĞ¼Ğ¾Ğ¹ ÑƒĞ³Ğ¾Ğ» ÑÑŠĞµĞ¼ĞºĞ¸\n" +
Â Â Â Â Â Â Â  "â€¢ Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞµĞµ Ğ¾ÑĞ²ĞµÑ‰ĞµĞ½Ğ¸Ğµ\n" +
Â Â Â Â Â Â Â  "â€¢ ĞšÑ€ÑƒĞ¿Ğ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ğ½\n\n" +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  "ğŸ“¸ **ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ...**"
Â Â Â  );
}

/**
* ğŸ” Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ• Ğ¡ Ğ­Ğ¢ĞĞ›ĞĞĞĞœ
*/
async function handleCompareReference(chatId) {
Â Â Â  if (sessionManager.referencePrints.size === 0) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  'ğŸ“ **Ğ¡ĞŸĞ˜Ğ¡ĞĞš Ğ­Ğ¢ĞĞ›ĞĞĞĞ’ ĞŸĞ£Ğ¡Ğ¢**\n\n' +
Â Â Â Â Â Â Â Â Â Â Â  'Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚Ğµ ÑÑ‚Ğ°Ğ»Ğ¾Ğ½Ñ‹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹:\n' +
Â Â Â Â Â Â Â Â Â Â Â  '`/save_reference ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ_ĞœĞ¾Ğ´ĞµĞ»Ğ¸`\n\n' +
Â Â Â Â Â Â Â Â Â Â Â  'Ğ˜Ğ»Ğ¸ Ñ‡ĞµÑ€ĞµĞ· ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ğ»Ğ¾Ğ½"\n\n' +
Â Â Â Â Â Â Â Â Â Â Â  'ğŸ’¡ **ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:**\n' +
Â Â Â Â Â Â Â Â Â Â Â  '`/save_reference Nike_Air_Max_90`'
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  return;
Â Â Â  }

Â Â Â  // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° ÑÑ‚Ğ°Ğ»Ğ¾Ğ½Ğ°
Â Â Â  const referenceButtons = Array.from(sessionManager.referencePrints.entries()).map(([modelName, ref]) => {
Â Â Â Â Â Â Â  const details = ref.features ? ref.features.detailCount : '?';
Â Â Â Â Â Â Â  return [{
Â Â Â Â Â Â Â Â Â Â Â  text: `ğŸ” ${modelName} (${details} Ğ´ĞµÑ‚.)`,
Â Â Â Â Â Â Â Â Â Â Â  callback_data: `compare_with_${modelName}`
Â Â Â Â Â Â Â  }];
Â Â Â  });

Â Â Â  const keyboard = {
Â Â Â Â Â Â Â  reply_markup: {
Â Â Â Â Â Â Â Â Â Â Â  inline_keyboard: [
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ...referenceButtons,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  [{ text: "ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data: "main_menu" }]
Â Â Â Â Â Â Â Â Â Â Â  ]
Â Â Â Â Â Â Â  }
Â Â Â  };

Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  'ğŸ” **Ğ’Ğ«Ğ‘Ğ•Ğ Ğ˜Ğ¢Ğ• Ğ­Ğ¢ĞĞ›ĞĞ Ğ”Ğ›Ğ¯ Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ¯:**\n\n' +
Â Â Â Â Â Â Â  'ĞŸĞ¾ÑĞ»Ğµ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° ÑÑ‚Ğ°Ğ»Ğ¾Ğ½Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ ÑĞ»ĞµĞ´Ğ° Ğ´Ğ»Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ.',
Â Â Â Â Â Â Â  keyboard
Â Â Â  );
}
/**
* ğŸ’¾ Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ• Ğ­Ğ¢ĞĞ›ĞĞĞ
*/
async function handleSaveReference(chatId) {
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  'ğŸ’¾ **Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ• Ğ­Ğ¢ĞĞ›ĞĞĞĞĞ“Ğ ĞĞ¢ĞŸĞ•Ğ§ĞĞ¢ĞšĞ**\n\n' +
Â Â Â Â Â Â Â  'ğŸ“ **Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»:**\n' +
Â Â Â Â Â Â Â  'ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: `/save_reference Nike_Air_Max_90`\n\n' +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  'ğŸ’¡ **Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ:**\n' +
Â Â Â Â Â Â Â  'â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ»Ğ°Ñ‚Ğ¸Ğ½Ğ¸Ñ†Ñƒ Ğ¸Ğ»Ğ¸ ĞºĞ¸Ñ€Ğ¸Ğ»Ğ»Ğ¸Ñ†Ñƒ\n' +
Â Â Â Â Â Â Â  'â€¢ Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ñ‹ Ğ½Ğ° Ğ¿Ğ¾Ğ´Ñ‡ĞµÑ€ĞºĞ¸Ğ²Ğ°Ğ½Ğ¸Ñ\n' +
Â Â Â Â Â Â Â  'â€¢ Ğ‘ÑƒĞ´ÑŒÑ‚Ğµ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹ Ğ² Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğ¸\n\n' +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  'ğŸ“¸ **ĞŸĞ¾ÑĞ»Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ° Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¿Ğ¾Ğ´Ğ¾ÑˆĞ²Ñ‹:**\n' +
Â Â Â Â Â Â Â  'â€¢ Ğ§Ğ¸ÑÑ‚Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ¾ÑˆĞ²Ğ°, Ğ²Ğ¸Ğ´ ÑĞ²ĞµÑ€Ñ…Ñƒ\n' +
Â Â Â Â Â Â Â  'â€¢ Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞµĞµ Ğ¾ÑĞ²ĞµÑ‰ĞµĞ½Ğ¸Ğµ\n' +
Â Â Â Â Â Â Â  'â€¢ ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ\n\n' +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  'âŒ **Ğ”Ğ»Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹:** /cancel\n\n' +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  'ğŸ“ **Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ ÑĞµĞ¹Ñ‡Ğ°Ñ...**'
Â Â Â  );
}
/**
* ğŸ“Š ĞŸĞĞšĞĞ— Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ˜
*/
async function handleShowStats(chatId) {
Â Â Â  const activeUsers = Array.from(getSessionManager().userStats.values()).filter(user =>
Â Â Â Â Â Â Â  (new Date() - user.lastSeen) < 7 * 24 * 60 * 60 * 1000
Â Â Â  ).length;

Â Â Â  const sessionsCount = Array.from(getSessionManager().trailSessions.values()).filter(s =>
Â Â Â Â Â Â Â  s.status === 'active'
Â Â Â  ).length;

Â Â Â  const stats = `ğŸ“Š **Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ«**\n\n` +
Â Â Â Â Â Â Â Â Â Â Â Â  `ğŸ‘¥ **ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸:**\n` +
Â Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ’ÑĞµĞ³Ğ¾: ${getSessionManager().globalStats.totalUsers}\n` +
Â Â Â Â Â Â Â Â Â Â Â Â  `â€¢ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…: ${activeUsers}\n\n` +
Â Â Â Â Â Â Â Â Â Â Â Â  `ğŸ“¸ **ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ„Ğ¾Ñ‚Ğ¾:**\n` +
Â Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ¤Ğ¾Ñ‚Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾: ${getSessionManager().globalStats.totalPhotos}\n` +
Â Â Â Â Â Â Â Â Â Â Â Â  `â€¢ ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ² Ğ¿Ñ€Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¾: ${getSessionManager().globalStats.totalAnalyses}\n` +
Â Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğ¹ ÑĞ´ĞµĞ»Ğ°Ğ½Ğ¾: ${getSessionManager().globalStats.comparisonsMade}\n\n` +
Â Â Â Â Â Â Â Â Â Â Â Â  `ğŸ•µï¸â€â™‚ï¸ **ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ ÑĞµÑÑĞ¸Ğ¸:**\n` +
Â Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ¡ĞµÑÑĞ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°: ${sessionsCount}\n` +
Â Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ñ… ÑÑ‚Ğ°Ğ»Ğ¾Ğ½Ğ¾Ğ²: ${getSessionManager().referencePrints.size}\n\n` +
Â Â Â Â Â Â Â Â Â Â Â Â  `ğŸ“… **ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·:** ${getSessionManager().globalStats.lastAnalysis ?
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  newSessionManager.globalStats.lastAnalysis.toLocaleString('ru-RU') : 'ĞµÑ‰Ğµ Ğ½ĞµÑ‚'}`;

Â Â Â  await bot.sendMessage(chatId, stats);
}
/**
* â„¹ï¸ ĞŸĞĞšĞĞ— ĞŸĞĞœĞĞ©Ğ˜
*/
async function handleShowHelp(chatId) {
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  `ğŸ†˜ **ĞŸĞĞœĞĞ©Ğ¬ Ğ˜ Ğ˜ĞĞ¤ĞĞ ĞœĞĞ¦Ğ˜Ğ¯ Ğ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ•**\n\n` +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  `ğŸ¯ **ĞĞ¡ĞĞĞ’ĞĞ«Ğ• ĞšĞĞœĞĞĞ”Ğ«:**\n` +
Â Â Â Â Â Â Â  `â€¢ ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ - Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· ÑĞ»ĞµĞ´Ğ°\n` +
Â Â Â Â Â Â Â  `â€¢ /trail_start - Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ñ‚Ñ€Ğ¾Ğ¿Ñ‹\n` +
Â Â Â Â Â Â Â  `â€¢ /save_reference - ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ğ»Ğ¾Ğ½\n` +
Â Â Â Â Â Â Â  `â€¢ /compare - ÑÑ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ÑŒ Ñ ÑÑ‚Ğ°Ğ»Ğ¾Ğ½Ğ¾Ğ¼\n` +
Â Â Â Â Â Â Â  `â€¢ /menu - Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ\n\n` +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  `ğŸ§© **Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ Ğ¡Ğ‘ĞĞ ĞšĞ˜:**\n` +
Â Â Â Â Â Â Â  `â€¢ /assemble_model - ÑĞ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ¸Ğ· Ñ‡Ğ°ÑÑ‚ĞµĞ¹\n` +
Â Â Â Â Â Â Â  `â€¢ /compare_footprints 1 3 - ÑÑ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ÑŒ Ğ´Ğ²Ğ° Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ°\n` +
Â Â Â Â Â Â Â  `â€¢ /show_groups - Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸\n` +
Â Â Â Â Â Â Â  `â€¢ /save_assembled - ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½ÑƒÑ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ\n\n` +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  `ğŸ¨ **Ğ’Ğ˜Ğ—Ğ£ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯:**\n` +
Â Â Â Â Â Â Â  `â€¢ /show_model [Ğ½Ğ¾Ğ¼ĞµÑ€] - Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½ÑƒÑ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ\n` +
Â Â Â Â Â Â Â  `â€¢ /visualize_results - Ğ²ÑĞµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ñ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ°Ğ¼Ğ¸\n` +
Â Â Â Â Â Â Â  `â€¢ /model_details [Ğ½Ğ¾Ğ¼ĞµÑ€] - Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ\n\n` +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  `ğŸ“Š **Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ:**\n` +
Â Â Â Â Â Â Â  `â€¢ /statistics - ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹\n` +
Â Â Â Â Â Â Â  `â€¢ /detailed_stats - Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°\n\n` +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  `ğŸ’¡ **Ğ Ğ•ĞšĞĞœĞ•ĞĞ”ĞĞ¦Ğ˜Ğ˜ ĞŸĞ Ğ¡ĞªĞ•ĞœĞšĞ•:**\n` +
Â Â Â Â Â Â Â  `- Ğ§ĞµÑ‚ĞºĞ¸Ğ¹ ÑĞ»ĞµĞ´ Ğ½Ğ° ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ÑÑ‚Ğ½Ğ¾Ğ¼ Ñ„Ğ¾Ğ½Ğµ\n` +
Â Â Â Â Â Â Â  `- ĞŸÑ€ÑĞ¼Ğ¾Ğ¹ ÑƒĞ³Ğ¾Ğ» ÑÑŠĞµĞ¼ĞºĞ¸\n` +
Â Â Â Â Â Â Â  `- Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞµĞµ Ğ¾ÑĞ²ĞµÑ‰ĞµĞ½Ğ¸Ğµ Ğ±ĞµĞ· Ñ‚ĞµĞ½ĞµĞ¹\n` +
Â Â Â Â Â Â Â  `- ĞšÑ€ÑƒĞ¿Ğ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ğ½, ÑĞ»ĞµĞ´ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ 70% ĞºĞ°Ğ´Ñ€Ğ°\n\n` +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  `âš ï¸ **ĞĞ“Ğ ĞĞĞ˜Ğ§Ğ•ĞĞ˜Ğ¯ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ«:**\n` +
Â Â Â Â Â Â Â  `- Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ñ‡ĞµÑ‚ĞºĞ¾Ğµ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ\n` +
Â Â Â Â Â Â Â  `- Ğ›ÑƒÑ‡ÑˆĞµ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ„Ğ¾Ñ‚Ğ¾ Ğ¿Ğ¾Ğ´ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğ¼Ğ¸ ÑƒĞ³Ğ»Ğ°Ğ¼Ğ¸\n` +
Â Â Â Â Â Â Â  `- ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ»ÑƒÑ‡ÑˆĞµ Ñ 3+ ÑĞ»ĞµĞ´Ğ°Ğ¼Ğ¸`
Â Â Â  );
}
/**
* ğŸ“¸ Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ¡Ğ›Ğ•Ğ”ĞĞ’
*/
async function handleAddFootprints(chatId) {
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  "ğŸ“¸ **Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ¡Ğ›Ğ•Ğ”ĞĞ’ Ğ’ Ğ¡Ğ•Ğ¡Ğ¡Ğ˜Ğ®**\n\n" +
Â Â Â Â Â Â Â  "ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞ¹Ñ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ ÑĞ»ĞµĞ´Ğ¾Ğ² Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°.\n\n" +
Â Â Â Â Â Â Â  "ğŸ¯ **ĞšĞ°Ğ¶Ğ´Ğ¾Ğµ Ñ„Ğ¾Ñ‚Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚:**\n" +
Â Â Â Â Â Â Â  "â€¢ ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ½Ğ° Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸\n" +
Â Â Â Â Â Â Â  "â€¢ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ² Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ ÑĞµÑÑĞ¸Ñ\n" +
Â Â Â Â Â Â Â  "â€¢ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¾ Ñ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¼Ğ¸\n" +
Â Â Â Â Â Â Â  "â€¢ ĞšĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¿Ñ€Ğ¾Ñ‚ĞµĞºÑ‚Ğ¾Ñ€Ğ°\n\n" +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  "ğŸ’¡ **Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸:**\n" +
Â Â Â Â Â Â Â  "â€¢ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞ¹Ñ‚Ğµ Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ Ñ„Ğ¾Ñ‚Ğ¾ Ğ·Ğ° Ñ€Ğ°Ğ·\n" +
Â Â Â Â Â Â Â  "â€¢ Ğ¡Ğ»ĞµĞ´Ğ¸Ñ‚Ğµ Ğ·Ğ° ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾Ğ¼ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ\n" +
Â Â Â Â Â Â Â  "â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ñ‹Ğµ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ ÑÑŠĞµĞ¼ĞºĞ¸\n\n" +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  "ğŸ“¸ **ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞ¹Ñ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ...**\n\n" +
Â Â Â Â Â Â Â  "âŒ **Ğ”Ğ»Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹:** /cancel"
Â Â Â  );
}
/**
* ğŸ’¾ Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ• Ğ”ĞĞĞĞ«Ğ¥
*/
async function handleSaveData(chatId) {
Â Â Â  await bot.sendMessage(chatId, 'ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑ Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ...');
Â Â Â 
Â Â Â  const dataManager = new DataPersistence();
Â Â Â  await dataManager.saveAllData();
Â Â Â 
Â Â Â  const session = getSessionManager().trailSessions.get(chatId);
Â Â Â  const sessionsCount = Array.from(getSessionManager().trailSessions.values()).length;
Â Â Â 
Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â  'âœ… **Ğ’Ğ¡Ğ• Ğ”ĞĞĞĞ«Ğ• Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ«!**\n\n' +
Â Â Â Â Â Â Â  `ğŸ“Š **Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾:**\n` +
Â Â Â Â Â Â Â  `â€¢ Ğ¡ĞµÑÑĞ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°: ${sessionsCount}\n` +
Â Â Â Â Â Â Â  `â€¢ Ğ­Ñ‚Ğ°Ğ»Ğ¾Ğ½Ğ¾Ğ²: ${getSessionManager().referencePrints.size}\n` +
`â€¢ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: ${getSessionManager().userStats.size}\n\n` +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  `ğŸ’¡ **Ğ’ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ²Ñ…Ğ¾Ğ´ÑÑ‚:**\n` +
Â Â Â Â Â Â Â  `â€¢ Ğ’ÑĞµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ ÑĞµÑÑĞ¸Ğ¸\n` +
Â Â Â Â Â Â Â  `â€¢ Ğ­Ñ‚Ğ°Ğ»Ğ¾Ğ½Ğ½Ñ‹Ğµ Ğ¾Ñ‚Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ¸\n` +
Â Â Â Â Â Â Â  `â€¢ Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹\n` +
Â Â Â Â Â Â Â  `â€¢ Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²\n\n` +
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  `ğŸ”„ **Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ±Ğ¾Ñ‚Ğ°**`
Â Â Â  );
Â Â Â 
Â Â Â  await showTrailAnalysisMenu(chatId, session);
}

/**
* ğŸ¤– ĞĞ’Ğ¢ĞĞœĞĞ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ™ ĞĞĞĞ›Ğ˜Ğ—
*/
async function autoAnalyze(chatId) {
Â Â Â  const session = sessionManager.trailSessions.get(chatId);
Â Â Â  if (!session || session.footprints.length === 0) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞµÑ‚ ÑĞ»ĞµĞ´Ğ¾Ğ² Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°. Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾ ÑĞ»ĞµĞ´Ğ¾Ğ².');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  await bot.sendMessage(chatId, 'ğŸ¤– **Ğ—ĞĞŸĞ£Ğ¡Ğš ĞĞ’Ğ¢ĞĞœĞĞ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ“Ğ ĞĞĞĞ›Ğ˜Ğ—Ğ**\n\nâ³ ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ñ ÑĞ»ĞµĞ´Ñ‹...');
Â Â Â 
Â Â Â  // 1. ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
Â Â Â  session.updateCompatibilityGroups();
Â Â Â  await showGroupsMenu(chatId, session.compatibilityGroups, session);
Â Â Â 
Â Â Â  // 2. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ğ¸Ñ€Ğ°Ğ¼Ğ¸Ğ´Ñƒ
Â Â Â  try {
Â Â Â Â Â Â Â  const hierarchy = new ModelHierarchy(session);
Â Â Â Â Â Â Â  await hierarchy.processHierarchy();
Â Â Â Â Â Â Â  const stats = hierarchy.getStats();
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  `ğŸ”ï¸ **ĞŸĞ˜Ğ ĞĞœĞ˜Ğ”Ğ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ**\n\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹: ${stats.levels.final}\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ£Ğ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ: ${stats.levels.final > 0 ? 'Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ' : 'Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸'}\n`
Â Â Â Â Â Â Â  );
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âš ï¸ ĞŸĞ¸Ñ€Ğ°Ğ¼Ğ¸Ğ´Ğ° Ğ½Ğµ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»Ğ°, Ğ½Ğ¾ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ñ‹');
Â Â Â  }
Â Â Â 
Â Â Â  // 3. Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
Â Â Â  await handleAssembleModels(chatId);
}

/**
* ğŸ‘¥ ĞŸĞĞšĞĞ— Ğ“Ğ Ğ£ĞŸĞŸ Ğ¡Ğ›Ğ•Ğ”ĞĞ’
*/
async function handleShowGroups(chatId) {
Â Â Â  const session = sessionManager.trailSessions.get(chatId);
Â Â Â  if (!session) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ñ‚Ñ€Ğ¾Ğ¿Ñ‹');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  session.updateCompatibilityGroups();
Â Â Â 
Â Â Â  if (session.compatibilityGroups.length === 0) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  'âŒ Ğ“Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ½Ğµ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ñ‹.\n\n' +
Â Â Â Â Â Â Â Â Â Â Â  'ğŸ’¡ **Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ ÑĞ»ĞµĞ´Ğ¾Ğ²:**\n' +
Â Â Â Â Â Â Â Â Â Â Â  'â€¢ ĞÑƒĞ¶Ğ½Ğ¾ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2 ÑĞ»ĞµĞ´Ğ°\n' +
Â Â Â Â Â Â Â Â Â Â Â  'â€¢ Ğ§ĞµĞ¼ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ ÑĞ»ĞµĞ´Ğ¾Ğ² - Ñ‚Ğ¾Ñ‡Ğ½ĞµĞµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹\n' +
Â Â Â Â Â Â Â Â Â Â Â  'â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ñ‡ĞµÑ‚ĞºĞ¸Ğµ Ñ„Ğ¾Ñ‚Ğ¾'
Â Â Â Â Â Â Â  );
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  await showGroupsMenu(chatId, session.compatibilityGroups, session);
}
/**
* ğŸ“ˆ Ğ”Ğ•Ğ¢ĞĞ›Ğ¬ĞĞ«Ğ™ ĞĞ¢Ğ§Ğ•Ğ¢
*/
async function handleDetailedReport(chatId) {
Â Â Â  const session = sessionManager.trailSessions.get(chatId);
Â Â Â  if (session && session.footprints.length > 0) {
Â Â Â Â Â Â Â  const report = session.generateEnhancedReport();
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, report);
Â Â Â  } else {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  'âŒ ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°.\n\n' +
Â Â Â Â Â Â Â Â Â Â Â  'ğŸ’¡ **Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ÑĞ»ĞµĞ´Ñ‹ Ğ² ÑĞµÑÑĞ¸Ñ**'
Â Â Â Â Â Â Â  );
Â Â Â  }
}
/**
* ğŸ” Ğ”Ğ•Ğ¢ĞĞ›Ğ˜ ĞšĞĞĞšĞ Ğ•Ğ¢ĞĞĞ™ Ğ“Ğ Ğ£ĞŸĞŸĞ«
*/
async function handleShowGroupDetails(chatId, data) {
Â Â Â  const groupIndex = parseInt(data.split('_')[2]);
Â Â Â  const session = sessionManager.trailSessions.get(chatId);
Â Â Â 
Â Â Â  if (!session || !session.compatibilityGroups[groupIndex]) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  const group = session.compatibilityGroups[groupIndex];
Â Â Â  const analysis = analyzeGroupCharacteristics(group);
Â Â Â 
Â Â Â  let message = `ğŸ‘¤ **Ğ“Ğ Ğ£ĞŸĞŸĞ ${groupIndex + 1}**\n\n`;
Â Â Â  message += `ğŸ“Š **Ğ¥Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ¸ÑÑ‚Ğ¸ĞºĞ¸:**\n`;
Â Â Â  message += `â€¢ Ğ¡Ğ»ĞµĞ´Ğ¾Ğ²: ${group.length}\n`;
Â Â Â  message += `â€¢ Ğ£Ğ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ: ${analysis.confidence}%\n`;
Â Â Â  message += `â€¢ ĞŸÑ€ĞµĞ¾Ğ±Ğ»Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹ Ñ‚Ğ¸Ğ¿: ${analysis.dominantPattern}\n`;
Â Â Â  message += `â€¢ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€: ${analysis.avgSize}\n\n`;
Â Â Â 
Â Â Â  message += `ğŸ“‹ **Ğ¡Ğ»ĞµĞ´Ñ‹ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ:**\n`;
Â Â Â  group.forEach((footprint, index) => {
Â Â Â Â Â Â Â  const footprintNum = footprint.id.replace('footprint_', '#');
Â Â Â Â Â Â Â  const type = footprint.patternType || 'Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾';
Â Â Â Â Â Â Â  message += `${index + 1}. ${footprintNum} (${type})\n`;
Â Â Â  });
Â Â Â 
Â Â Â  message += `\nğŸ’¡ **Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ:**\n`;
Â Â Â  message += `â€¢ Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ: /assemble_from_group ${groupIndex + 1}\n`;
Â Â Â  message += `â€¢ Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ÑŒ ÑĞ»ĞµĞ´Ñ‹: /compare_footprints 1 2\n`;
Â Â Â 
Â Â Â  await bot.sendMessage(chatId, message);
}
/**
* ğŸ§© Ğ¡Ğ‘ĞĞ ĞšĞ ĞœĞĞ”Ğ•Ğ›Ğ•Ğ™
*/
async function handleAssembleModels(chatId) {
Â Â Â  const session = sessionManager.trailSessions.get(chatId);
Â Â Â  if (!session || session.footprints.length < 2) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ÑĞ»ĞµĞ´Ğ¾Ğ² Ğ´Ğ»Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸ (Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2)');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  await bot.sendMessage(chatId, 'ğŸ§© **ĞĞĞ§Ğ˜ĞĞĞ® Ğ¡Ğ‘ĞĞ ĞšĞ£ ĞœĞĞ”Ğ•Ğ›Ğ•Ğ™**\n\nâ³ ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒÑ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ...');
Â Â Â 
Â Â Â  // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°
Â Â Â  let imageWidth = 800, imageHeight = 600;
Â Â Â  try {
Â Â Â Â Â Â Â  const firstFootprint = session.footprints[0];
Â Â Â Â Â Â Â  const image = await loadImage(firstFootprint.imageUrl);
Â Â Â Â Â Â Â  imageWidth = image.width;
Â Â Â Â Â Â Â  imageHeight = image.height;
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  console.log('âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ');
Â Â Â  }
Â Â Â 
Â Â Â  const result = session.assembleModelFromParts(imageWidth, imageHeight);
Â Â Â 
Â Â Â  if (result.success) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  `âœ… **ĞœĞĞ”Ğ•Ğ›Ğ˜ Ğ¡ĞĞ‘Ğ ĞĞĞ«**\n\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¾ ÑĞ»ĞµĞ´Ğ¾Ğ²: ${result.usedPrints.length}\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ ĞŸĞ¾Ğ»Ğ½Ğ¾Ñ‚Ğ° Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸: ${result.completeness}%\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ£Ğ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ: ${result.confidence.toFixed(1)}%`
Â Â Â Â Â Â Â  );
Â Â Â  } else {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, `âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ±Ğ¾Ñ€ĞºĞ¸: ${result.error}`);
Â Â Â  }
Â Â Â 
Â Â Â  // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ² Ğ¼ĞµĞ½Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°
Â Â Â  await showTrailAnalysisMenu(chatId, session);
}

/**
* ğŸ”ï¸ Ğ—ĞĞŸĞ£Ğ¡Ğš ĞŸĞ˜Ğ ĞĞœĞ˜Ğ”Ğ«
*/
async function handleRebuildHierarchy(chatId) {
Â Â Â  const session = sessionManager.trailSessions.get(chatId);
Â Â Â  if (!session) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸ Ğ´Ğ»Ñ Ğ¿Ğ¸Ñ€Ğ°Ğ¼Ğ¸Ğ´Ñ‹');
Â Â Â Â Â Â Â  return;
Â Â Â  }
Â Â Â 
Â Â Â  await bot.sendMessage(chatId, 'ğŸ”ï¸ **Ğ—ĞĞŸĞ£Ğ¡Ğš ĞŸĞ•Ğ Ğ•Ğ’Ğ•Ğ ĞĞ£Ğ¢ĞĞ™ ĞŸĞ˜Ğ ĞĞœĞ˜Ğ”Ğ«**\n\nâ³ ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ñ ÑĞ»ĞµĞ´Ñ‹...');
Â Â Â 
Â Â Â  try {
Â Â Â Â Â Â Â  const hierarchy = new ModelHierarchy(session);
Â Â Â Â Â Â Â  const finalModels = await hierarchy.processHierarchy();
Â Â Â Â Â Â Â  const stats = hierarchy.getStats();
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  `ğŸ¯ **ĞŸĞ˜Ğ ĞĞœĞ˜Ğ”Ğ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ**\n\n` +
Â Â Â Â Â Â Â Â Â Â Â  `ğŸ“Š **Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹:**\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ğ¾ ÑĞ»ĞµĞ´Ğ¾Ğ²: ${stats.levels.raw}\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹: ${stats.levels.final}\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¾ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹: ${stats.modelsMerged}\n` +
Â Â Â Â Â Â Â Â Â Â Â  `â€¢ Ğ£Ğ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ: ${stats.levels.final > 0 ? 'âœ… Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ' : 'âš ï¸ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸'}\n\n` +
Â Â Â Â Â Â Â Â Â Â Â  `ğŸ’¡ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ "Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸" Ğ´Ğ»Ñ Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑĞ±Ğ¾Ñ€ĞºĞ¸.`
Â Â Â Â Â Â Â  );
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  await bot.sendMessage(chatId,
Â Â Â Â Â Â Â Â Â Â Â  `âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¸Ñ€Ğ°Ğ¼Ğ¸Ğ´Ñ‹: ${error.message}\n\n` +
Â Â Â Â Â Â Â Â Â Â Â  `ğŸ’¡ ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ğ±Ñ‹Ñ‡Ğ½ÑƒÑ ÑĞ±Ğ¾Ñ€ĞºÑƒ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹.`
Â Â Â Â Â Â Â  );
Â Â Â  }
Â Â Â 
Â Â Â  await showTrailAnalysisMenu(chatId, session);
}



bot.on('callback_query', async (callbackQuery) => {
Â Â Â  const message = callbackQuery.message;
Â Â Â  const chatId = message.chat.id;
Â Â Â  const data = callbackQuery.data;
Â Â Â  const user = callbackQuery.from;
Â Â Â 
Â Â Â  await bot.answerCallbackQuery(callbackQuery.id);
Â Â Â 
Â Â Â  console.log(`ğŸ”„ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ½Ğ¾Ğ¿ĞºĞ¸: ${data} Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ${user.username || user.first_name}`);
Â Â Â 
Â Â Â  try {
Â Â Â Â Â Â Â  // ğŸ  Ğ“Ğ›ĞĞ’ĞĞĞ• ĞœĞ•ĞĞ® Ğ˜ ĞĞĞ’Ğ˜Ğ“ĞĞ¦Ğ˜Ğ¯
Â Â Â Â Â Â Â  if (data === 'main_menu') {
Â Â Â Â Â Â Â Â Â Â Â  await showMainMenu(chatId);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  else if (data === 'continue_analysis') {
Â Â Â Â Â Â Â Â Â Â Â  await showTrailAnalysisMenu(chatId, getSessionManager().trailSessions.get(chatId));
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ•µï¸â€â™‚ï¸ ĞĞĞĞ›Ğ˜Ğ— Ğ¢Ğ ĞĞŸĞ«
Â Â Â Â Â Â Â  else if (data === 'start_trail_analysis') {
Â Â Â Â Â Â Â Â Â Â Â  await startTrailAnalysis(chatId, user);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  else if (data === 'single_analysis') {
Â Â Â Â Â Â Â Â Â Â Â  await handleSingleAnalysis(chatId);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ” Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ¯ Ğ˜ Ğ­Ğ¢ĞĞ›ĞĞĞ«
Â Â Â Â Â Â Â  else if (data === 'compare_reference') {
Â Â Â Â Â Â Â Â Â Â Â  await handleCompareReference(chatId);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  else if (data === 'save_reference') {
Â Â Â Â Â Â Â Â Â Â Â  await handleSaveReference(chatId);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ“Š Ğ˜ĞĞ¤ĞĞ ĞœĞĞ¦Ğ˜Ğ¯
Â Â Â Â Â Â Â  else if (data === 'show_stats') {
Â Â Â Â Â Â Â Â Â Â Â  await handleShowStats(chatId);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  else if (data === 'show_help') {
Â Â Â Â Â Â Â Â Â Â Â  await handleShowHelp(chatId);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ” ĞœĞ•ĞĞ® ĞĞĞĞ›Ğ˜Ğ—Ğ Ğ¢Ğ ĞĞŸĞ«
Â Â Â Â Â Â Â  else if (data === 'auto_analyze') {
Â Â Â Â Â Â Â Â Â Â Â  await autoAnalyze(chatId);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  else if (data === 'show_groups') {
Â Â Â Â Â Â Â Â Â Â Â  await handleShowGroups(chatId);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  else if (data === 'assemble_models') {
Â Â Â Â Â Â Â Â Â Â Â  await handleAssembleModels(chatId);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  else if (data === 'rebuild_hierarchy') {
Â Â Â Â Â Â Â Â Â Â Â  await handleRebuildHierarchy(chatId);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  else if (data === 'save_data') {
Â Â Â Â Â Â Â Â Â Â Â  await handleSaveData(chatId);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  else if (data === 'detailed_report') {
Â Â Â Â Â Â Â Â Â Â Â  await handleDetailedReport(chatId);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  else if (data === 'add_footprints') {
Â Â Â Â Â Â Â Â Â Â Â  await handleAddFootprints(chatId);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ‘¥ Ğ ĞĞ‘ĞĞ¢Ğ Ğ¡ Ğ“Ğ Ğ£ĞŸĞŸĞĞœĞ˜
Â Â Â Â Â Â Â  else if (data.startsWith('show_group_')) {
Â Â Â Â Â Â Â Â Â Â Â  await handleShowGroupDetails(chatId, data);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  else if (data === 'back_to_analysis') {
Â Â Â Â Â Â Â Â Â Â Â  await showTrailAnalysisMenu(chatId, getSessionManager().trailSessions.get(chatId));
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ¨ Ğ’Ğ˜Ğ—Ğ£ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯
Â Â Â Â Â Â Â  else if (data === 'visualization_menu') {
Â Â Â Â Â Â Â Â Â Â Â  await showVisualizationMenu(chatId);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  else if (data === 'visualize_all_models') {
Â Â Â Â Â Â Â Â Â Â Â  await visualizationHandler.handleVisualizeResults({ chatId });
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  else if (data === 'show_model_details') {
Â Â Â Â Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸: /model_details [Ğ½Ğ¾Ğ¼ĞµÑ€]');
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  else if (data === 'compare_footprints_viz') {
Â Â Â Â Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° ÑĞ»ĞµĞ´Ğ¾Ğ²: /compare_footprints 1 2');
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  else if (data === 'analyze_groups_viz') {
Â Â Â Â Â Â Â Â Â Â Â  await handleShowGroups(chatId);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // ğŸ”§ Ğ”ĞĞ‘ĞĞ’Ğ˜Ğ¢Ğ¬ Ğ¡Ğ®Ğ”Ğ - ĞŸĞĞœĞĞ©Ğ¬ (ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞ!)
Â Â Â Â Â Â Â  else if (data.startsWith('help_')) {
Â Â Â Â Â Â Â Â Â Â Â  const helpType = data.replace('help_', '');
Â Â Â Â Â Â Â Â Â Â Â  const userId = user.id;
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  switch (helpType) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  case 'trail':
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  await helpHandler.showTrailHelp(chatId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  break;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  case 'visualization':
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  await helpHandler.showVisualizationHelp(chatId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  break;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  case 'assembly':
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  await helpHandler.showAssemblyHelp(chatId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  break;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  case 'admin':
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  await helpHandler.showAdminHelp(chatId, userId);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  break;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  case 'close':
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  await bot.deleteMessage(chatId, message.message_id);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  break;
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  else {
Â Â Â Â Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¼ĞµĞ½Ñ.');
Â Â Â Â Â Â Â Â Â Â Â  await showMainMenu(chatId);
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â 
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸:', error);
Â Â Â Â Â Â Â  await bot.sendMessage(chatId, 'âŒ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°');
Â Â Â Â Â Â Â  await showMainMenu(chatId);
Â Â Â  }
});


// =============================================================================
// ğŸš€ Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ«
// ===============================================================
async function loadStats() {
Â Â Â  try {
Â Â Â Â Â Â Â  console.log('ğŸ”„ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Ğ¸Ğ· Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞºĞ°...');
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const apiUrl = `https://cloud-api.yandex.net/v1/disk/public/resources/download?public_key=https://disk.yandex.ru/d/vjXtSXW8otwaNg`;
Â Â Â Â Â Â Â  const linkResponse = await axios.get(apiUrl, { timeout: 10000 });
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  const fileResponse = await axios.get(linkResponse.data.href, {
Â Â Â Â Â Â Â Â Â Â Â  timeout: 10000,
Â Â Â Â Â Â Â Â Â Â Â  responseType: 'text'
Â Â Â Â Â Â Â  });

Â Â Â Â Â Â Â  const remoteStats = JSON.parse(fileResponse.data);
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  if (remoteStats.global) {
Â Â Â Â Â Â Â Â Â Â Â  Object.assign(getSessionManager().globalStats, remoteStats.global);
getSessionManager().userStats.clear();
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  if (remoteStats.users && Array.isArray(remoteStats.users)) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  remoteStats.users.forEach(([userId, userData]) => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  sessionManager.userStats.set(userId, userData);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â  console.log('âœ… Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ°:');
Â Â Â Â Â Â Â Â Â Â Â  console.log(`Â Â  ğŸ‘¥ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: ${ sessionManager.globalStats.totalUsers}`);
Â Â Â Â Â Â Â Â Â Â Â  console.log(`Â Â  ğŸ“¸ Ğ¤Ğ¾Ñ‚Ğ¾: ${ sessionManager.globalStats.totalPhotos}`);
Â Â Â Â Â Â Â  }
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  console.log('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸:', error.message);
Â Â Â Â Â Â Â  console.log('ğŸ’« ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ ÑĞ¾ ÑĞ²ĞµĞ¶ĞµĞ¹ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸');
Â Â Â  }
}

// ĞĞ½Ñ‚Ğ¸-ÑĞ¾Ğ½ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°
setInterval(() => {
Â Â Â  console.log('ğŸ”„ Keep-alive ping:', new Date().toISOString());
}, 4 * 60 * 1000);

async function quickTests() {
Â Â Â  console.log('ğŸ§ª Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… Ñ‚ĞµÑÑ‚Ğ¾Ğ²...');
Â Â Â 
Â Â Â  try {
Â Â Â Â Â Â Â  // Ğ¢ĞµÑÑ‚ 1: Retry Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°
Â Â Â Â Â Â Â  await testRetryLogic();
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // Ğ¢ĞµÑÑ‚ 2: ĞœĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ñ‹
Â Â Â Â Â Â Â  await testManagers();
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  // Ğ¢ĞµÑÑ‚ 3: Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞº
Â Â Â Â Â Â Â  await testYandexDisk();
Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â  console.log('âœ… Ğ’ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹!');
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  console.log('âŒ Ğ¢ĞµÑÑ‚Ñ‹ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹:', error.message);
Â Â Â  }
}

async function testRetryLogic() {
Â Â Â  let attempts = 0;
Â Â Â  await withRetry(async () => {
Â Â Â Â Â Â Â  attempts++;
Â Â Â Â Â Â Â  if (attempts < 2) throw new Error('Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°');
Â Â Â Â Â Â Â  return 'success';
Â Â Â  }, "Ğ¢ĞµÑÑ‚ retry");
Â Â Â  console.log('âœ… Retry Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚');
}

async function testManagers() {
Â Â Â  const manager = getSessionManager();
Â Â Â  const persistence = getDataPersistence();
Â Â Â  console.log('âœ… Lazy loading Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€Ğ¾Ğ² Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚');
}

async function testYandexDisk() {
Â Â Â  if (yandexDisk) {
Â Â Â Â Â Â Â  // ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ
Â Â Â Â Â Â Â  console.log('âœ… Ğ¯Ğ½Ğ´ĞµĞºÑ.Ğ”Ğ¸ÑĞº Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½');
Â Â Â  }
}

// Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²ĞµÑ€Ğ°
app.listen(PORT, async () => {
Â Â Â  console.log(`ğŸŸ¢ HTTP ÑĞµÑ€Ğ²ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ½Ğ° Ğ¿Ğ¾Ñ€Ñ‚Ñƒ ${PORT}`);
Â Â Â 
Â Â Â  try {
Â Â Â Â Â Â Â  await bot.setWebHook(WEBHOOK_URL);
Â Â Â Â Â Â Â  console.log('âœ… Webhook ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½');
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  console.log('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ webhook:', error.message);
Â Â Â  }
Â Â Â  await quickTests();
Â Â Â  await loadStatsFromPublicLink();
await dataPersistence.loadAllData();

console.log(`ğŸ“Š Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°: ${getSessionManager().globalStats.totalUsers} Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹, ${getSessionManager().globalStats.totalPhotos} Ñ„Ğ¾Ñ‚Ğ¾`);
console.log(`ğŸ’¾ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ ÑĞµÑÑĞ¸Ğ¹: ${getSessionManager().trailSessions.size}, ÑÑ‚Ğ°Ğ»Ğ¾Ğ½Ğ¾Ğ²: ${getSessionManager().referencePrints.size}`);
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
process.on('unhandledRejection', (error) => {
Â Â Â  console.error('âš ï¸ Unhandled Promise Rejection:', error);
});

process.on('uncaughtException', (error) => {
Â Â Â  console.error('âš ï¸ Uncaught Exception:', error);
});

// ğŸ”§ Ğ”ĞĞ‘ĞĞ’Ğ›Ğ¯Ğ•Ğœ Ğ’ ĞšĞĞĞ•Ğ¦ Ğ¤ĞĞ™Ğ›Ğ:

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹
process.on('unhandledRejection', (error) => {
Â Â Â  console.error('âš ï¸ Unhandled Promise Rejection:', error);
Â Â Â 
Â Â Â  // ĞĞ²Ñ‚Ğ¾ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…
Â Â Â  if (dataPersistence) {
Â Â Â Â Â Â Â  dataPersistence.saveAllData().catch(e => {
Â Â Â Â Â Â Â Â Â Â Â  console.error('âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ:', e);
Â Â Â Â Â Â Â  });
Â Â Â  }
});

process.on('uncaughtException', (error) => {
Â Â Â  console.error('âš ï¸ Uncaught Exception:', error);
Â Â Â 
Â Â Â  // Ğ­ĞºÑÑ‚Ñ€ĞµĞ½Ğ½Ğ¾Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ
Â Â Â  if (dataPersistence) {
Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â  dataPersistence.saveAllData();
Â Â Â Â Â Â Â  } catch (e) {
Â Â Â Â Â Â Â Â Â Â Â  console.error('âŒ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ:', e);
Â Â Â Â Â Â Â  }
Â Â Â  }
Â Â Â 
Â Â Â  process.exit(1);
});

// ğŸ”§ Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ
async function gracefulShutdown() {
Â Â Â  console.log('ğŸ”„ Ğ“Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ·Ğ½Ğ¾Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹...');
Â Â Â 
Â Â Â  try {
Â Â Â Â Â Â Â  await dataPersistence.saveAllData();
Â Â Â Â Â Â Â  console.log('âœ… Ğ’ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹');
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğ¸:', error);
Â Â Â  }
Â Â Â 
Â Â Â  process.exit(0);
}

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ
process.on('SIGINT', gracefulShutdown);
process.on('SIGTERM', gracefulShutdown);
